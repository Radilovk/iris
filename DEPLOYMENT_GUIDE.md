# Ръководство за Деплойване на Подобренията в Аналитичните Способности

## Проблем

След последните подобрения (3-нивов конституционален анализ, елиминативни канали, IPB анализ, увеличен RAG контекст до 10), при повторен анализ на същите данни не се отчитат очакваните подобрения.

## Причина

Подобренията са имплементирани в кода и в локалните конфигурационни файлове (`kv/iris_config_kv.json`), но **не са деплойнати в Cloudflare KV хранилището**. Worker-ът зарежда конфигурацията от KV при всяка заявка, така че ако KV не е обновен, старата конфигурация все още се използва.

## Решение

### Стъпка 1: Проверка на текущата KV конфигурация

Използвайте скрипта за верификация, за да проверите какво е текущото състояние на KV:

```bash
# Задайте вашия KV namespace ID
export CF_KV_NAMESPACE_ID=your_namespace_id_here

# Проверете текущата конфигурация
./scripts/verify-kv.sh
```

Скриптът ще провери:

- ✅ Дали всички 4 задължителни KV ключа са налични
- ✅ Дали `max_context_entries` е настроен на 10 (вместо старата стойност 6 или 8)
- ✅ Дали `analysis_prompt_template` съдържа новия 3-нивов анализ
- ✅ Дали промптовете съдържат инструкциите за елиминативни канали

### Стъпка 2: Деплойване на обновената конфигурация

Ако верификацията показва проблеми или остарели стойности, деплойвайте новата конфигурация:

```bash
# Деплойвайте всички KV файлове
./scripts/deploy-kv.sh
```

Този скрипт ще качи всички файлове от папка `kv/`:

- `iris_config_kv.json` - Основна конфигурация с промптове и настройки
- `iris_diagnostic_map.json` - Диагностична карта за ириса
- `holistic_interpretation_knowledge.json` - База знания за холистична интерпретация
- `remedy_and_recommendation_base.json` - База с препоръки

### Стъпка 3: Верификация след деплойване

След деплойването проверете отново:

```bash
./scripts/verify-kv.sh
```

Всички проверки трябва да са със статус ✅.

### Стъпка 4: (Опционално) Деплойване на актуализирания Worker

Ако има промени в `worker.js`, деплойвайте го:

```bash
wrangler publish
```

### Стъпка 5: Тестване на подобренията

След деплойването направете нов анализ със същите данни, които сте използвали преди. Очаквайте да видите:

#### В анализа на изображението (JSON отговор от AI):

```json
{
  "constitutional_analysis": {
    "level_1_constitution_color": "Лимфатична конституция с чист син цвят...",
    "level_2_disposition_structure": "Гъвкаво-адаптивен тип (Linen) с вълнообразни влакна...",
    "level_3_diathesis_overlays": "Хидрогеноидна диатеза (Лимфна броеница) с...",
    "pupil_characteristics": "Кръгла форма, IPB: S-знак при 358°...",
    "anv_collarette_analysis": "Леко свит АНВ, назъбена форма..."
  },
  "eliminative_channels_assessment": {
    "intestines": "Умерена слабост - балонизация на АНВ в сектор...",
    "kidneys": "Добро състояние - няма видими знаци...",
    "lymphatic": "Слабост - наличие на лимфна броеница...",
    "lungs": "Добро състояние...",
    "skin": "Умерена слабост - Scurf Rim с дебелина..."
  },
  "identified_signs": [
    {
      "sign_name": "Asparagus Lacuna (Аспержова лакуна)",
      "sign_category": "Топостабилна",
      "color_stage": "Тъмносив-кафяв → Хроничен стадий",
      "location": "Зона 3, сектор 358°, проекция на Преден дял хипофиза",
      ...
    }
  ]
}
```

#### В крайния доклад:

Новите секции:

- **"Конституционален анализ (3-нивов)"** - вместо старата секция, сега с 3 нива
- **"Приоритетни елиминативни канали"** - НОВА секция с оценка на 5-те канала
- По-детайлни описания на лакуните с класификация (Тополабилна/Топостабилна)
- Цветова интерпретация по стадий (Остър/Подостър/Хроничен/Дегенеративен)
- IPB анализ в описанието на зеницата

## Алтернативен метод (Ръчно качване)

Ако не желаете да използвате скриптовете, можете да качите файловете ръчно:

```bash
# Задайте вашия namespace ID
export NAMESPACE_ID=your_namespace_id_here

# Качете всеки файл
wrangler kv:key put --namespace-id=$NAMESPACE_ID iris_config_kv --path=kv/iris_config_kv.json
wrangler kv:key put --namespace-id=$NAMESPACE_ID iris_diagnostic_map --path=kv/iris_diagnostic_map.json
wrangler kv:key put --namespace-id=$NAMESPACE_ID holistic_interpretation_knowledge --path=kv/holistic_interpretation_knowledge.json
wrangler kv:key put --namespace-id=$NAMESPACE_ID remedy_and_recommendation_base --path=kv/remedy_and_recommendation_base.json
```

## Проверка на конкретни стойности

Ако искате да видите точната стойност в KV:

```bash
# Вижте цялата конфигурация
wrangler kv:key get --namespace-id=$NAMESPACE_ID iris_config_kv

# Проверете само max_context_entries
wrangler kv:key get --namespace-id=$NAMESPACE_ID iris_config_kv | grep -A 1 max_context_entries

# Проверете дали 3-нивовият анализ е налице
wrangler kv:key get --namespace-id=$NAMESPACE_ID iris_config_kv | grep -c "3-НИВОВ"
```

## Очаквани подобрения след деплойването

| Аспект                  | Преди            | След              | Промяна |
| ----------------------- | ---------------- | ----------------- | ------- |
| RAG контекст            | 6 записа         | 10 записа         | +67%    |
| Конституционален анализ | 1 ниво           | 3 нива            | +200%   |
| Елиминативни канали     | Не се споменават | Приоритет #1      | НОВО    |
| Типове лакуни           | 6                | 10+               | +67%    |
| IPB анализ              | Основен          | Напреднал         | НОВО    |
| Цветова интерпретация   | Основна          | 4-етапен модел    | НОВО    |
| Тополабилни знаци       | Не се различават | Ясно разграничени | НОВО    |

## Често срещани проблеми

### Проблем 1: wrangler не е намерен

**Решение:**

```bash
npm install -g wrangler
# или
npx wrangler --version
```

### Проблем 2: Липсва CF_KV_NAMESPACE_ID

**Решение:**
Намерете вашия namespace ID:

```bash
wrangler kv:namespace list
```

След това задайте environment variable:

```bash
export CF_KV_NAMESPACE_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

Или добавете го в `wrangler.toml`:

```toml
[[kv_namespaces]]
binding = "iris_rag_kv"
id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

### Проблем 3: Permission denied при изпълнение на скриптове

**Решение:**

```bash
chmod +x scripts/deploy-kv.sh scripts/verify-kv.sh
```

### Проблем 4: Скриптът се проваля по време на деплойване

**Ситуация:** Скриптът се проваля след като е качил част от файловете.

**Решение:**

1. Проверете кои файлове са качени успешно:
   ```bash
   wrangler kv:key list --namespace-id=$CF_KV_NAMESPACE_ID
   ```
2. Ако някои файлове липсват, качете ги ръчно:
   ```bash
   wrangler kv:key put --namespace-id=$CF_KV_NAMESPACE_ID missing_key --path=kv/missing_file.json
   ```
3. Проверете детайлната грешка която скриптът е показал
4. След поправяне на проблема, пуснете скрипта отново - той ще презапише файловете

**Забележка:** Скриптът използва `set -e`, което означава че ще спре при първа грешка. Това е добра практика за сигурност, но означава че може да има частично качени файлове.

### Проблем 5: Подобренията все още не се виждат след деплойване

**Възможни причини:**

1. **Кеширане в браузъра** - Изчистете cache или използвайте Incognito mode
2. **Worker кеш** - Cloudflare Workers кешират отговорите. Изчакайте 1-2 минути
3. **Грешен namespace** - Уверете се че използвате правилния namespace ID
4. **Старата версия на worker-а** - Деплойвайте отново с `wrangler publish`

**Проверка:**

```bash
# Проверете кой worker е деплойнат
wrangler deployments list

# Вижте логовете в реално време
wrangler tail
```

## Заключение

Подобренията в аналитичните способности **са имплементирани и готови**, но изискват деплойване на обновената KV конфигурация. След следване на стъпките в това ръководство, всички нови функции ще бъдат активни и видими в анализите.

**Важно:** При всяка бъдеща промяна в `kv/iris_config_kv.json` или другите KV файлове, винаги изпълнявайте `./scripts/deploy-kv.sh` за да приложите промените!
