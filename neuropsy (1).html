<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ù–µ–≤—Ä–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª ‚Äî –Ω–µ–ª–∏–Ω–µ–π–Ω–∏ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏ + —Ç–µ—Å—Ç + JSON</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#11182a;
      --muted:#9aa8c7;
      --text:#e7ecff;
      --line:rgba(255,255,255,.10);
      --accent:#7c5cff;
      --accent2:#2ad4ff;
      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 10% 0%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(42,212,255,.14), transparent 55%),
                  linear-gradient(180deg, #070a12, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,24,42,.90), rgba(15,23,41,.72));
      border-radius: var(--radius2); box-shadow: var(--shadow);
    }
    h1{margin:0;font-size:17px;letter-spacing:.2px;line-height:1.2}
    .sub{margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.45;max-width:860px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end}
    .btn{
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      color:var(--text); padding:9px 12px;border-radius:14px; cursor:pointer;
      font-weight:700;font-size:12.5px; display:inline-flex; align-items:center; gap:8px;
      user-select:none; transition:.15s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(124,92,255,.35)}
    .btn:active{transform:translateY(0)}
    .pill{
      padding:6px 9px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.03); font-size:12px; color:var(--muted);
      display:inline-flex; align-items:center; gap:8px;
    }
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      padding:8px 10px; border-radius:14px; cursor:pointer; user-select:none;
    }
    .toggle input{accent-color:var(--accent)}
    select{
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      color:var(--text); padding:8px 10px; border-radius:14px; outline:none;
      font-weight:700; font-size:12.5px;
    }

    /* Accordion */
    .acc{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(17,24,42,.80), rgba(15,23,41,.60));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .acc summary{
      list-style:none;
      cursor:pointer;
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    .acc summary::-webkit-details-marker{display:none}
    .acc .sumLeft{display:flex;flex-direction:column;gap:4px;min-width:0}
    .acc .sumLeft .t{font-weight:850;font-size:13px;letter-spacing:.2px}
    .acc .sumLeft .d{color:var(--muted);font-size:12px;line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .acc .sumRight{display:flex;align-items:center;gap:8px;flex:0 0 auto}
    .chev{
      width:28px;height:28px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      display:grid;place-items:center;font-weight:900;
      transform:rotate(0deg); transition:.18s ease;
    }
    details[open] .chev{transform:rotate(90deg)}
    .acc .bd{padding:14px 14px 16px}

    .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.26);
      border-radius: 16px;
      padding:12px;
    }
    .note{margin-top:10px;color:var(--muted);font-size:11.5px;line-height:1.45}
    .bullets{margin:10px 0 0;padding-left:18px;color:rgba(231,236,255,.90);font-size:12.6px;line-height:1.55}

    /* Cards (sliders) */
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{
      border:1px solid var(--line);
      background: rgba(7,10,18,.35);
      border-radius: var(--radius);
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:""; position:absolute; inset:-1px -1px auto -1px; height:3px;
      background: linear-gradient(90deg, rgba(124,92,255,.0), rgba(124,92,255,.9), rgba(42,212,255,.9), rgba(42,212,255,.0));
      opacity:.65;
    }
    .cardTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
    .name{display:flex;flex-direction:column;gap:4px;min-width:0}
    .name .main{font-weight:850;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .name .sub{color:var(--muted);font-size:11.6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row{display:flex;align-items:center;gap:10px}
    input[type="range"]{
      width:100%;height:6px;border-radius:999px;outline:none;appearance:none;
      background: linear-gradient(90deg, rgba(124,92,255,.85), rgba(42,212,255,.85));
      opacity:.95;
    }
    input[type="range"]::-webkit-slider-thumb{
      appearance:none;width:18px;height:18px;border-radius:999px;
      background:#f3f6ff;border:2px solid rgba(124,92,255,.55);
      box-shadow:0 6px 16px rgba(0,0,0,.35);cursor:pointer;
    }
    input[type="number"]{
      width:74px;padding:7px 8px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.03);color:var(--text);font-family:var(--mono);
      font-size:12px;outline:none;
    }
    .mini{margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);font-size:11.5px}
    .tag{
      padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.02);color:rgba(231,236,255,.88);font-size:11px;white-space:nowrap;
    }
    .tag.good{border-color:rgba(46,229,157,.35); background:rgba(46,229,157,.08)}
    .tag.warn{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.08)}
    .tag.bad {border-color:rgba(255,92,122,.35); background:rgba(255,92,122,.08)}
    .infoBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:rgba(231,236,255,.92);
      width:30px;height:30px;border-radius:12px;
      cursor:pointer;display:grid;place-items:center;font-weight:900;
      transition:.15s ease;flex:0 0 auto;
    }
    .infoBtn:hover{border-color:rgba(42,212,255,.40); transform:translateY(-1px)}

    /* Results layout */
    .resultsGrid{display:grid;grid-template-columns: 1.1fr .9fr;gap:12px;align-items:start}
    canvas{width:100%;height:320px;display:block}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.22);
      border-radius: 16px;
      padding:10px;
    }
    .kpi .k{color:var(--muted);font-size:11.5px}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:950;letter-spacing:.2px}
    .kpi .x{margin-top:6px;font-size:11.5px;color:rgba(231,236,255,.85);line-height:1.35}
    .model h3{margin:0 0 8px;font-size:13px;font-weight:900;letter-spacing:.2px}
    .model p{margin:0;color:rgba(231,236,255,.90);font-size:12.8px;line-height:1.55}

    /* Test */
    .testGrid{display:flex;flex-direction:column;gap:10px}
    .q{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.26);
      border-radius: 16px;
      padding:12px;
    }
    .qTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .qTitle{font-weight:900;font-size:12.8px;letter-spacing:.2px;line-height:1.35}
    .qHint{color:var(--muted);font-size:11.4px;line-height:1.35;margin-top:6px}
    .qMeta{display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:150px}
    .chip{
      padding:5px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-size:11px;color:rgba(231,236,255,.88);white-space:nowrap;font-family:var(--mono);
    }
    .likert{display:grid;grid-template-columns: repeat(5, minmax(0,1fr));gap:8px;margin-top:10px}
    .opt{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:9px 8px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-size:11.7px;
      color:rgba(231,236,255,.90);
      transition:.14s ease;
    }
    .opt:hover{transform:translateY(-1px); border-color:rgba(124,92,255,.35)}
    .opt input{display:none;}
    .opt[data-on="1"]{
      border-color:rgba(42,212,255,.45);
      background: rgba(42,212,255,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .testActions{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.14);
    }
    .testStat{color:var(--muted);font-size:11.5px;line-height:1.35}

    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.22);
      border-radius: 16px;
      padding:10px;
    }
    .field label{
      display:flex;flex-direction:column;gap:6px;
      font-size:12.2px;font-weight:850;
    }
    .field small{color:var(--muted);font-size:11.4px;line-height:1.35}
    .field input, .field select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:9px 10px;
      color:var(--text);
      outline:none;
      font-family: var(--mono);
      font-size:12px;
      font-weight:800;
    }
    .field select{font-family: var(--sans);}

    /* Share */
    .shareGrid{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    textarea{
      width:100%;min-height:280px;resize:vertical;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.22);
      border-radius: 16px;
      padding:10px;
      color:rgba(231,236,255,.92);
      font-family: var(--mono);
      font-size:11.6px;
      line-height:1.45;
      outline:none;
    }
    .fileRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type="file"]{display:none}
    .fileLabel{
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      padding:9px 12px;border-radius:14px; cursor:pointer;
      font-weight:700;font-size:12.5px; display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .fileLabel:hover{border-color:rgba(42,212,255,.35)}

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(17,24,42,.96), rgba(11,15,25,.93));
      border-radius: 22px; box-shadow: 0 22px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHd{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHd .t{display:flex;flex-direction:column;gap:4px;min-width:0}
    .modalHd .t strong{font-size:14px;letter-spacing:.2px;line-height:1.2}
    .modalHd .t span{color:var(--muted);font-size:12px;line-height:1.35}
    .closeBtn{
      border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.03);
      color:var(--text); width:34px;height:34px;border-radius:14px; cursor:pointer; font-weight:900;
    }
    .modalBd{padding:14px 16px 16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .box h4{margin:0 0 8px;font-size:12.5px;letter-spacing:.2px}
    .box ul{margin:0;padding-left:16px;color:rgba(231,236,255,.90);font-size:12.4px;line-height:1.5}
    .box p{margin:0;color:rgba(231,236,255,.90);font-size:12.4px;line-height:1.5}

    @media (max-width: 980px){
      .cards{grid-template-columns:1fr}
      .resultsGrid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr 1fr}
      .shareGrid{grid-template-columns:1fr}
      .formRow{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .kpis{grid-template-columns:1fr}
      .likert{grid-template-columns:1fr}
      .qMeta{min-width:auto;align-items:flex-start}
      header{flex-direction:column}
      .controls{justify-content:flex-start}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>–ù–µ–≤—Ä–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª ‚Äî —Ç–µ—Å—Ç + –ø–ª—ä–∑–≥–∞—á–∏ + –Ω–µ–ª–∏–Ω–µ–π–Ω–∏ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏ + JSON</h1>
      <p class="sub">
        –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞ <b>—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</b> —á—Ä–µ–∑ –Ω–µ–≤—Ä–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–∏ –æ—Å–∏ (–∫–æ–Ω—Ç—Ä–æ–ª, –∞–ª–∞—Ä–º–∞, —Å—Ç—Ä–µ—Å, –∑–∞—â–∏—Ç–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç).
        –°–∫–∞–ª–∞ 0‚Äì100 = –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª–Ω–∞ ‚Äû—Å–∏–ª–∞/—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç‚Äú. <b>–ù–µ</b> –µ –¥–∏–∞–≥–Ω–æ–∑–∞ –∏ <b>–Ω–µ</b> –∏–∑–º–µ—Ä–≤–∞ –º–æ–∑—ä—á–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç.
      </p>
    </div>
    <div class="controls">
      <label class="toggle" title="–ö–æ–≥–∞—Ç–æ –µ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø—Ä–æ–º—è–Ω–∞—Ç–∞ –Ω–∞ –µ–¥–∏–Ω —Ü–µ–Ω—Ç—ä—Ä –ø—Ä–æ–º–µ–Ω—è —Å–≤—ä—Ä–∑–∞–Ω–∏—Ç–µ –ø–æ –Ω–µ–ª–∏–Ω–µ–π–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞.">
        <input id="coupleToggle" type="checkbox" checked />
        <span style="font-weight:800;font-size:12.5px;">–ö–æ—Ä–µ–ª–∞—Ü–∏–∏</span>
      </label>
      <select id="couplingStrength" title="–ö–æ–ª–∫–æ —Å–∏–ª–Ω–æ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ –¥–∞ –≤–ª–∏—è—è—Ç.">
        <option value="low">–°–ª–∞–±–∏</option>
        <option value="mid" selected>–°—Ä–µ–¥–Ω–∏</option>
        <option value="high">–°–∏–ª–Ω–∏</option>
      </select>
      <button class="btn" id="btnResetYou" title="–í—Ä—ä—â–∞ —Å—Ç–∞—Ä—Ç–æ–≤ –ø—Ä–æ—Ñ–∏–ª.">‚Ü∫ –ü—Ä–æ—Ñ–∏–ª: –¢–∏</button>
      <button class="btn" id="btnResetNeutral" title="–í—Ä—ä—â–∞ –Ω–µ—É—Ç—Ä–∞–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª.">‚Ü∫ –ù–µ—É—Ç—Ä–∞–ª–µ–Ω</button>
      <button class="btn" id="btnDownloadJson" title="–ò–∑—Ç–µ–≥–ª—è JSON (–º–∞—à–∏–Ω–µ–Ω —Ñ–æ—Ä–º–∞—Ç) —Å —Ç–µ–∫—É—â–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.">‚¨á JSON</button>
      <span class="pill" title="–ü–§–ö ‚àí –ª–∏–º–±–∏—á–Ω–∞ —Ä–∞–∑–ª–∏–∫–∞ (–ø–æ–ª–æ–∂–∏—Ç–µ–ª–Ω–æ = –ø–æ–≤–µ—á–µ –∫–æ–Ω—Ç—Ä–æ–ª).">
        <span>–ë–∞–ª–∞–Ω—Å</span> <b id="pillValue" style="color:rgba(231,236,255,.95)">‚Äî</b>
      </span>
    </div>
  </header>

  <details class="acc" open>
    <summary>
      <div class="sumLeft">
        <div class="t">–ü—Ä–µ–¥—Å—Ç–∞–≤—è–Ω–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞ –ø—Å–∏—Ö–æ–ª–æ–≥ (–∫—Ä–∞—Ç–∫–æ –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–∞–ª–Ω–æ)</div>
        <div class="d">–¶–µ–ª, —Ä–∞–º–∫–∞, –∫–∞–∫–≤–æ –µ –¥–æ–ø—É—Å—Ç–∏–º –∏–∑–≤–æ–¥, –∫–∞–∫–≤–æ –Ω–µ –µ.</div>
      </div>
      <div class="sumRight"><span class="pill">–ü—Å–∏—Ö–æ–ª–æ–≥</span><span class="chev">‚Ä∫</span></div>
    </summary>
    <div class="bd">
      <div class="box">
        <p style="margin:0;color:rgba(231,236,255,.92);font-size:12.9px;line-height:1.6">
          <b>–ò–¥–µ—è:</b> –¥–∞ —Å–µ –ø—Ä–µ–≤–µ–¥–µ —Å—É–±–µ–∫—Ç–∏–≤–Ω–æ—Ç–æ ‚Äû–∫–∞–∫ —Ä–µ–∞–≥–∏—Ä–∞ —á–æ–≤–µ–∫‚Äú –≤ <b>—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</b> –æ—Ç –æ—Å–∏, –∫–æ–∏—Ç–æ –æ–ø–∏—Å–≤–∞—Ç
          (1) –∏–∑–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª (–ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª–Ω–∏ –∑–æ–Ω–∏), (2) –∞–ª–∞—Ä–º–∞/—Å—Ç—Ä–µ—Å/–∑–∞—â–∏—Ç–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ (–ª–∏–º–±–∏—á–Ω–∏/—Å—Ç–≤–æ–ª–æ–≤–∏ –ø—ä—Ç–∏—â–∞),
          (3) –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–ø–∞–º–µ—Ç/—Å–º–∏—Å—ä–ª). –†–µ–∑—É–ª—Ç–∞—Ç—ä—Ç –ø–æ–º–∞–≥–∞ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ –≤—ä–≤ –≤—Ä–µ–º–µ—Ç–æ.
        </p>

        <ul class="bullets">
          <li><b>–ö–∞–∫ —Å–µ –ø–æ–ø—ä–ª–≤–∞:</b> —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 30‚Äì90 –¥–Ω–∏ + –ø–æ –∂–µ–ª–∞–Ω–∏–µ –∫–∞–ª–∏–±—Ä–∞—Ü–∏—è –æ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥ —á—Ä–µ–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ/–∞–Ω–∞–º–Ω–µ–∑–∞.</li>
          <li><b>–ö–∞–∫–≤–æ –µ ‚Äû–∫–æ—Ä–µ–ª–∞—Ü–∏—è‚Äú —Ç—É–∫:</b> –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –≤–∑–∞–∏–º–Ω–æ –≤–ª–∏—è–Ω–∏–µ –º–µ–∂–¥—É –æ—Å–∏ (–Ω–∞—Å–∏—â–∞—â–∏ —Å–µ –∏ –∑–∞–≤–∏—Å–∏–º–∏ –æ—Ç —Ç–µ–∫—É—â–æ—Ç–æ –Ω–∏–≤–æ).</li>
          <li><b>–í—ä–∑—Ä–∞—Å—Ç/–ø–æ–ª:</b> –≤–∫–ª—é—á–µ–Ω–∏ –∫–∞—Ç–æ <b>–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏</b> –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∏ –Ω–∞ —á–∞—Å—Ç –æ—Ç –≤—Ä—ä–∑–∫–∏—Ç–µ (–≥–ª–∞–≤–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª‚Üî–∞–ª–∞—Ä–º–∞). –ï—Ñ–µ–∫—Ç—ä—Ç –µ —É–º–∏—à–ª–µ–Ω–æ –º–∞–ª—ä–∫.</li>
          <li><b>–ö–∞–∫–≤–æ –ù–ï –µ:</b> –Ω–µ –µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –Ω–µ –µ –ø—Å–∏—Ö–æ–º–µ—Ç—Ä–∏—á–µ–Ω —Ç–µ—Å—Ç, –Ω–µ –¥–∞–≤–∞ IQ, –Ω–µ –¥–æ–∫–∞–∑–≤–∞ ‚Äû—Ü–µ–Ω—Ç—Ä–æ–≤–µ‚Äú.</li>
          <li><b>–ö–∞–∫–≤–∏ –∏–∑–≤–æ–¥–∏ —Å–∞ –ø—Ä–∏–µ–º–ª–∏–≤–∏:</b> —Å–∞–º–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∏, –∫–æ–≥–∞—Ç–æ –∏–º–∞ <b>–ø–æ–≤—Ç–∞—Ä—è–µ–º–æ—Å—Ç</b> –Ω–∞ —Ä–µ–∞–∫—Ü–∏–∏ –∏ —Å—Ç–∞–±–∏–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç.</li>
          <li><b>–ö–∞–∫ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∫–ª–∏–Ω–∏—á–Ω–æ:</b> –ø—Ä–µ–¥–∏/—Å–ª–µ–¥ –∏–Ω—Ç–µ—Ä–≤–µ–Ω—Ü–∏—è (—Å—ä–Ω, —Å—Ç—Ä–µ—Å, –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞ —Ä–∞–±–æ—Ç–∞, —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏ —Ç–µ—Ö–Ω–∏–∫–∏) –¥–∞ —Å–µ —Å—Ä–∞–≤–Ω—è–≤–∞—Ç –ø—Ä–æ—Ñ–∏–ª–∏ (JSON –≤–µ—Ä—Å–∏–∏).</li>
        </ul>

        <p class="note">
          üîí –î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç: —Ä–∞–º–∫–∞—Ç–∞ ‚Äû–∫–æ–Ω—Ç—Ä–æ–ª vs —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç vs –∫–æ–Ω—Ç–µ–∫—Å—Ç‚Äú –µ —Å—Ç–∞–±–∏–ª–Ω–∞. üü° –í—Ä—ä–∑–∫–∏—Ç–µ (–∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ) —Å–∞ –º–æ–¥–µ–ª–Ω–∏.
          –£—Å–ª–æ–≤–∏—è –∑–∞ –ø—Ä–∏–ª–æ–∂–∏–º–æ—Å—Ç: –ø–æ–≤—Ç–∞—Ä—è–µ–º–∏ –º–æ–¥–µ–ª–∏ ‚â• 4‚Äì6 —Å–µ–¥–º–∏—Ü–∏, –Ω–µ –µ–¥–∏–Ω–∏—á–Ω–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∏.
        </p>
      </div>
    </div>
  </details>

  <details class="acc" open id="sec_test">
    <summary>
      <div class="sumLeft">
        <div class="t">–¢–µ—Å—Ç (10 –≤—ä–ø—Ä–æ—Å–∞ ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) + –≤—ä–∑—Ä–∞—Å—Ç/–ø–æ–ª</div>
        <div class="d">–°–∫–∞–ª–∞ A‚ÜíB (1‚Äì5) –±–µ–∑ –æ—Ü–µ–Ω—ä—á–Ω–æ—Å—Ç; —á–∞—Å—Ç –æ—Ç –≤—ä–ø—Ä–æ—Å–∏—Ç–µ —Å–∞ —Å –æ–±—ä—Ä–Ω–∞—Ç–æ –∫–æ–¥–∏—Ä–∞–Ω–µ.</div>
      </div>
      <div class="sumRight">
        <span class="pill">–ü–æ–ø—ä–ª–Ω–µ–Ω–∏: <b id="answeredCount" style="color:rgba(231,236,255,.95)">0</b>/10</span>
        <span class="chev">‚Ä∫</span>
      </div>
    </summary>
    <div class="bd">
      <div class="box">
        <div style="font-weight:950;letter-spacing:.2px">–ö–æ–Ω—Ç–µ–∫—Å—Ç (–ø–æ–ª–∑–≤–∞ —Å–µ –≤ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ)</div>
        <div class="formRow">
          <div class="field">
            <label>–í—ä–∑—Ä–∞—Å—Ç (–≥–æ–¥–∏–Ω–∏)
              <input id="ageYears" type="number" min="6" max="110" step="1" value="30" />
              <small>üîí –ù–∞–π-—Å–∏–ª–µ–Ω –µ—Ñ–µ–∫—Ç –ø–æ–¥ ~25 –≥. (–∑—Ä—è–ª–æ—Å—Ç –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª/—Ä–µ–≥—É–ª–∞—Ü–∏—è).</small>
            </label>
          </div>
          <div class="field">
            <label>–ë–∏–æ–ª–æ–≥–∏—á–µ–Ω –ø–æ–ª
              <select id="sexBio">
                <option value="unspecified">–Ω–µ–ø–æ—Å–æ—á–µ–Ω–æ</option>
                <option value="male">–º—ä–∂</option>
                <option value="female">–∂–µ–Ω–∞</option>
              </select>
              <small>üü° –í –º–æ–¥–µ–ª–∞: –º–∞–∫—Å–∏–º—É–º ~¬±3‚Äì5% –≤—ä—Ä—Ö—É –Ω—è–∫–æ–ª–∫–æ –≤—Ä—ä–∑–∫–∏ (–∫–æ–Ω—Ç—Ä–æ–ª‚Üî–∑–∞—â–∏—Ç–∞). –ù–µ –¥–æ–º–∏–Ω–∏—Ä–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞.</small>
            </label>
          </div>
        </div>
        <p class="note" id="demoEffectText">‚Äî</p>
      </div>

      <div class="testGrid" id="testGrid"></div>

      <div class="testActions">
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
          <button class="btn" id="btnApplyTest">‚úì –ü—Ä–∏–ª–æ–∂–∏ —Ç–µ—Å—Ç–∞ –∫—ä–º –ø—Ä–æ—Ñ–∏–ª–∞</button>
          <button class="btn" id="btnClearTest">‚úï –ò–∑—á–∏—Å—Ç–∏ —Ç–µ—Å—Ç–∞</button>
        </div>
        <div class="testStat">
          –ù–∞–¥–µ–∂–¥–Ω–æ—Å—Ç: <b id="testReliability">–Ω–∏—Å–∫–∞</b> ¬∑ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: <b>30‚Äì90 –¥–Ω–∏</b>.
        </div>
      </div>

      <p class="note">
        –ú–∞–ø–∏—Ä–∞–Ω–µ 1‚Äì5 ‚Üí 0‚Äì100: 1‚Üí20, 2‚Üí40, 3‚Üí60, 4‚Üí80, 5‚Üí95. <b>–û–±—ä—Ä–Ω–∞—Ç–æ –∫–æ–¥–∏—Ä–∞–Ω–µ</b> –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ –ø—Ä–∏ —á–∞—Å—Ç –æ—Ç –≤—ä–ø—Ä–æ—Å–∏—Ç–µ
        –º–∞—â–∞–±—ä—Ç —Å–µ –æ–±—Ä—ä—â–∞ –≤—ä—Ç—Ä–µ—à–Ω–æ (–∑–∞ –¥–∞ —Å–µ –Ω–∞–º–∞–ª–∏ ‚Äû–Ω–∞—Ç–∏—Å–∫–∞–π 5 –Ω–∞–≤—Å—è–∫—ä–¥–µ‚Äú).
      </p>
    </div>
  </details>

  <details class="acc" open id="sec_results">
    <summary>
      <div class="sumLeft">
        <div class="t">–†–µ–∑—É–ª—Ç–∞—Ç (—Ä–∞–¥–∞—Ä + –∏–Ω–¥–µ–∫—Å–∏ + —Å–∏–Ω—Ç–µ–∑)</div>
        <div class="d">–ü—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª–Ω–∞ –¥–æ–º–∏–Ω–∞—Ü–∏—è, –ª–∏–º–±–∏—á–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è.</div>
      </div>
      <div class="sumRight"><span class="pill">–†–µ–∑—É–ª—Ç–∞—Ç</span><span class="chev">‚Ä∫</span></div>
    </summary>
    <div class="bd">
      <div class="resultsGrid">
        <div class="box">
          <canvas id="radar" width="720" height="360"></canvas>
          <p class="note">–†–∞–¥–∞—Ä—ä—Ç –ø–æ–∫–∞–∑–≤–∞ 10 –æ—Å–∏. –¢–æ–≤–∞ –µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ç–µ–∫—É—â–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏.</p>
        </div>
        <div class="box">
          <div class="kpis">
            <div class="kpi">
              <div class="k">–ü—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª–Ω–∞ –¥–æ–º–∏–Ω–∞—Ü–∏—è</div>
              <div class="v" id="kpiPfc">‚Äî</div>
              <div class="x" id="kpiPfcTx">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="k">–õ–∏–º–±–∏—á–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç</div>
              <div class="v" id="kpiLimbic">‚Äî</div>
              <div class="x" id="kpiLimbicTx">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="k">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Å–º–∏—Å—ä–ª/–∫–æ–Ω—Ç–µ–∫—Å—Ç)</div>
              <div class="v" id="kpiIntegr">‚Äî</div>
              <div class="x" id="kpiIntegrTx">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="k">–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è (g-–ø—Ä–æ—Ñ–∏–ª)</div>
              <div class="v" id="kpiAbs">‚Äî</div>
              <div class="x" id="kpiAbsTx">‚Äî</div>
            </div>
          </div>

          <div class="model" style="margin-top:12px">
            <h3>–¢–µ–∫—É—â –º–æ–¥–µ–ª (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω —Å–∏–Ω—Ç–µ–∑)</h3>
            <p id="modelText">‚Äî</p>
            <ul class="bullets" id="modelBullets"></ul>
            <p class="note" id="modelCaveat">‚Äî</p>
            <p class="note" id="demoInModel">‚Äî</p>
            <p class="note">
              üîí –ò–Ω–¥–µ–∫—Å–∏ = –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –ø–ª—ä–∑–≥–∞—á–∏. üü° –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏—Ç–µ —Å–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∏ –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
            </p>
          </div>

        </div>
      </div>
    </div>
  </details>

  <details class="acc" id="sec_sliders">
    <summary>
      <div class="sumLeft">
        <div class="t">–ü–ª—ä–∑–≥–∞—á–∏ –Ω–∞ —Ü–µ–Ω—Ç—Ä–æ–≤–µ (—Ä—ä—á–Ω–∞ –∫–∞–ª–∏–±—Ä–∞—Ü–∏—è + –∏–Ω—Ñ–æ)</div>
        <div class="d">–ù–∞—Ç–∏—Å–Ω–∏ ‚Äûi‚Äú –∑–∞ —Ñ—É–Ω–∫—Ü–∏–∏/–º–∞—Ä–∫–µ—Ä–∏ –∏ –Ω–µ–ª–∏–Ω–µ–π–Ω–∏ –≤—Ä—ä–∑–∫–∏ –≤ –º–æ–¥–µ–ª–∞.</div>
      </div>
      <div class="sumRight"><span class="pill">–ö–∞–ª–∏–±—Ä–∞—Ü–∏—è</span><span class="chev">‚Ä∫</span></div>
    </summary>
    <div class="bd">
      <div class="cards" id="cards"></div>
      <p class="note">
        –ù–∏–≤–∞: 0‚Äì35 –Ω–∏—Å–∫–æ, 36‚Äì65 —Å—Ä–µ–¥–Ω–æ, 66‚Äì100 –≤–∏—Å–æ–∫–æ. ‚Äû–í–∏—Å–æ–∫–æ/–Ω–∏—Å–∫–æ‚Äú –Ω–µ –µ —Ä–∞–≤–Ω–æ –Ω–∞ ‚Äû–¥–æ–±—Ä–æ/–ª–æ—à–æ‚Äú ‚Äî –≤–∞–∂–Ω–∞ –µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è—Ç–∞.
      </p>
    </div>
  </details>

  <details class="acc" id="sec_share">
    <summary>
      <div class="sumLeft">
        <div class="t">–°–ø–æ–¥–µ–ª—è–Ω–µ (JSON –∏–∑—Ç–µ–≥–ª—è–Ω–µ/–∫–æ–ø–∏—Ä–∞–Ω–µ + –∏–º–ø–æ—Ä—Ç)</div>
        <div class="d">–ï–∫—Å–ø–æ—Ä—Ç—ä—Ç —Å—ä–¥—ä—Ä–∂–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏, –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è, –∏–Ω–¥–µ–∫—Å–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏.</div>
      </div>
      <div class="sumRight"><span class="pill">JSON</span><span class="chev">‚Ä∫</span></div>
    </summary>
    <div class="bd">
      <div class="shareGrid">
        <div class="box">
          <div class="fileRow" style="margin-bottom:10px">
            <button class="btn" id="btnCopyJson">‚éò –ö–æ–ø–∏—Ä–∞–π JSON</button>
            <button class="btn" id="btnRefreshJson">‚Üª –û–±–Ω–æ–≤–∏ –ø—Ä–µ–≥–ª–µ–¥</button>
            <button class="btn" id="btnDownloadJson2">‚¨á –ò–∑—Ç–µ–≥–ª–∏ JSON</button>
          </div>
          <textarea id="jsonPreview" readonly spellcheck="false"></textarea>
          <p class="note">JSON –µ —É–¥–æ–±–µ–Ω –∑–∞ –≤–µ—Ä—Å–∏–∏ –≤—ä–≤ –≤—Ä–µ–º–µ—Ç–æ: –ø—Ä–µ–¥–∏/—Å–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏, –∏–Ω—Ç–µ—Ä–≤–µ–Ω—Ü–∏–∏, –ø–µ—Ä–∏–æ–¥–∏ –Ω–∞ —Å—Ç—Ä–µ—Å.</p>
        </div>
        <div class="box">
          <div class="fileRow">
            <label class="fileLabel" for="importFile">‚á™ –ò–º–ø–æ—Ä—Ç JSON —Ñ–∞–π–ª</label>
            <input id="importFile" type="file" accept="application/json,.json" />
            <button class="btn" id="btnPasteImport" title="–ü–æ—Å—Ç–∞–≤–∏ JSON –æ—Ç –∫–ª–∏–ø–±–æ—Ä–¥–∞ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–π (–∞–∫–æ –µ –ø–æ–∑–≤–æ–ª–µ–Ω–æ).">‚≠≥ –ò–º–ø–æ—Ä—Ç –æ—Ç –∫–ª–∏–ø–±–æ—Ä–¥–∞</button>
          </div>
          <p class="note" style="margin-top:10px">
            –ò–º–ø–æ—Ä—Ç—ä—Ç –∑–∞—Ä–µ–∂–¥–∞: —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ (0‚Äì100), –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫–æ—Ä–µ–ª–∞—Ü–∏–∏/—Å–∏–ª–∞), —Ç–µ—Å—Ç–æ–≤–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏.
          </p>
          <div class="box" style="margin-top:12px">
            <h4>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ JSON</h4>
            <ul>
              <li><b>meta</b>: –≤–µ—Ä—Å–∏—è, –≤—Ä–µ–º–µ –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç</li>
              <li><b>demography</b>: –≤—ä–∑—Ä–∞—Å—Ç, –±–∏–æ–ª–æ–≥–∏—á–µ–Ω –ø–æ–ª</li>
              <li><b>settings</b>: –∫–æ—Ä–µ–ª–∞—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω–∏/—Å–∏–ª–∞</li>
              <li><b>state</b>: —Å—Ç–æ–π–Ω–æ—Å—Ç–∏</li>
              <li><b>indices</b>: –∏–Ω–¥–µ–∫—Å–∏</li>
              <li><b>test</b>: –æ—Ç–≥–æ–≤–æ—Ä–∏ 1‚Äì5, –º–∞–ø–∏—Ä–∞–Ω–µ 0‚Äì100, –∏ —Ñ–ª–∞–≥ –∑–∞ –æ–±—ä—Ä–Ω–∞—Ç–æ –∫–æ–¥–∏—Ä–∞–Ω–µ</li>
            </ul>
          </div>
          <p class="note" id="importStatus">‚Äî</p>
        </div>
      </div>
    </div>
  </details>

</div>

<!-- Info modal -->
<div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHd">
      <div class="t">
        <strong id="modalTitle">‚Äî</strong>
        <span id="modalSub">‚Äî</span>
      </div>
      <button class="closeBtn" id="modalClose" aria-label="–ó–∞—Ç–≤–æ—Ä–∏">‚úï</button>
    </div>
    <div class="modalBd">
      <div class="grid2">
        <div class="box">
          <h4>–û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏</h4>
          <ul id="modalFunctions"></ul>
        </div>
        <div class="box">
          <h4>–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏ –º–∞—Ä–∫–µ—Ä–∏ (—Ç–∏–ø–∏—á–Ω–æ)</h4>
          <ul id="modalMarkers"></ul>
        </div>
        <div class="box">
          <h4>–ù–µ–ª–∏–Ω–µ–π–Ω–∏ –≤—Ä—ä–∑–∫–∏ (–≤ —Ç–æ–∑–∏ –º–æ–¥–µ–ª)</h4>
          <p id="modalCors">‚Äî</p>
        </div>
        <div class="box">
          <h4>–î–µ–º–æ–≥—Ä–∞—Ñ–∏—è –≤ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ</h4>
          <p id="modalDemo">‚Äî</p>
          <div class="note">
            –ï—Ñ–µ–∫—Ç–∏—Ç–µ —Å–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏: –≤—ä–∑—Ä–∞—Å—Ç <b>–≥–ª–∞–≤–Ω–æ –ø–æ–¥ 25 –≥.</b>, –ø–æ–ª ‚Äî <b>–º–∏–Ω–∏–º–∞–ª–Ω–∏</b> –∫–æ—Ä–µ–∫—Ü–∏–∏.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const MODEL_VERSION = "NF-Profile-1.5-demo-nonlinear-neutral-test";
  const TZ_HINT = "Europe/Sofia";

  const clamp = (v, a=0, b=100) => Math.max(a, Math.min(b, v));
  const round1 = (n) => Math.round(n*10)/10;
  const fmt = (n) => (Math.round(n*10)/10).toString();

  const centers = [
    { id:"dlpfc", name:"DLPFC", long:"–î–æ—Ä–∑–æ–ª–∞—Ç–µ—Ä–∞–ª–µ–Ω –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª–µ–Ω –∫–æ—Ä—Ç–µ–∫—Å", short:"–∞–Ω–∞–ª–∏–∑ ‚Ä¢ —Ä–∞–±–æ—Ç–Ω–∞ –ø–∞–º–µ—Ç ‚Ä¢ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è" },
    { id:"vmpfc", name:"VMPFC", long:"–í–µ–Ω—Ç—Ä–æ–º–µ–¥–∏–∞–ª–µ–Ω –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª–µ–Ω –∫–æ—Ä—Ç–µ–∫—Å", short:"—Å—Ç–æ–π–Ω–æ—Å—Ç ‚Ä¢ —Å–º–∏—Å—ä–ª ‚Ä¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è" },
    { id:"ofc",   name:"OFC",   long:"–û—Ä–±–∏—Ç–æ—Ñ—Ä–æ–Ω—Ç–∞–ª–µ–Ω –∫–æ—Ä—Ç–µ–∫—Å", short:"–ø–æ—Å–ª–µ–¥–∏—Ü–∏ ‚Ä¢ —Å–æ—Ü–∏–∞–ª–Ω–∞ –∫–∞–ª–∏–±—Ä–∞—Ü–∏—è" },
    { id:"acc",   name:"ACC",   long:"–ü—Ä–µ–¥–µ–Ω —Ü–∏–Ω–≥—É–ª–∞—Ç–µ–Ω –∫–æ—Ä—Ç–µ–∫—Å", short:"–∫–æ–Ω—Ç—Ä–æ–ª ‚Ä¢ –≥—Ä–µ—à–∫–∏ ‚Ä¢ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç" },
    { id:"amyg",  name:"–ê–º–∏–≥–¥–∞–ª–∞", long:"–ê–º–∏–≥–¥–∞–ª–∞", short:"–∞–ª–∞—Ä–º–∞ ‚Ä¢ —Å—Ç—Ä–∞—Ö/–≥–Ω—è–≤ ‚Ä¢ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç" },
    { id:"hyp",   name:"–•–∏–ø–æ—Ç–∞–ª–∞–º—É—Å", long:"–•–∏–ø–æ—Ç–∞–ª–∞–º—É—Å", short:"—Å—Ç—Ä–µ—Å ‚Ä¢ –∞–≤—Ç–æ–Ω–æ–º–Ω–∏ —Ä–µ–∞–∫—Ü–∏–∏" },
    { id:"pag",   name:"PAG",   long:"–ü–µ—Ä–∏–∞–∫–≤–µ–¥—É–∫—Ç–∞–ª–Ω–æ —Å–∏–≤–æ –≤–µ—â–µ—Å—Ç–≤–æ (PAG)", short:"–∑–∞—â–∏—Ç–∞ ‚Ä¢ –µ—Å–∫–∞–ª–∞—Ü–∏—è/–∑–∞–º—Ä—ä–∑–≤–∞–Ω–µ" },
    { id:"insula",name:"–ò–Ω—Å—É–ª–∞", long:"–ò–Ω—Å—É–ª–∞—Ä–µ–Ω –∫–æ—Ä—Ç–µ–∫—Å", short:"—Ç–µ–ª–µ—Å–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏ ‚Ä¢ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–æ—Å—Ç" },
    { id:"hippo", name:"–•–∏–ø–æ–∫–∞–º–ø", long:"–•–∏–ø–æ–∫–∞–º–ø", short:"–ø–∞–º–µ—Ç ‚Ä¢ –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Ä¢ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ" },
    { id:"par",   name:"–ü–∞—Ä–∏–µ—Ç–∞–ª–Ω–∞ –∫–æ—Ä–∞", long:"–ü–∞—Ä–∏–µ—Ç–∞–ª–Ω–∞ –∫–æ—Ä–∞", short:"–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è ‚Ä¢ –º–æ–¥–µ–ª–∏ ‚Ä¢ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ" },
  ];

  const info = {
    dlpfc: { functions:["–†–∞–±–æ—Ç–Ω–∞ –ø–∞–º–µ—Ç","–õ–æ–≥–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑","–ü–ª–∞–Ω–∏—Ä–∞–Ω–µ","–°—Ç—Ä–∞—Ç–µ–≥–∏—è","–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞ –≥—ä–≤–∫–∞–≤–æ—Å—Ç"],
      markers:["–ü–∞—É–∑–∞ –ø—Ä–µ–¥–∏ –¥–µ–π—Å—Ç–≤–∏–µ","–°–ª–æ–∂–Ω–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è","–ù–∏—Å–∫–∞ –∏–º–ø—É–ª—Å–∏–≤–Ω–æ—Å—Ç","–í–∏—Å–æ–∫–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏. –ú–∞—Ä–∫–µ—Ä–∏: –∫–æ–Ω—Ç–µ–∫—Å—Ç-–∑–∞–≤–∏—Å–∏–º–∏."},
    vmpfc:{ functions:["–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –µ–º–æ—Ü–∏–∏‚Üí—Ä–µ—à–µ–Ω–∏–µ","–û—Ü–µ–Ω–∫–∞ –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç","–°–º–∏—Å—ä–ª/–ø–æ—Å–æ–∫–∞","–°—Ç–∞–±–∏–ª–Ω–æ—Å—Ç –Ω–∞ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è"],
      markers:["–†–µ—à–µ–Ω–∏—è –ø–æ —Å–º–∏—Å—ä–ª","–ü–æ-–º–∞–ª–∫–æ –∫–æ–ª–µ–±–∞–Ω–∏–µ –≤ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–∏ –∏–∑–±–æ—Ä–∏","–î—ä–ª–±–æ–∫–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏. üü° –ú–∞—Ä–∫–µ—Ä–∏: –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∏."},
    ofc:  { functions:["–û—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–∏—Ü–∏","–°–æ—Ü–∏–∞–ª–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç","–ü–æ—Ç–∏—Å–∫–∞–Ω–µ –Ω–∞ –∏–º–ø—É–ª—Å","–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–∏ —Å–º—è–Ω–∞ –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞","–£—á–µ–Ω–µ –æ—Ç –≥—Ä–µ—à–∫–∞"],
      markers:["–ü–æ-–º–∞–ª–∫–æ —Å–æ—Ü–∏–∞–ª–Ω–∏ –≥—Ä–µ—à–∫–∏","–ü–æ-–¥–æ–±—ä—Ä –∫–æ–Ω—Ç—Ä–æ–ª –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç","–¢–∞–∫—Ç–∏—á–Ω–∞ —Ä–µ–≥—É–ª–∞—Ü–∏—è"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    acc:  { functions:["–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ –≥—Ä–µ—à–∫–∞","–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–µ –Ω–∞ —É—Å–∏–ª–∏–µ","–°–º—è–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è","–ö–æ–Ω—Ç—Ä–æ–ª –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç","–§–æ–∫—É—Å –ø–æ–¥ –Ω–∞—Ç–∏—Å–∫"],
      markers:["–°–∞–º–æ–∫–æ—Ä–µ–∫—Ü–∏—è","–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç","–ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω–∞ –∫–æ—Ä–µ–∫—Ü–∏—è"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    amyg: { functions:["–ê–ª–∞—Ä–º–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞","–ë—ä—Ä–∑–æ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ –Ω–∞ –∑–∞–ø–ª–∞—Ö–∞","–£—Å–∏–ª–≤–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞—Ö/–≥–Ω—è–≤","–°–∫—ä—Å—è–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –∑–∞ –º–∏—Å–ª–µ–Ω–µ"],
      markers:["–†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç –ø—Ä–∏ –∑–∞–ø–ª–∞—Ö–∞/–∫—Ä–∏—Ç–∏–∫–∞","–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç –ø—Ä–∏ –≤–∏—Å–æ–∫ –±–∞–∑–æ–≤ —Ç–æ–Ω—É—Å","–ò–º–ø—É–ª—Å–∏–≤–Ω–æ—Å—Ç –ø—Ä–∏ —Å—Ç—Ä–µ—Å"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    hyp:  { functions:["–ê–≤—Ç–æ–Ω–æ–º–Ω–∏ —Ä–µ–∞–∫—Ü–∏–∏ (–±–æ–π/–±—è–≥—Å—Ç–≤–æ/–∑–∞–º—Ä—ä–∑–≤–∞–Ω–µ)","–•–æ—Ä–º–æ–Ω–∞–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ —Å—Ç—Ä–µ—Å","–°–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ","–ó–∞—â–∏—Ç–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏"],
      markers:["–¢–µ–ª–µ—Å–Ω–∞ —Å—Ç—Ä–µ—Å-—Ä–µ–∞–∫—Ü–∏—è","–ù–∞–ø—Ä–µ–∂–µ–Ω–∏–µ/–±–µ–∑—Å—ä–Ω–∏–µ –ø—Ä–∏ —Ö—Ä–æ–Ω–∏—á–µ–Ω —Å—Ç—Ä–µ—Å","–†–∞–∑–¥—Ä–∞–∑–Ω–∏—Ç–µ–ª–Ω–æ—Å—Ç –ø—Ä–∏ –ø—Ä–µ—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    pag:  { functions:["–ü—Ä–∏–º–∏—Ç–∏–≤–Ω–∏ –∑–∞—â–∏—Ç–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏","–†–µ—Ñ–ª–µ–∫—Å–Ω–∞ –µ—Å–∫–∞–ª–∞—Ü–∏—è –∏–ª–∏ –∑–∞–º—Ä—ä–∑–≤–∞–Ω–µ","–ú–æ–¥—É–ª–∞—Ü–∏—è –Ω–∞ –±–æ–ª–∫–∞","–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ —Ä–µ–∞–∫—Ü–∏–∏"],
      markers:["–†—è–∑–∫–∞ –µ—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫","‚Äû–ó–∞–º—Ä—ä–∑–≤–∞–Ω–µ‚Äú –ø—Ä–∏ –ø—Ä–µ—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ","–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω –∑–∞—â–∏—Ç–µ–Ω —Ç–æ–Ω"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    insula:{functions:["–í—ä—Ç—Ä–µ—à–Ω–∏ —Ç–µ–ª–µ—Å–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏","–¢–µ–ª–µ—Å–Ω–∞ –æ—Å–Ω–æ–≤–∞ –Ω–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–æ—Å—Ç","–û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ/–¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç","–°–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç (–∫–∞–∫–≤–æ ‚Äû–±–∏–µ‚Äú –Ω–∞ –≤–Ω–∏–º–∞–Ω–∏–µ—Ç–æ)"],
      markers:["–°–≤—Ä—ä—Ö—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–æ—Å—Ç (–≤–∏—Å–æ–∫–æ)","–ï–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç (–Ω–∏—Å–∫–æ)","–¢–µ–ª–µ—Å–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Ä–µ—à–µ–Ω–∏—è—Ç–∞"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    hippo:{functions:["–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø–∞–º–µ—Ç","–°–≤—ä—Ä–∑–≤–∞–Ω–µ –Ω–∞ –æ–ø–∏—Ç","‚Äû–ö–∞—Ä—Ç–∞‚Äú –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏–∏","–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–∞–∑–∫–∞–∑–∞"],
      markers:["–£—á–µ–Ω–µ –æ—Ç –æ–ø–∏—Ç","–ü–æ-—Ç–æ—á–Ω–∞ –ø—Ä–µ—Ü–µ–Ω–∫–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç","–ü–æ-–º–∞–ª–∫–æ –≥–µ–Ω–µ—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç—Ä–µ—Å (–∞–∫–æ –µ –≤–∏—Å–æ–∫)"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."},
    par:  { functions:["–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∏ –º–æ–¥–µ–ª–∏","–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–æ-–ª–æ–≥–∏—á–µ—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞","–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏","–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –º—Ä–µ–∂–∏, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å –∏–Ω—Ç–µ–ª–µ–∫—Ç"],
      markers:["–°–∏–ª–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è","–°–∏—Å—Ç–µ–º–Ω–æ—Å—Ç","–ë—ä—Ä–∑–æ –º–æ–¥–µ–ª–∏—Ä–∞–Ω–µ"],
      cert:"üîí –§—É–Ω–∫—Ü–∏–∏: –¥–æ–±—Ä–µ –ø–æ–¥–∫—Ä–µ–ø–µ–Ω–∏."}
  };

  // ===== –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è (–≤–ª–∏–∑–∞ –≤ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ) =====
  const demo = { ageYears: 30, sexBio: "unspecified" };

  function setDemoFromInputs(){
    const age = Number(document.querySelector("#ageYears")?.value);
    demo.ageYears = Number.isFinite(age) ? clamp(age, 6, 110) : 30;
    const s = document.querySelector("#sexBio")?.value || "unspecified";
    demo.sexBio = ["male","female","unspecified"].includes(s) ? s : "unspecified";
    updateDemoText();
    renderAll();
    updateJsonPreview(true);
  }

  function sexLabel(){
    if (demo.sexBio === "male") return "–º—ä–∂";
    if (demo.sexBio === "female") return "–∂–µ–Ω–∞";
    return "–Ω–µ–ø–æ—Å–æ—á–µ–Ω–æ";
  }

  // –ú–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∏ (—É–º–∏—à–ª–µ–Ω–æ –º–∞–ª–∫–∏)
  function demoMultiplier(edge){
    let mAge = 1.0;
    let mSex = 1.0;
    const age = demo.ageYears;

    // –í—ä–∑—Ä–∞—Å—Ç: –ø–æ–¥ 25 ‚Äî –ø–æ-—Å–ª–∞–± ‚Äû—Ç–æ–ø-–¥–∞—É–Ω‚Äú –∫–æ–Ω—Ç—Ä–æ–ª –∏ –ø–æ-—Å–∏–ª–µ–Ω ‚Äû–±—É—Ç–∞–Ω–µ‚Äú –æ—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –ø—ä—Ç–∏—â–∞ (–º–∞–ª–∫–∏ –∫–æ—Ä–µ–∫—Ü–∏–∏)
    if (age < 25){
      const x = clamp((25 - age) / 10, 0, 1); // 0..1 (25‚Üí0, 15‚Üí1)
      if (edge.sign < 0 && ["ofc","dlpfc","acc","vmpfc","hippo"].includes(edge.from) && ["amyg","hyp","pag"].includes(edge.to)){
        mAge *= (1 - 0.10 * x); // –¥–æ -10% –∏–Ω—Ö–∏–±–∏—Ü–∏—è
      }
      if (edge.sign < 0 && ["amyg","hyp","pag"].includes(edge.from) && ["ofc","dlpfc","acc","hippo"].includes(edge.to)){
        mAge *= (1 + 0.08 * x); // –¥–æ +8% –∏–Ω—Ö–∏–±–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª (–ø–æ-–ª–µ—Å–Ω–∞ ‚Äû–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è‚Äú –ø–æ–¥ —Å—Ç—Ä–µ—Å)
      }
      if (edge.sign > 0 && ["amyg","hyp"].includes(edge.from) && ["pag"].includes(edge.to)){
        mAge *= (1 + 0.06 * x); // –¥–æ +6% –∫—ä–º –∑–∞—â–∏—Ç–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏
      }
    }

    // –ü–æ–ª: –º–∏–Ω–∏–º–∞–ª–Ω–∏ –∫–æ—Ä–µ–∫—Ü–∏–∏ –Ω–∞ –∑–∞—â–∏—Ç–Ω–∞ –µ—Å–∫–∞–ª–∞—Ü–∏—è –∏ ‚Äû—Å–ø–∏—Ä–∞—á–∫–∏‚Äú (—É–º–∏—à–ª–µ–Ω–æ ‚â§ ~5%)
    if (demo.sexBio === "male"){
      if (edge.from==="amyg" && edge.to==="pag" && edge.sign>0) mSex *= 1.04;
      if (edge.from==="hyp" && edge.to==="pag" && edge.sign>0) mSex *= 1.03;
      if (edge.from==="ofc" && edge.to==="amyg" && edge.sign<0) mSex *= 0.98;
    } else if (demo.sexBio === "female"){
      if (edge.from==="amyg" && edge.to==="pag" && edge.sign>0) mSex *= 0.97;
      if (edge.from==="hyp" && edge.to==="pag" && edge.sign>0) mSex *= 0.98;
      if (edge.from==="ofc" && edge.to==="amyg" && edge.sign<0) mSex *= 1.02;
    }

    const m = clamp(mAge * mSex, 0.85, 1.15);
    return m;
  }

  function updateDemoText(){
    const el = document.querySelector("#demoEffectText");
    if (!el) return;
    const age = demo.ageYears;
    let ageTx = "–≤—ä–∑—Ä–∞—Å—Ç–µ–Ω —Ä–µ–∂–∏–º (–µ—Ñ–µ–∫—Ç—ä—Ç –µ –º–∏–Ω–∏–º–∞–ª–µ–Ω)";
    if (age < 25) ageTx = "–ø–æ–¥ 25 –≥.: –ª–µ–∫–æ –ø–æ-—Å–ª–∞–± —Ç–æ–ø-–¥–∞—É–Ω –∫–æ–Ω—Ç—Ä–æ–ª –≤—ä—Ä—Ö—É –∞–ª–∞—Ä–º–∞/–∑–∞—â–∏—Ç–∞ (–≤ –º–æ–¥–µ–ª–∞)";
    el.textContent =
      `–¢–µ–∫—É—â–æ: –≤—ä–∑—Ä–∞—Å—Ç ${age} –≥., –ø–æ–ª: ${sexLabel()}. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∏—Ç–µ —Å–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏ ‚Äî —Ü–µ–ª—Ç–∞ –µ –¥–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞—Ç –∫–æ—Ä–µ–ª–∞—Ü–∏–∏ –ª–µ–∫–æ, –±–µ–∑ –¥–∞ –¥–æ–º–∏–Ω–∏—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª–∞. (${ageTx})`;
  }

  // ===== –ù–µ–ª–∏–Ω–µ–π–Ω–∏ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏ (–º–æ–¥–µ–ª) =====
  const edges = [
    {from:"dlpfc", to:"acc",   sign:+1, strength:0.90, max:18, scale:18, gate:"target_lo"},
    {from:"acc",   to:"dlpfc", sign:+1, strength:0.55, max:10, scale:18, gate:"target_lo"},
    {from:"dlpfc", to:"par",   sign:+1, strength:0.45, max:10, scale:20, gate:"target_lo"},
    {from:"par",   to:"dlpfc", sign:+1, strength:0.55, max:12, scale:20, gate:"target_lo"},

    {from:"hippo", to:"vmpfc", sign:+1, strength:0.40, max:10, scale:20, gate:"target_lo"},
    {from:"vmpfc", to:"ofc",   sign:+1, strength:0.35, max:10, scale:20, gate:"target_lo"},

    {from:"ofc",   to:"amyg",  sign:-1, strength:0.85, max:22, scale:16, gate:"target_hi"},
    {from:"dlpfc", to:"amyg",  sign:-1, strength:0.70, max:18, scale:16, gate:"target_hi"},
    {from:"acc",   to:"amyg",  sign:-1, strength:0.50, max:14, scale:16, gate:"target_hi"},
    {from:"ofc",   to:"hyp",   sign:-1, strength:0.55, max:16, scale:18, gate:"target_hi"},
    {from:"ofc",   to:"pag",   sign:-1, strength:0.55, max:16, scale:18, gate:"target_hi"},
    {from:"vmpfc", to:"amyg",  sign:-1, strength:0.45, max:14, scale:18, gate:"target_hi"},
    {from:"hippo", to:"amyg",  sign:-1, strength:0.30, max:10, scale:20, gate:"target_hi"},

    {from:"amyg",  to:"hyp",   sign:+1, strength:0.90, max:24, scale:14, gate:"src_hi"},
    {from:"amyg",  to:"pag",   sign:+1, strength:0.80, max:22, scale:14, gate:"src_hi"},
    {from:"hyp",   to:"pag",   sign:+1, strength:0.55, max:16, scale:16, gate:"src_hi"},
    {from:"amyg",  to:"insula",sign:+1, strength:0.55, max:16, scale:16, gate:"src_hi"},
    {from:"insula",to:"amyg",  sign:+1, strength:0.40, max:12, scale:18, gate:"src_hi"},

    {from:"amyg",  to:"ofc",   sign:-1, strength:0.60, max:18, scale:16, gate:"src_hi"},
    {from:"amyg",  to:"dlpfc", sign:-1, strength:0.50, max:16, scale:16, gate:"src_hi"},
    {from:"pag",   to:"ofc",   sign:-1, strength:0.35, max:12, scale:18, gate:"src_hi"},
    {from:"pag",   to:"acc",   sign:-1, strength:0.30, max:10, scale:18, gate:"src_hi"},

    {from:"amyg",  to:"hippo", sign:-1, strength:0.35, max:12, scale:18, gate:"src_hi"},
    {from:"hyp",   to:"hippo", sign:-1, strength:0.30, max:10, scale:18, gate:"src_hi"},
  ];

  const defaultYou = { dlpfc: 86, vmpfc: 78, ofc: 82, acc: 76, amyg: 28, hyp: 34, pag: 26, insula: 52, hippo: 74, par: 78 };
  const defaultNeutral = centers.reduce((a,c)=> (a[c.id]=50, a), {});

  let state = { ...defaultYou };
  let isApplying = false;

  // ===== UI refs =====
  const $ = (sel) => document.querySelector(sel);
  const cardsEl = $("#cards");
  const coupleToggle = $("#coupleToggle");
  const couplingStrength = $("#couplingStrength");
  const jsonPreview = $("#jsonPreview");
  const importFile = $("#importFile");
  const importStatus = $("#importStatus");

  function levelTag(v){
    if (v <= 35) return { cls:"bad", label:"–Ω–∏—Å–∫–æ" };
    if (v <= 65) return { cls:"warn", label:"—Å—Ä–µ–¥–Ω–æ" };
    return { cls:"good", label:"–≤–∏—Å–æ–∫–æ" };
  }

  function couplingParams(){
    const lvl = couplingStrength.value;
    if (lvl === "low")  return { gain:0.55, iters:3, spread:0.85 };
    if (lvl === "high") return { gain:0.95, iters:6, spread:1.10 };
    return { gain:0.75, iters:4, spread:1.00 }; // mid
  }

  const satTanh = (x) => Math.tanh(x);

  function gateFactor(edge, srcVal, dstVal){
    const s = clamp(srcVal)/100;
    const t = clamp(dstVal)/100;

    let g = edge.sign > 0
      ? (1 - t) * (0.55 + 0.45*s)
      : (t)     * (0.55 + 0.45*s);

    if (edge.gate === "target_hi") g *= Math.pow(t, 1.15);
    if (edge.gate === "target_lo") g *= Math.pow(1 - t, 1.10);
    if (edge.gate === "src_hi")    g *= Math.pow(s, 1.10);

    return clamp(g, 0, 1);
  }

  function influenceFromDelta(edge, deltaSrc, srcVal, dstVal){
    const { gain } = couplingParams();
    const pulse = satTanh(deltaSrc / edge.scale);
    const g = gateFactor(edge, srcVal, dstVal);
    const m = demoMultiplier(edge);
    return edge.sign * edge.max * edge.strength * gain * pulse * g * m;
  }

  function propagateChange(changedId, delta0){
    if (!coupleToggle.checked) return;
    const { iters, spread } = couplingParams();
    const fixed = changedId;

    let deltaMap = {};
    deltaMap[changedId] = delta0;

    for (let k = 0; k < iters; k++){
      const nextDelta = {};
      const snap = { ...state };

      for (const e of edges){
        const dSrc = deltaMap[e.from];
        if (!dSrc || Math.abs(dSrc) < 1e-6) continue;
        if (e.to === fixed) continue;

        const eff = influenceFromDelta(e, dSrc * spread, snap[e.from], snap[e.to]);
        if (Math.abs(eff) < 1e-6) continue;

        state[e.to] = clamp(state[e.to] + eff);
        nextDelta[e.to] = (nextDelta[e.to] || 0) + eff;
      }

      deltaMap = nextDelta;
      if (Object.keys(deltaMap).length === 0) break;
    }
  }

  // ===== –ò–Ω–¥–µ–∫—Å–∏ =====
  const idxPFC = () => (state.dlpfc + state.vmpfc + state.ofc + state.acc) / 4;
  const idxLimbic = () => (state.amyg + state.hyp + state.pag + state.insula) / 4;
  const idxIntegr = () => (state.vmpfc + state.hippo + state.acc) / 3;
  const idxAbs = () => (state.dlpfc + state.par) / 2;
  function labelScore(v){ if (v < 35) return "–Ω–∏—Å–∫–æ"; if (v < 65) return "—Å—Ä–µ–¥–Ω–æ"; return "–≤–∏—Å–æ–∫–æ"; }

  function buildModelText(){
    const p = idxPFC(), l = idxLimbic(), i = idxIntegr(), a = idxAbs();
    const bal = p - l;

    const main =
      `–ü—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª–Ω–∞ –¥–æ–º–∏–Ω–∞—Ü–∏—è: ${labelScore(p)} (${fmt(p)}). ` +
      `–õ–∏–º–±–∏—á–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç: ${labelScore(l)} (${fmt(l)}). ` +
      `–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Å–º–∏—Å—ä–ª/–∫–æ–Ω—Ç–µ–∫—Å—Ç): ${labelScore(i)} (${fmt(i)}). ` +
      `–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è: ${labelScore(a)} (${fmt(a)}). ` +
      `–ë–∞–ª–∞–Ω—Å (–ü–§–ö ‚àí –ª–∏–º–±–∏—á–Ω–∞): ${(bal>=0?"+":"")}${fmt(bal)}.`;

    const bullets = [];
    if (bal > 18) bullets.push("üîí –í–∏—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: –∫–æ–Ω—Ç—Ä–æ–ª—ä—Ç –¥–æ–º–∏–Ω–∏—Ä–∞ –Ω–∞–¥ —Ä–µ–∞–∫—Ü–∏—è—Ç–∞ –≤ –ø–æ–≤–µ—á–µ—Ç–æ —Å–∏—Ç—É–∞—Ü–∏–∏.");
    if (bal < -12) bullets.push("üîí –í–∏—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: —Ä–µ–∞–∫—Ç–∏–≤–Ω–∏—Ç–µ –ø—ä—Ç–∏—â–∞ –¥–æ–º–∏–Ω–∏—Ä–∞—Ç –ø—Ä–∏ –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ (–∫—ä—Å –ø—Ä–æ–∑–æ—Ä–µ—Ü –∑–∞ –∞–Ω–∞–ª–∏–∑).");

    if (state.ofc >= 70 && state.amyg <= 35) bullets.push("üîí –í–∏—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: –Ω–∏—Å–∫–∞ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç –∫—ä–º –∏–º–ø—É–ª—Å–∏–≤–Ω–∞ –µ—Å–∫–∞–ª–∞—Ü–∏—è; —Ä–µ—à–µ–Ω–∏—è—Ç–∞ –º–∏–Ω–∞–≤–∞—Ç –ø—Ä–µ–∑ ‚Äû–ø–æ—Å–ª–µ–¥–∏—Ü–∏‚Äú.");
    if (state.acc >= 70) bullets.push("üîí –í–∏—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: —Å–∞–º–æ–∫–æ—Ä–µ–∫—Ü–∏—è –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç –ø—Ä–∏ —Ç—Ä—É–¥–Ω–∏ –∑–∞–¥–∞—á–∏.");
    if (state.dlpfc >= 75 && state.par >= 70) bullets.push("üîí –í–∏—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: —Å–∏–ª–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è + —Ä–∞–±–æ—Ç–Ω–∞ –ø–∞–º–µ—Ç (–æ–±—â –∏–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª).");

    if (state.amyg >= 70) bullets.push("üîí –í–∏—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: –ø–æ–≤–∏—à–µ–Ω–∞ –∞–ª–∞—Ä–º–µ–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç (—Å—Ç—Ä–∞—Ö/–≥–Ω—è–≤ —Å–µ –∞–∫—Ç–∏–≤–∏—Ä–∞—Ç –ª–µ—Å–Ω–æ).");
    if (state.hyp >= 70 || state.pag >= 70) bullets.push("üü° –í–µ—Ä–æ—è—Ç–Ω–æ: —Ç–µ–ª–µ—Å–Ω–∞ —Å—Ç—Ä–µ—Å-—Ä–µ–∞–∫—Ü–∏—è –∏ –∑–∞—â–∏—Ç–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ —Å–µ –≤–∫–ª—é—á–≤–∞—Ç –ø–æ-–ª–µ—Å–Ω–æ.");

    if (state.hippo >= 70 && state.vmpfc >= 70) bullets.push("üü° –í–µ—Ä–æ—è—Ç–Ω–æ: —Ä–µ—à–µ–Ω–∏—è—Ç–∞ —Å–µ –≤–æ–¥—è—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–º–∏—Å—ä–ª, –Ω–µ —Å–∞–º–æ –æ—Ç –ª–æ–≥–∏–∫–∞.");
    if (state.insula >= 70) bullets.push("üü° –í–µ—Ä–æ—è—Ç–Ω–æ: —Ç–µ–ª–µ—Å–Ω–∏—Ç–µ —Å–∏–≥–Ω–∞–ª–∏ –≤–ª–∏—è—è—Ç —Å–∏–ª–Ω–æ –Ω–∞ –≤—ä–∑–ø—Ä–∏—è—Ç–∏–µ—Ç–æ –∏ –∏–∑–±–æ—Ä–∞.");

    if (!bullets.length) bullets.push("‚Äî –ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –±–ª–∏–∑–æ –¥–æ –±–∞–ª–∞–Ω—Å–∏—Ä–∞–Ω; –Ω—è–º–∞ –∫—Ä–∞–π–Ω–æ—Å—Ç–∏, –∫–æ–∏—Ç–æ –¥–∞ –¥–æ–º–∏–Ω–∏—Ä–∞—Ç.");

    const caveat =
      "–£—Å–ª–æ–≤–∏—è –∑–∞ –ø—Ä–∏–ª–æ–∂–∏–º–æ—Å—Ç: —Å—Ç–∞–±–∏–ª–Ω–∏ –º–æ–¥–µ–ª–∏ (–ø–æ–≤—Ç–∞—Ä—è–µ–º–æ—Å—Ç), –Ω–µ –µ–¥–∏–Ω–∏—á–Ω–∏ —Ä–µ–∞–∫—Ü–∏–∏. " +
      "–ö–æ—Ä–µ–ª–∞—Ü–∏–∏: –Ω–µ–ª–∏–Ω–µ–π–Ω–∏, –Ω–∞—Å–∏—â–∞—â–∏ —Å–µ, —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏ –¥–µ–º–æ–≥—Ä–∞—Ñ—Å–∫–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∏.";

    const demoLine =
      `–î–µ–º–æ–≥—Ä–∞—Ñ–∏—è: ${demo.ageYears} –≥., –ø–æ–ª: ${sexLabel()}. ` +
      (demo.ageYears < 25
        ? "üü° –í –º–æ–¥–µ–ª–∞: –ª–µ–∫–æ –ø–æ-—Å–ª–∞–± —Ç–æ–ø-–¥–∞—É–Ω –∫–æ–Ω—Ç—Ä–æ–ª –≤—ä—Ä—Ö—É –∞–ª–∞—Ä–º–∞/–∑–∞—â–∏—Ç–∞."
        : "üü° –î–µ–º–æ–≥—Ä–∞—Ñ—Å–∫–∏—è—Ç –µ—Ñ–µ–∫—Ç –µ –º–∏–Ω–∏–º–∞–ª–µ–Ω.");

    return { main, bullets, caveat, demoLine };
  }

  // ===== Cards =====
  function buildCards(){
    cardsEl.innerHTML = centers.map(c => {
      const t = levelTag(state[c.id]);
      return `
        <div class="card">
          <div class="cardTop">
            <div class="name">
              <div class="main" title="${c.long}">${c.name} ¬∑ ${c.long}</div>
              <div class="sub" title="${c.short}">${c.short}</div>
            </div>
            <button class="infoBtn" data-info="${c.id}" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">i</button>
          </div>
          <div class="row">
            <input type="range" min="0" max="100" step="1" value="${Math.round(state[c.id])}" data-range="${c.id}" />
            <input type="number" min="0" max="100" step="1" value="${Math.round(state[c.id])}" data-num="${c.id}" />
          </div>
          <div class="mini">
            <span class="tag ${t.cls}" data-tag="${c.id}">${t.label}</span>
            <span style="font-family:var(--mono)"><span style="opacity:.75">—Å—Ç–æ–π–Ω–æ—Å—Ç:</span> <b data-val="${c.id}">${Math.round(state[c.id])}</b></span>
          </div>
        </div>
      `;
    }).join("");

    cardsEl.querySelectorAll("[data-range]").forEach(r => {
      r.addEventListener("input", (e) => {
        const id = e.target.getAttribute("data-range");
        setValue(id, Number(e.target.value), true);
      });
    });
    cardsEl.querySelectorAll("[data-num]").forEach(n => {
      n.addEventListener("change", (e) => {
        const id = e.target.getAttribute("data-num");
        setValue(id, Number(e.target.value), true);
      });
    });
    cardsEl.querySelectorAll("[data-info]").forEach(b => {
      b.addEventListener("click", () => openModal(b.getAttribute("data-info")));
    });
  }

  function syncCardsUI(){
    centers.forEach(c => {
      const v = Math.round(state[c.id]);
      const range = cardsEl.querySelector(`[data-range="${c.id}"]`);
      const num = cardsEl.querySelector(`[data-num="${c.id}"]`);
      const val = cardsEl.querySelector(`[data-val="${c.id}"]`);
      const tag = cardsEl.querySelector(`[data-tag="${c.id}"]`);
      if (range) range.value = v;
      if (num) num.value = v;
      if (val) val.textContent = v;

      if (tag){
        const t = levelTag(v);
        tag.classList.remove("good","warn","bad");
        tag.classList.add(t.cls);
        tag.textContent = t.label;
      }
    });
  }

  function setValue(id, newVal, fromUser=false){
    newVal = clamp(newVal);
    const oldVal = state[id];
    state[id] = newVal;

    if (fromUser && coupleToggle.checked && !isApplying){
      const delta = newVal - oldVal;
      if (Math.abs(delta) > 1e-6){
        isApplying = true;
        propagateChange(id, delta);
        isApplying = false;
      }
    }

    syncCardsUI();
    renderAll();
    updateJsonPreview(false);
  }

  // ===== Radar =====
  function drawRadar(){
    const cv = $("#radar");
    const ctx = cv.getContext("2d");

    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = cv.getBoundingClientRect();
    const w = Math.floor(rect.width * dpr);
    const h = Math.floor(rect.height * dpr);
    if (cv.width !== w || cv.height !== h){ cv.width = w; cv.height = h; }
    ctx.clearRect(0,0,cv.width,cv.height);

    const cx = cv.width/2;
    const cy = cv.height/2 + 6*dpr;
    const R  = Math.min(cv.width, cv.height) * 0.34;

    const dims = [
      { key:"dlpfc", label:"–ê–Ω–∞–ª–∏–∑" },
      { key:"par",   label:"–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è" },
      { key:"acc",   label:"–ö–æ–Ω—Ç—Ä–æ–ª" },
      { key:"ofc",   label:"–ü–æ—Å–ª–µ–¥–∏—Ü–∏" },
      { key:"vmpfc", label:"–°–º–∏—Å—ä–ª" },
      { key:"hippo", label:"–ö–æ–Ω—Ç–µ–∫—Å—Ç" },
      { key:"insula",label:"–ß—É–≤—Å—Ç–≤." },
      { key:"amyg",  label:"–ê–ª–∞—Ä–º–∞" },
      { key:"hyp",   label:"–°—Ç—Ä–µ—Å" },
      { key:"pag",   label:"–ó–∞—â–∏—Ç–∞" }
    ];

    ctx.save();
    ctx.lineWidth = 1*dpr;
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.fillStyle = "rgba(255,255,255,0.03)";

    for (let k=1;k<=4;k++){
      const r = (R*k/4);
      ctx.beginPath();
      dims.forEach((d, i) => {
        const a = (Math.PI*2) * (i/dims.length) - Math.PI/2;
        const x = cx + Math.cos(a)*r;
        const y = cy + Math.sin(a)*r;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }

    dims.forEach((d, i) => {
      const a = (Math.PI*2) * (i/dims.length) - Math.PI/2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.lineTo(cx + Math.cos(a)*R, cy + Math.sin(a)*R);
      ctx.stroke();
    });

    const poly = dims.map((d, i) => {
      const v = clamp(state[d.key])/100;
      const a = (Math.PI*2) * (i/dims.length) - Math.PI/2;
      return { x: cx + Math.cos(a)*R*v, y: cy + Math.sin(a)*R*v };
    });

    const g = ctx.createLinearGradient(cx-R, cy-R, cx+R, cy+R);
    g.addColorStop(0, "rgba(124,92,255,0.55)");
    g.addColorStop(1, "rgba(42,212,255,0.45)");

    ctx.strokeStyle = "rgba(231,236,255,0.75)";
    ctx.fillStyle = g;
    ctx.lineWidth = 2*dpr;

    ctx.beginPath();
    poly.forEach((p,i)=> i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = "rgba(243,246,255,0.95)";
    poly.forEach(p=>{
      ctx.beginPath();
      ctx.arc(p.x,p.y, 3.3*dpr, 0, Math.PI*2);
      ctx.fill();
    });

    ctx.fillStyle = "rgba(231,236,255,0.90)";
    ctx.font = `${11*dpr}px ${getComputedStyle(document.body).fontFamily}`;
    dims.forEach((d, i) => {
      const a = (Math.PI*2) * (i/dims.length) - Math.PI/2;
      const x = cx + Math.cos(a)*(R+18*dpr);
      const y = cy + Math.sin(a)*(R+18*dpr);
      ctx.textAlign = Math.cos(a) > 0.2 ? "left" : (Math.cos(a) < -0.2 ? "right" : "center");
      ctx.textBaseline = Math.sin(a) > 0.2 ? "top" : (Math.sin(a) < -0.2 ? "bottom" : "middle");
      ctx.fillText(d.label, x, y);
    });

    ctx.restore();
  }

  // ===== Render =====
  function renderAll(){
    drawRadar();

    const p = idxPFC(), l = idxLimbic(), i = idxIntegr(), a = idxAbs();
    $("#kpiPfc").textContent = fmt(p);
    $("#kpiLimbic").textContent = fmt(l);
    $("#kpiIntegr").textContent = fmt(i);
    $("#kpiAbs").textContent = fmt(a);

    $("#kpiPfcTx").textContent = `–ù–∏–≤–æ: ${labelScore(p)} ¬∑ (DLPFC+VMPFC+OFC+ACC)`;
    $("#kpiLimbicTx").textContent = `–ù–∏–≤–æ: ${labelScore(l)} ¬∑ (–ê–º–∏–≥–¥–∞–ª–∞+–•–∏–ø–æ—Ç–∞–ª–∞–º—É—Å+PAG+–ò–Ω—Å—É–ª–∞)`;
    $("#kpiIntegrTx").textContent = `–ù–∏–≤–æ: ${labelScore(i)} ¬∑ (VMPFC+–•–∏–ø–æ–∫–∞–º–ø+ACC)`;
    $("#kpiAbsTx").textContent = `–ù–∏–≤–æ: ${labelScore(a)} ¬∑ (DLPFC+–ü–∞—Ä–∏–µ—Ç–∞–ª–Ω–∞)`;

    const bal = p - l;
    $("#pillValue").textContent = (bal>=0?"+":"") + fmt(bal);

    const { main, bullets, caveat, demoLine } = buildModelText();
    $("#modelText").textContent = main;
    $("#modelBullets").innerHTML = bullets.map(b => `<li>${b}</li>`).join("");
    $("#modelCaveat").textContent = caveat;
    $("#demoInModel").textContent = demoLine;
  }

  // ===== Modal =====
  const modalBackdrop = $("#modalBackdrop");
  const modalClose = $("#modalClose");
  let lastFocus = null;

  function edgeSummaryFor(id){
    const outgoing = edges.filter(e=>e.from===id).slice(0,10);
    const incoming = edges.filter(e=>e.to===id).slice(0,10);

    const toName = (cid) => centers.find(c=>c.id===cid)?.name || cid;
    const qual = (e) =>
      (e.gate==="target_hi") ? "—Å–∏–ª–Ω–æ –ø—Ä–∏ –≤–∏—Å–æ–∫–∞ —Ü–µ–ª" :
      (e.gate==="target_lo") ? "—Å–∏–ª–Ω–æ –ø—Ä–∏ –Ω–∏—Å–∫–∞ —Ü–µ–ª" :
      (e.gate==="src_hi") ? "—Å–∏–ª–Ω–æ –ø—Ä–∏ –≤–∏—Å–æ–∫ –∏–∑—Ç–æ—á–Ω–∏–∫" :
      "–Ω–µ–ª–∏–Ω–µ–π–Ω–æ";

    const fmtEdge = (e) => {
      const sign = e.sign>0 ? "‚Üë" : "‚Üì";
      return `${sign} ${toName(e.to)} (–º–∞–∫—Å‚âà${e.max} ¬∑ ${qual(e)})`;
    };

    const outText = outgoing.length ? outgoing.map(fmtEdge).join(" ¬∑ ") : "‚Äî";
    const inText = incoming.length ? incoming.map(e=>{
      const sign = e.sign>0 ? "‚Üë" : "‚Üì";
      return `${sign} –æ—Ç ${toName(e.from)}`;
    }).join(" ¬∑ ") : "‚Äî";

    return `–ò–∑—Ö–æ–¥—è—â–∏: ${outText}\n–í—Ö–æ–¥—è—â–∏: ${inText}`;
  }

  function openModal(id){
    const c = centers.find(x=>x.id===id);
    const d = info[id];

    $("#modalTitle").textContent = `${c.name} ¬∑ ${c.long}`;
    $("#modalSub").textContent = c.short;
    $("#modalFunctions").innerHTML = d.functions.map(x=>`<li>${x}</li>`).join("");
    $("#modalMarkers").innerHTML = d.markers.map(x=>`<li>${x}</li>`).join("");
    $("#modalCors").textContent = edgeSummaryFor(id);

    const age = demo.ageYears;
    const sex = sexLabel();
    const ageNote = age < 25
      ? "–ø–æ–¥ 25 –≥.: –ª–µ–∫–æ –ø–æ-—Å–ª–∞–± –∫–æ–Ω—Ç—Ä–æ–ª‚Üí–∞–ª–∞—Ä–º–∞ –∏ –ª–µ–∫–æ –ø–æ-—Å–∏–ª–Ω–∏ –∑–∞—â–∏—Ç–Ω–∏ –≤—Ä—ä–∑–∫–∏ (—Å–∞–º–æ –≤ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ)"
      : "–≤—ä–∑—Ä–∞—Å—Ç–µ–Ω —Ä–µ–∂–∏–º: –¥–µ–º–æ–≥—Ä–∞—Ñ—Å–∫–∏—è—Ç –µ—Ñ–µ–∫—Ç –µ –º–∏–Ω–∏–º–∞–ª–µ–Ω";
    $("#modalDemo").textContent = `–í—ä–∑—Ä–∞—Å—Ç: ${age} –≥. | –ü–æ–ª: ${sex}. –ï—Ñ–µ–∫—Ç: ${ageNote}.`;

    lastFocus = document.activeElement;
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
    modalClose.focus();
  }
  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
    if (lastFocus) lastFocus.focus();
  }
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalBackdrop.style.display === "flex") closeModal(); });

  // ===== Test (–Ω–µ—É—Ç—Ä–∞–ª–Ω–∞ A/B —Å–∫–∞–ª–∞ + –æ–±—ä—Ä–Ω–∞—Ç–æ –∫–æ–¥–∏—Ä–∞–Ω–µ) =====
  const likertMap = { 1:20, 2:40, 3:60, 4:80, 5:95 };

  function mapLikertTo0100(ans, reverse){
    const a = reverse ? (6 - ans) : ans;   // –æ–±—Ä—ä—â–∞–Ω–µ
    return likertMap[a];
  }

  // –ù–µ—É—Ç—Ä–∞–ª–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏: A –∏ B –∑–≤—É—á–∞—Ç –Ω–æ—Ä–º–∞–ª–Ω–æ; —á–∞—Å—Ç —Å–∞ —Å reverse:true
  const testItems = [
    { id:"dlpfc", reverse:false,
      title:"–ö–æ–≥–∞—Ç–æ –∏–º–∞ –º–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è/–¥–µ—Ç–∞–π–ª–∏ –Ω–∞–≤–µ–¥–Ω—ä–∂, –ø—Ä–∏ –º–µ–Ω –ø–æ-—á–µ—Å—Ç–æ: A) –æ–ø—Ä–æ—Å—Ç—è–≤–∞–º –∏ –≥—É–±—è —á–∞—Å—Ç –æ—Ç –Ω–∏—à–∫–∞—Ç–∞, B) –¥—ä—Ä–∂–∞ –≥–∏ –µ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ —Ä–∞–±–æ—Ç—è —Å—Ç—ä–ø–∫–æ–≤–æ.",
      hint:"–ê–Ω–∞–ª–∏–∑/—Ä–∞–±–æ—Ç–Ω–∞ –ø–∞–º–µ—Ç (DLPFC)." },

    { id:"par", reverse:true,
      title:"–ö–æ–≥–∞—Ç–æ –Ω—è–º–∞ –≥–æ—Ç–æ–≤ –ø—Ä–∏–º–µ—Ä, –ø–æ-—á–µ—Å—Ç–æ: A) —Å—Ç—Ä–æ—è –º–æ–¥–µ–ª –æ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∏/–≤—Ä—ä–∑–∫–∏, B) –º–∏ —Ç—Ä—è–±–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –∏ –ø—Ä–∏–º–µ—Ä.",
      hint:"–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è/–º–æ–¥–µ–ª–∏ (–ø–∞—Ä–∏–µ—Ç–∞–ª–Ω–∞ –∫–æ—Ä–∞). (–æ–±—ä—Ä–Ω–∞—Ç–æ –∫–æ–¥–∏—Ä–∞–Ω–µ)" },

    { id:"acc", reverse:false,
      title:"–ö–æ–≥–∞—Ç–æ –Ω–µ—â–æ –Ω–µ —Ä–∞–±–æ—Ç–∏, –ø–æ-—á–µ—Å—Ç–æ: A) –ø–æ–≤—Ç–∞—Ä—è–º —Å—ä—â–æ—Ç–æ (–æ—â–µ –Ω–∞—Ç–∏—Å–∫), B) —Å–ø–∏—Ä–∞–º, –Ω–∞–º–∏—Ä–∞–º –≥—Ä–µ—à–∫–∞—Ç–∞ –∏ —Å–º–µ–Ω—è–º –ø–æ–¥—Ö–æ–¥–∞.",
      hint:"–°–∞–º–æ–∫–æ—Ä–µ–∫—Ü–∏—è/–∫–æ–Ω—Ç—Ä–æ–ª (ACC)." },

    { id:"ofc", reverse:true,
      title:"–í –Ω–∞–ø—Ä–µ–≥–Ω–∞—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä, –ø–æ-—á–µ—Å—Ç–æ: A) –ø—Ä–∞–≤—è –ø–∞—É–∑–∞ –∏ –ø—Ä–µ—Ü–µ–Ω—è–≤–∞–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ç–∞, B) –∫–∞–∑–≤–∞–º –ø—ä—Ä–≤–æ—Ç–æ, –∫–æ–µ—Ç–æ –∏–¥–≤–∞.",
      hint:"–ü–æ—Å–ª–µ–¥–∏—Ü–∏/—Å–æ—Ü–∏–∞–ª–Ω–∞ –∫–∞–ª–∏–±—Ä–∞—Ü–∏—è (OFC). (–æ–±—ä—Ä–Ω–∞—Ç–æ –∫–æ–¥–∏—Ä–∞–Ω–µ)" },

    { id:"vmpfc", reverse:false,
      title:"–ü—Ä–∏ –∏–∑–±–æ—Ä –º–µ–∂–¥—É ‚Äû–±—ä—Ä–∑–∞ –ø–æ–ª–∑–∞‚Äú –∏ ‚Äû–≤—ä—Ç—Ä–µ—à–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç‚Äú, –ø–æ-—á–µ—Å—Ç–æ: A) –≤–æ–¥–∏ –º–µ –º–æ–º–µ–Ω—Ç–Ω–∞—Ç–∞ –ø–æ–ª–∑–∞/–Ω–∞—Ç–∏—Å–∫—ä—Ç, B) –≤–æ–¥–∏ –º–µ –≤—ä—Ç—Ä–µ—à–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç/—Å–º–∏—Å—ä–ª.",
      hint:"–°–º–∏—Å—ä–ª/—Å—Ç–æ–π–Ω–æ—Å—Ç (VMPFC)." },

    { id:"hippo", reverse:false,
      title:"–ö–æ–≥–∞—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è—Ç–∞ –µ –ø–æ–¥–æ–±–Ω–∞ –Ω–∞ –º–∏–Ω–∞–ª–∏ —Å–ª—É—á–∞–∏, –ø–æ-—á–µ—Å—Ç–æ: A) —Ä–µ–∞–≥–∏—Ä–∞–º –∫–∞—Ç–æ —á–µ –µ –Ω–æ–≤–∞, B) —Å–≤—ä—Ä–∑–≤–∞–º —Å –æ–ø–∏—Ç –∏ –∫–æ—Ä–∏–≥–∏—Ä–∞–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç.",
      hint:"–ö–æ–Ω—Ç–µ–∫—Å—Ç/–ø–∞–º–µ—Ç (—Ö–∏–ø–æ–∫–∞–º–ø)." },

    { id:"insula", reverse:false,
      title:"–ü—Ä–∏ –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ —Ç–µ–ª–µ—Å–Ω–∏—Ç–µ —Å–∏–≥–Ω–∞–ª–∏ (—Å—Ç—è–≥–∞–Ω–µ, –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç) –ø–æ-—á–µ—Å—Ç–æ: A) —Å–∞ —Å–ª–∞–±–∏/–Ω–∞ –∑–∞–¥–µ–Ω –ø–ª–∞–Ω, B) —Å–∞ —è—Å–Ω–∏ –∏ –≤–ª–∏—è—è—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏—è—Ç–∞.",
      hint:"–¢–µ–ª–µ—Å–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏ (–∏–Ω—Å—É–ª–∞)." },

    { id:"amyg", reverse:false,
      title:"–ü—Ä–∏ –∫—Ä–∏—Ç–∏–∫–∞/–∫–æ–Ω—Ñ–ª–∏–∫—Ç, –ø–æ-—á–µ—Å—Ç–æ: A) –ø—ä—Ä–≤–æ –º–∏—Å–ª—è, –ø–æ—Å–ª–µ —Å–µ –∞–∫—Ç–∏–≤–∏—Ä–∞–º, B) –ø—ä—Ä–≤–æ —Å–µ –∞–∫—Ç–∏–≤–∏—Ä–∞–º, –ø–æ—Å–ª–µ –º–∏—Å–ª—è.",
      hint:"–ê–ª–∞—Ä–º–µ–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç (–∞–º–∏–≥–¥–∞–ª–∞)." },

    { id:"hyp", reverse:false,
      title:"–ü—Ä–∏ –Ω–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ, –ø–æ-—á–µ—Å—Ç–æ: A) —Ç—è–ª–æ—Ç–æ –æ—Å—Ç–∞–≤–∞ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ, B) —Ç—è–ª–æ—Ç–æ –≤–ª–∏–∑–∞ –≤ —Å—Ç—Ä–µ—Å (–ø—É–ª—Å, –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ, —Å—ä–Ω).",
      hint:"–ê–≤—Ç–æ–Ω–æ–º–µ–Ω —Å—Ç—Ä–µ—Å-–æ—Ç–≥–æ–≤–æ—Ä (—Ö–∏–ø–æ—Ç–∞–ª–∞–º—É—Å)." },

    { id:"pag", reverse:false,
      title:"–ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫/–∑–∞–ø–ª–∞—Ö–∞, –ø–æ-—á–µ—Å—Ç–æ: A) –∑–∞–±–∞–≤—è–º/–∑–∞–º—Ä—ä–∑–≤–∞–º/–æ—Ç—Ç–µ–≥–ª—è–º —Å–µ, B) –≤–∫–ª—é—á–≤–∞–º —Ç–≤—ä—Ä–¥–∞ –∑–∞—â–∏—Ç–∞/—Ä—è–∑—ä–∫ —Ç–æ–Ω/–µ—Å–∫–∞–ª–∞—Ü–∏—è.",
      hint:"–ó–∞—â–∏—Ç–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ (PAG)." },
  ];

  const testAnswers = {}; // id -> 1..5

  // –ù–µ–æ—Ü–µ–Ω—ä—á–Ω–∞ —Å–∫–∞–ª–∞: A‚ÜîB
  function likertLabel(v){
    if (v===1) return "1<br><span style='opacity:.72'>–ø–æ-—á–µ—Å—Ç–æ A</span>";
    if (v===2) return "2<br><span style='opacity:.72'>–ø–æ-—Å–∫–æ—Ä–æ A</span>";
    if (v===3) return "3<br><span style='opacity:.72'>—Å–º–µ—Å–µ–Ω–æ</span>";
    if (v===4) return "4<br><span style='opacity:.72'>–ø–æ-—Å–∫–æ—Ä–æ B</span>";
    return "5<br><span style='opacity:.72'>–ø–æ-—á–µ—Å—Ç–æ B</span>";
  }

  function renderTest(){
    const el = $("#testGrid");
    el.innerHTML = testItems.map((q, idx) => {
      const label = centers.find(c=>c.id===q.id)?.name || q.id;
      const rev = q.reverse ? " ¬∑ reverse" : "";
      return `
        <div class="q">
          <div class="qTop">
            <div>
              <div class="qTitle">${idx+1}. ${q.title}</div>
              <div class="qHint">${q.hint}</div>
            </div>
            <div class="qMeta">
              <div class="chip">${label} ‚Üí <span data-qval="${q.id}" style="opacity:.85">‚Äî</span>${rev}</div>
              <div class="chip">0‚Äì100: <span data-qscore="${q.id}" style="opacity:.85">‚Äî</span></div>
            </div>
          </div>
          <div class="likert" role="radiogroup" aria-label="–û—Ç–≥–æ–≤–æ—Ä –∑–∞ ${label}">
            ${[1,2,3,4,5].map(v => `
              <label class="opt" data-q="${q.id}" data-v="${v}">
                <input type="radio" name="q_${q.id}" value="${v}" />
                ${likertLabel(v)}
              </label>
            `).join("")}
          </div>
        </div>
      `;
    }).join("");

    el.querySelectorAll(".opt").forEach(opt => {
      opt.addEventListener("click", () => {
        const qid = opt.getAttribute("data-q");
        const v = Number(opt.getAttribute("data-v"));
        selectLikert(qid, v);
        updateTestStats();
        updateJsonPreview(true);
      });
    });
  }

  function selectLikert(qid, v){
    testAnswers[qid] = v;

    document.querySelectorAll(`.opt[data-q="${qid}"]`).forEach(x => x.setAttribute("data-on","0"));
    const chosen = document.querySelector(`.opt[data-q="${qid}"][data-v="${v}"]`);
    if (chosen) chosen.setAttribute("data-on","1");

    const qval = document.querySelector(`[data-qval="${qid}"]`);
    const qscore = document.querySelector(`[data-qscore="${qid}"]`);

    const qDef = testItems.find(t => t.id === qid);
    const mapped = (qDef && v) ? mapLikertTo0100(v, !!qDef.reverse) : null;

    if (qval) qval.textContent = v.toString();
    if (qscore) qscore.textContent = mapped !== null ? mapped.toString() : "‚Äî";
  }

  function answeredCount(){
    return testItems.reduce((acc, q) => acc + (testAnswers[q.id] ? 1 : 0), 0);
  }
  function reliabilityLabel(n){
    if (n <= 4) return "–Ω–∏—Å–∫–∞";
    if (n <= 7) return "—Å—Ä–µ–¥–Ω–∞";
    return "–≤–∏—Å–æ–∫–∞";
  }
  function updateTestStats(){
    const n = answeredCount();
    $("#answeredCount").textContent = n.toString();
    $("#testReliability").textContent = reliabilityLabel(n);
  }

  // ===== Apply / Clear test =====
  $("#btnApplyTest").addEventListener("click", () => {
    const next = { ...state };

    // –ü—ä—Ä–≤–æ: –ø—Ä–∏–ª–∞–≥–∞–º–µ –º–∞–ø–∏—Ä–∞–Ω–∏—è —Ä–µ–∑—É–ª—Ç–∞—Ç 0‚Äì100 –∑–∞ –≤—Å–µ–∫–∏ –æ—Ç–≥–æ–≤–æ—Ä–µ–Ω –≤—ä–ø—Ä–æ—Å
    testItems.forEach(q => {
      const ans = testAnswers[q.id];
      if (ans) next[q.id] = mapLikertTo0100(ans, !!q.reverse);
    });

    // –ü–æ—Å–ª–µ: –∞–∫–æ –∫–æ—Ä–µ–ª–∞—Ü–∏–∏—Ç–µ —Å–∞ –≤–∫–ª—é—á–µ–Ω–∏, —Ä–∞–∑–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–≤–∞–º–µ –ø—Ä–æ–º—è–Ω–∞—Ç–∞ –Ω–µ–ª–∏–Ω–µ–π–Ω–æ
    const before = { ...state };
    state = next;

    if (coupleToggle.checked){
      isApplying = true;
      for (const q of testItems){
        const ans = testAnswers[q.id];
        if (!ans) continue;
        const delta = state[q.id] - before[q.id];
        if (Math.abs(delta) > 1e-6) propagateChange(q.id, delta);
      }
      isApplying = false;
    }

    syncCardsUI();
    renderAll();
    updateJsonPreview(true);
  });

  $("#btnClearTest").addEventListener("click", () => {
    for (const q of testItems){
      delete testAnswers[q.id];
      document.querySelectorAll(`.opt[data-q="${q.id}"]`).forEach(x => x.setAttribute("data-on","0"));
      const qval = document.querySelector(`[data-qval="${q.id}"]`);
      const qscore = document.querySelector(`[data-qscore="${q.id}"]`);
      if (qval) qval.textContent = "‚Äî";
      if (qscore) qscore.textContent = "‚Äî";
    }
    updateTestStats();
    updateJsonPreview(true);
  });

  // ===== JSON export/import =====
  function nowIsoLocal(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function buildExportObject(){
    const p = idxPFC(), l = idxLimbic(), i = idxIntegr(), a = idxAbs();

    const mappedTest = {};
    const defs = {};
    for (const q of testItems){
      defs[q.id] = { reverse: !!q.reverse };
      const ans = testAnswers[q.id];
      if (ans){
        mappedTest[q.id] = {
          likert: ans,
          mapped_0_100: mapLikertTo0100(ans, !!q.reverse),
          reverse: !!q.reverse
        };
      }
    }

    return {
      meta: { version: MODEL_VERSION, exported_at_local: nowIsoLocal(), timezone_hint: TZ_HINT },
      demography: { age_years: demo.ageYears, sex_bio: demo.sexBio },
      settings: { correlations_enabled: !!coupleToggle.checked, correlations_strength: couplingStrength.value },
      state: { ...state },
      indices: {
        prefrontal_dominance: round1(p),
        limbic_reactivity: round1(l),
        integration: round1(i),
        abstraction: round1(a),
        balance_pfc_minus_limbic: round1(p - l)
      },
      test: {
        scale: "A_to_B_1-5",
        answered: answeredCount(),
        answers: { ...testAnswers },
        items: defs,
        mapped: mappedTest
      }
    };
  }

  function stringifyExport(pretty=true){
    return JSON.stringify(buildExportObject(), null, pretty ? 2 : 0);
  }

  function downloadJson(){
    const txt = stringifyExport(true);
    const blob = new Blob([txt], { type: "application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `nf_profile_${nowIsoLocal().replace(/[:]/g,"-")}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyJson(){
    await navigator.clipboard.writeText(stringifyExport(true));
  }

  function updateJsonPreview(force){
    if (!force && document.activeElement === jsonPreview) return;
    jsonPreview.value = stringifyExport(true);
  }

  function safeApplyImported(obj){
    let applied = 0;

    // demography
    if (obj?.demography){
      if (obj.demography.age_years !== undefined){
        const v = Number(obj.demography.age_years);
        if (Number.isFinite(v)){ demo.ageYears = clamp(v, 6, 110); $("#ageYears").value = demo.ageYears; applied++; }
      }
      if (obj.demography.sex_bio !== undefined){
        const s = String(obj.demography.sex_bio);
        if (["male","female","unspecified"].includes(s)){ demo.sexBio = s; $("#sexBio").value = s; applied++; }
      }
      updateDemoText();
    }

    // settings
    if (obj?.settings){
      if (typeof obj.settings.correlations_enabled === "boolean"){
        coupleToggle.checked = obj.settings.correlations_enabled; applied++;
      }
      if (typeof obj.settings.correlations_strength === "string"){
        const v = obj.settings.correlations_strength;
        if (["low","mid","high"].includes(v)){ couplingStrength.value = v; applied++; }
      }
    }

    // state
    if (obj?.state && typeof obj.state === "object"){
      for (const c of centers){
        if (obj.state[c.id] !== undefined){
          const v = Number(obj.state[c.id]);
          if (Number.isFinite(v)){ state[c.id] = clamp(v); applied++; }
        }
      }
    }

    // test answers (—Å–∞–º–æ 1‚Äì5; –Ω–µ —Ä–∞–∑—á–∏—Ç–∞–º–µ –Ω–∞ –∏–º–ø–æ—Ä—Ç–Ω–∞—Ç–∞ reverse –ª–æ–≥–∏–∫–∞ ‚Äî –∏–∑–ø–æ–ª–∑–≤–∞–º–µ –ª–æ–∫–∞–ª–Ω–∏—Ç–µ –¥–µ—Ñ–∏–Ω–∏—Ü–∏–∏)
    if (obj?.test?.answers && typeof obj.test.answers === "object"){
      for (const q of testItems){
        const v = obj.test.answers[q.id];
        if (v !== undefined){
          const n = Number(v);
          if ([1,2,3,4,5].includes(n)){
            testAnswers[q.id] = n;
            selectLikert(q.id, n);
            applied++;
          }
        }
      }
    }

    updateTestStats();
    syncCardsUI();
    renderAll();
    updateJsonPreview(true);

    return applied;
  }

  async function importFromText(txt){
    try{
      const obj = JSON.parse(txt);
      const applied = safeApplyImported(obj);
      importStatus.textContent = `–ò–º–ø–æ—Ä—Ç: OK ¬∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏ –ø–æ–ª–µ—Ç–∞: ${applied}`;
    }catch{
      importStatus.textContent = `–ò–º–ø–æ—Ä—Ç: –ù–ï–£–°–ü–ï–®–ï–ù ¬∑ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω JSON`;
    }
  }

  importFile.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    await importFromText(await f.text());
    importFile.value = "";
  });

  $("#btnDownloadJson").addEventListener("click", downloadJson);
  $("#btnDownloadJson2").addEventListener("click", downloadJson);

  $("#btnCopyJson").addEventListener("click", async () => {
    try{ await copyJson(); importStatus.textContent = "JSON: –∫–æ–ø–∏—Ä–∞–Ω –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞"; }
    catch{ importStatus.textContent = "JSON: –Ω–µ—É—Å–ø–µ—à–Ω–æ –∫–æ–ø–∏—Ä–∞–Ω–µ (–±—Ä–∞—É–∑—ä—Ä/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)"; }
  });

  $("#btnRefreshJson").addEventListener("click", () => updateJsonPreview(true));

  $("#btnPasteImport").addEventListener("click", async () => {
    try{
      const txt = await navigator.clipboard.readText();
      if (!txt || txt.trim().length < 2){ importStatus.textContent = "–ò–º–ø–æ—Ä—Ç –æ—Ç –∫–ª–∏–ø–±–æ—Ä–¥–∞: –ø—Ä–∞–∑–Ω–æ"; return; }
      await importFromText(txt);
    }catch{
      importStatus.textContent = "–ò–º–ø–æ—Ä—Ç –æ—Ç –∫–ª–∏–ø–±–æ—Ä–¥–∞: –Ω–µ—É—Å–ø–µ—à–µ–Ω (–±—Ä–∞—É–∑—ä—Ä/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)";
    }
  });

  // ===== Header buttons / resets =====
  $("#btnResetYou").addEventListener("click", () => {
    state = { ...defaultYou };
    syncCardsUI();
    renderAll();
    updateJsonPreview(true);
  });
  $("#btnResetNeutral").addEventListener("click", () => {
    state = { ...defaultNeutral };
    syncCardsUI();
    renderAll();
    updateJsonPreview(true);
  });

  coupleToggle.addEventListener("change", () => updateJsonPreview(true));
  couplingStrength.addEventListener("change", () => updateJsonPreview(true));

  // ===== Demography listeners =====
  $("#ageYears").addEventListener("change", setDemoFromInputs);
  $("#sexBio").addEventListener("change", setDemoFromInputs);

  // ===== Init =====
  buildCards();
  renderTest();
  updateTestStats();
  syncCardsUI();
  updateDemoText();
  renderAll();
  updateJsonPreview(true);

  window.addEventListener("resize", () => renderAll());

})();
</script>
</body>
</html>
