<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вашият Ирисологичен Доклад - Iris-Holistica AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <section class="analysis-section">
            <header class="report-header">
                <h2 class="fade-in-up">Вашият Ирисологичен Доклад</h2>
                <p class="fade-in-up delay-1">Този анализ е генериран на базата на предоставената от вас информация и снимки.</p>
            </header>

            <!-- Контейнерът за доклада -->
            <div id="report-card" class="card fade-in-up delay-2">
                <!-- Скриптът ще попълни съдържанието тук -->
            </div>

            <!-- Контейнер за съобщения (грешки, зареждане) -->
            <div id="message-box"></div>
            
    <div class="button-group" style="margin-top: 2rem; text-align: center;">
        <a href="index.html" class="cta-button fade-in-up delay-3">Връщане към началната страница</a>
    </div>
</section>
</div>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const reportCard = document.getElementById('report-card');
    const messageBox = document.getElementById('message-box');

    // Показване на съобщение за зареждане, докато се обработват данните
    reportCard.innerHTML = `<div class="loading-box"><i class="fas fa-spinner fa-spin"></i> Генериране на доклада...</div>`;

    // Дефинираме конфигурация за всяка секция от доклада
    // Това прави кода по-лесен за поддръжка и превод
    const reportSectionsConfig = {
        "summary": { title: "Общо Резюме", icon: "fa-heart-pulse" },
        "constitution": { title: "Конституционални Характеристики", icon: "fa-shield-halved" },
        "dispositions": { title: "Предразположения и Тенденции", icon: "fa-chart-line" },
        "signs": { title: "Конкретни Наблюдавани Знаци", icon: "fa-magnifying-glass-chart" },
        "recommendations": { title: "Препоръки за Баланс и Профилактика", icon: "fa-seedling" },
        "holistic_analysis": { title: "Холистичен Анализ", icon: "fa-brain", collapsible: true }
    };

    // Обвиваме логиката в setTimeout, за да позволим на анимациите да се покажат
    setTimeout(() => {
        try {
            const rawData = localStorage.getItem('iridologyReport');
            if (!rawData) {
                throw new Error('Няма налични данни за анализ. Моля, върнете се на началната страница и попълнете формата.');
            }
            const data = JSON.parse(rawData);

            // Изчистваме съобщението за зареждане
            reportCard.innerHTML = '';
            let disclaimer = '';

            // Обхождаме конфигурацията, за да подредим секциите в правилния ред
            Object.keys(reportSectionsConfig).forEach(key => {
                const value = data[key];
                if (!value) return; // Ако AI не е върнал такъв ключ, пропускаме го

                // Проверяваме дали стойността съдържа дисклеймъра и я отделяме
                if (typeof value === 'string' && value.includes("Важно:")) {
                    disclaimer = value;
                    return; // Не го рендираме като нормална секция
                }

                const config = reportSectionsConfig[key];
                const wrapper = config.collapsible ? document.createElement('details') : document.createElement('div');
                wrapper.className = 'report-section';

                let contentContainer = wrapper;
                if (config.collapsible) {
                    const summary = document.createElement('summary');
                    summary.innerHTML = `<i class="fas ${config.icon}"></i> ${config.title}`;
                    wrapper.appendChild(summary);
                    contentContainer = document.createElement('div');
                    wrapper.appendChild(contentContainer);
                } else {
                    const titleEl = document.createElement('h3');
                    titleEl.innerHTML = `<i class="fas ${config.icon}"></i> ${config.title}`;
                    wrapper.appendChild(titleEl);
                }

                // **КЛЮЧОВО ПОДОБРЕНИЕ:** Правилно обработваме масиви и низове
                if (Array.isArray(value)) {
                    const listEl = document.createElement('ul');
                    value.forEach(item => {
                        const listItemEl = document.createElement('li');
                        const iconEl = document.createElement('i');
                        iconEl.className = 'fas fa-check-circle';
                        const spanEl = document.createElement('span');
                        const text = typeof item === 'object' ? (item.text || item.content || '') : item;
                        spanEl.textContent = DOMPurify.sanitize(text);
                        listItemEl.appendChild(iconEl);
                        listItemEl.appendChild(spanEl);

                        if (typeof item === 'object' && item.source) {
                            const sourceEl = document.createElement('p');
                            sourceEl.className = 'item-source';
                            sourceEl.textContent = `Източник: ${DOMPurify.sanitize(item.source)}`;
                            listItemEl.appendChild(sourceEl);
                        }

                        listEl.appendChild(listItemEl);
                    });
                    contentContainer.appendChild(listEl);
                } else if (typeof value === 'object') {
                    const contentEl = document.createElement('p');
                    contentEl.textContent = DOMPurify.sanitize(value.text || value.content || '');
                    contentContainer.appendChild(contentEl);
                    if (value.source) {
                        const sourceEl = document.createElement('p');
                        sourceEl.className = 'item-source';
                        sourceEl.textContent = `Източник: ${DOMPurify.sanitize(value.source)}`;
                        contentContainer.appendChild(sourceEl);
                    }
                } else if (typeof value === 'string') {
                    const contentEl = document.createElement('p');
                    contentEl.textContent = value;
                    contentContainer.appendChild(contentEl);
                }

                reportCard.appendChild(wrapper);
            });

            // Добавяме дисклеймъра накрая в специален стил
            if (disclaimer) {
                const disclaimerEl = document.createElement('div');
                disclaimerEl.className = 'report-disclaimer';
                const iconEl = document.createElement('i');
                iconEl.className = 'fas fa-info-circle';
                const pEl = document.createElement('p');
                pEl.textContent = DOMPurify.sanitize(disclaimer);
                disclaimerEl.appendChild(iconEl);
                disclaimerEl.appendChild(pEl);
                reportCard.appendChild(disclaimerEl);
            }

        } catch (err) {
            reportCard.style.display = 'none';
            messageBox.textContent = 'Грешка: ' + err.message;
            messageBox.className = 'error-box';
        }
    }, 500); // 0.5 секунди закъснение
});
</script>
</body>
</html>
