<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вашият Ирисологичен Доклад - Iris-Holistica AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Добавяме малко вграден стил, за да обогатим визията без да променяме style.css -->
    <style>
        .report-card-container { padding: 0; border: none; overflow: hidden; }
        .report-header-section { background-color: #f8f9fa; padding: 1.5rem; text-align: center; border-bottom: 1px solid #e9ecef; }
        .report-header-section h3 { margin-bottom: 0.5rem; font-size: 1.5rem; }
        .report-header-section p { color: #6c757d; margin: 0; }
        .report-body { padding: 1.5rem; }
        .report-section-interactive { margin-bottom: 1rem; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden; }
        .report-section-interactive summary { display: flex; align-items: center; padding: 1rem; background-color: #fff; cursor: pointer; font-weight: 600; outline: none; transition: background-color 0.2s; }
        .report-section-interactive summary:hover { background-color: #f8f9fa; }
        .report-section-interactive summary .section-icon { margin-right: 1rem; font-size: 1.5rem; color: #007bff; width: 30px; text-align: center; }
        .report-section-interactive[open] > summary { border-bottom: 1px solid #e9ecef; }
        .report-section-content { padding: 1.5rem; background-color: #fff; }
        .two-column-grid { display: flex; gap: 2rem; flex-wrap: wrap; }
        .two-column-grid > div { flex: 1; min-width: 250px; }
        .two-column-grid h4 { border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; margin-top: 0; display: flex; align-items: center; }
        .two-column-grid h4 .fas { margin-right: 0.5rem; }
        .priority-list-item { background-color: #f8f9fa; padding: 1rem; border-left: 4px solid #007bff; margin-bottom: 1rem; border-radius: 4px; }
        .priority-list-item h4 { font-size: 1.1rem; margin: 0 0 0.5rem 0; }
        .recommendation-subsection { margin-top: 1.5rem; }
        .recommendation-subsection h4 { color: #343a40; font-weight: 600; }
        .report-footer-disclaimer { padding: 1.5rem; background-color: #fef8e5; border-top: 1px solid #e9ecef; display: flex; align-items: center; gap: 1rem; }
        .report-footer-disclaimer .fas { font-size: 1.5rem; color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <section class="analysis-section">
            <header class="report-header">
                <h2 class="fade-in-up">Вашият Персонален Холистичен Доклад</h2>
                <p class="fade-in-up delay-1">Генериран от Iris-Holistica AI на базата на предоставената от вас информация.</p>
            </header>

            <!-- Основен контейнер за доклада -->
            <div id="report-container" class="fade-in-up delay-2">
                <!-- Скриптът ще попълни съдържанието тук -->
            </div>

            <!-- Контейнер за съобщения (грешки, зареждане) -->
            <div id="message-box"></div>
            
            <div class="button-group" style="margin-top: 2rem; text-align: center;">
                <button id="re-analyze-btn" class="cta-button fade-in-up delay-3" style="margin-right:1rem;">Повтори анализа</button>
                <a href="index.html" class="cta-button fade-in-up delay-3">Връщане към началната страница</a>
            </div>
        </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
    <script type="module">
        import { WORKER_URL } from './config.js';

        document.addEventListener('DOMContentLoaded', function () {
            const reportContainer = document.getElementById('report-container');
            const messageBox = document.getElementById('message-box');
            const reAnalyzeBtn = document.getElementById('re-analyze-btn');

            // --- Помощни функции за генериране на HTML елементи ---

            /**
             * Създава интерактивна (сгъваема) секция.
             * @param {string} title - Заглавие на секцията.
             * @param {string} iconClass - Font Awesome клас за иконата.
             * @param {boolean} isOpen - Дали секцията да е отворена по подразбиране.
             * @returns {{wrapper: HTMLElement, contentArea: HTMLElement}}
             */
            function createInteractiveSection(title, iconClass, isOpen = false) {
                const wrapper = document.createElement('details');
                wrapper.className = 'report-section-interactive';
                wrapper.open = isOpen;

                const summary = document.createElement('summary');
                summary.innerHTML = `
                    <i class="fas ${iconClass} section-icon"></i>
                    <span>${DOMPurify.sanitize(title)}</span>
                `;

                const contentArea = document.createElement('div');
                contentArea.className = 'report-section-content';

                wrapper.appendChild(summary);
                wrapper.appendChild(contentArea);
                return { wrapper, contentArea };
            }

            /**
             * Основна функция за рендиране на целия доклад.
             * @param {object} data - Обект с данните от анализа.
             */
            function renderReport(data) {
                reportContainer.innerHTML = ''; // Изчистваме контейнера
                const card = document.createElement('div');
                card.className = 'card report-card-container';

                // 1. Хедър на доклада (Име и дата)
                const reportHeader = document.createElement('header');
                reportHeader.className = 'report-header-section';
                const date = new Date().toLocaleDateString('bg-BG', { day: '2-digit', month: 'long', year: 'numeric' });
                reportHeader.innerHTML = `
                    <h3>${DOMPurify.sanitize(data['Име'] || 'Анализ')}</h3>
                    <p>Дата на генериране: ${date}</p>
                `;
                card.appendChild(reportHeader);

                const reportBody = document.createElement('main');
                reportBody.className = 'report-body';

                // 2. Секция: Конституционален анализ (2 колони)
                const constitutionalKey = "Конституционален анализ";
                if (data[constitutionalKey]) {
                    const { wrapper, contentArea } = createInteractiveSection(constitutionalKey, 'fa-shield-halved', true); // Отворен по подразбиране
                    
                    const [colorType, structuralType] = data[constitutionalKey].split('. ');
                    
                    contentArea.innerHTML = `
                        <div class="two-column-grid">
                            <div>
                                <h4><i class="fas fa-palette"></i>Цветен тип</h4>
                                <p>${DOMPurify.sanitize(colorType || '')}</p>
                            </div>
                            <div>
                                <h4><i class="fas fa-sitemap"></i>Структурен тип</h4>
                                <p>${DOMPurify.sanitize(structuralType || '')}</p>
                            </div>
                        </div>
                    `;
                    reportBody.appendChild(wrapper);
                }

                // 3. Секция: Приоритетни системи за подкрепа
                const priorityKey = "Приоритетни системи за подкрепа";
                if (data[priorityKey]) {
                    const { wrapper, contentArea } = createInteractiveSection(priorityKey, 'fa-heart-pulse', true);
                    const systems = data[priorityKey].split(', ').map(s => s.trim());
                    
                    let systemsHTML = '';
                    systems.forEach(system => {
                        systemsHTML += `
                            <div class="priority-list-item">
                                <h4>${DOMPurify.sanitize(system)}</h4>
                                <p>Тази система показва признаци на натоварване и се нуждае от целенасочена подкрепа.</p>
                            </div>
                        `;
                    });
                    contentArea.innerHTML = systemsHTML;
                    reportBody.appendChild(wrapper);
                }

                // 4. Секция: Анализ на елиминативните канали
                const channelsKey = "Анализ на елиминативните канали";
                if (data[channelsKey]) {
                    const { wrapper, contentArea } = createInteractiveSection(channelsKey, 'fa-recycle');
                    contentArea.innerHTML = `<p>${DOMPurify.sanitize(data[channelsKey])}</p>`;
                    reportBody.appendChild(wrapper);
                }

                // 5. Секция: Ключови находки
                const findingsKey = "Ключови находки и тяхната връзка";
                if (data[findingsKey]) {
                    const { wrapper, contentArea } = createInteractiveSection(findingsKey, 'fa-magnifying-glass-chart');
                    contentArea.innerHTML = `<p>${DOMPurify.sanitize(data[findingsKey])}</p>`;
                    reportBody.appendChild(wrapper);
                }
                
                // 6. Секция: Холистични препоръки (с подсекции)
                const recommendationsKey = "Холистични препоръки";
                if (data[recommendationsKey] && typeof data[recommendationsKey] === 'object') {
                    const { wrapper, contentArea } = createInteractiveSection(recommendationsKey, 'fa-seedling');
                    Object.entries(data[recommendationsKey]).forEach(([subKey, subValue]) => {
                        if (subValue) {
                            const subSection = document.createElement('div');
                            subSection.className = 'recommendation-subsection';
                            subSection.innerHTML = `
                                <h4>${DOMPurify.sanitize(subKey)}</h4>
                                <p>${DOMPurify.sanitize(subValue)}</p>
                            `;
                            contentArea.appendChild(subSection);
                        }
                    });
                    reportBody.appendChild(wrapper);
                }

                card.appendChild(reportBody);

                // 7. Футър на доклада (Отказ от отговорност)
                const disclaimerKey = "Задължителен отказ от отговорност";
                if (data[disclaimerKey]) {
                    const reportFooter = document.createElement('footer');
                    reportFooter.className = 'report-footer-disclaimer';
                    reportFooter.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p><strong>Важно:</strong> ${DOMPurify.sanitize(data[disclaimerKey])}</p>
                    `;
                    card.appendChild(reportFooter);
                }

                reportContainer.appendChild(card);
            }

            // --- Основна логика за зареждане ---
            reportContainer.innerHTML = `<div class="loading-box"><i class="fas fa-spinner fa-spin"></i> Генериране на доклада...</div>`;

            setTimeout(() => {
                try {
                    const rawData = localStorage.getItem('iridologyReport');
                    if (!rawData) {
                        throw new Error('Няма налични данни за анализ. Моля, върнете се на началната страница и попълнете формата.');
                    }
                    const data = JSON.parse(rawData);
                    
                    // Преименуваме ключа, за да е по-кратък
                    if (data["Име на пациента"]) {
                        data["Име"] = data["Име на пациента"];
                        delete data["Име на пациента"];
                    }
                    
                    renderReport(data);

                } catch (err) {
                    reportContainer.style.display = 'none';
                    messageBox.textContent = 'Грешка: ' + err.message;
                    messageBox.className = 'error-box';
                }
            }, 500);

            // --- Логика за бутона "Повтори анализа" (остава непроменена) ---
             if (reAnalyzeBtn) {
                reAnalyzeBtn.addEventListener('click', async () => {
                    reAnalyzeBtn.disabled = true;
                    if (messageBox) {
                        messageBox.textContent = '';
                        messageBox.className = '';
                    }

                    const stored = localStorage.getItem('iridologyFormData');
                    if (!stored) {
                        messageBox.textContent = 'Липсват данни за повторен анализ.';
                        messageBox.className = 'error-box';
                        reAnalyzeBtn.disabled = false;
                        return;
                    }
                    
                    const formData = new FormData();
                    const obj = JSON.parse(stored);
                    for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'string' && value.startsWith('data:')) {
                            const [header, data] = value.split(',');
                            const mime = header.match(/:(.*?);/)[1];
                            const binary = atob(data);
                            const array = new Uint8Array(binary.length);
                            for(let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
                            formData.append(key, new Blob([array], {type: mime}), `${key.replace('-upload', '')}.png`);
                        } else {
                            formData.append(key, value);
                        }
                    }

                    const progressMessages = [ 'Изпращане на данни...', 'AI анализира изображенията...', 'Синтезиране на холистичен доклад...', 'Финализиране...' ];
                    let msgIndex = 0;
                    let interval;
                    let spinner;
                    let textNode;

                    if (messageBox) {
                        messageBox.className = 'info-box';
                        spinner = document.createElement('i');
                        spinner.className = 'loading-spinner fas fa-spinner fa-spin';
                        textNode = document.createTextNode(progressMessages[msgIndex]);
                        messageBox.textContent = '';
                        messageBox.appendChild(spinner);
                        messageBox.appendChild(textNode);
                        interval = setInterval(() => {
                            msgIndex = (msgIndex + 1) % progressMessages.length;
                            textNode.textContent = progressMessages[msgIndex];
                        }, 4000);
                    }

                    try {
                        const response = await fetch(WORKER_URL, { method: 'POST', body: formData });
                        if (!response.ok) {
                             const errData = await response.json().catch(() => ({ error: `Грешка от сървъра: ${response.status}` }));
                             throw new Error(errData.error);
                        }
                        const data = await response.json();
                        if (interval) clearInterval(interval);
                        if (spinner) spinner.remove();
                        localStorage.setItem('iridologyReport', JSON.stringify(data));
                        reAnalyzeBtn.disabled = false;
                        location.reload();
                    } catch (err) {
                        if (interval) clearInterval(interval);
                        if (spinner) spinner.remove();
                        messageBox.textContent = 'Възникна грешка: ' + err.message;
                        messageBox.className = 'error-box';
                        reAnalyzeBtn.disabled = false;
                    }
                });
            }
        });
    </script>
</body>
</html>
