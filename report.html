<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вашият Холистичен Доклад - Iris-Holistica AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="report-container">
        
        <header class="report-main-header">
            <div class="logo">Iris-Holistica AI</div>
            <h1>Вашият Холистичен Анализ</h1>
            <p>Генериран на <span id="generation-date"></span></p>
        </header>

        <!-- Контейнер за грешки и зареждане -->
        <div id="message-box" class="card"></div>

        <main id="report-content">
            
            <!-- Профилната карта е преместена тук за мобилен изглед -->
            <div id="profile-card" class="card">
                <h3><i class="fas fa-user-circle"></i> Профил</h3>
                <!-- JS ще попълни данните тук -->
            </div>

            <!-- Картата с акценти е преместена тук -->
            <div id="summary-card" class="card">
                 <h3><i class="fas fa-star"></i> Ключови Акценти</h3>
                <div id="summary-constitution"></div>
                <div id="summary-priority"></div>
            </div>

            <!-- Контейнерът за пълния доклад -->
            <div id="full-report-container">
                <!-- JS ще попълни секциите тук -->
            </div>
            
            <!-- Задължителен отказ от отговорност -->
            <div id="disclaimer-container" class="report-disclaimer">
                 <!-- JS ще попълни тук -->
            </div>

        </main>

        <!-- "Залепени" бутони за действие за мобилни устройства -->
        <footer class="report-actions-footer">
            <div class="report-actions">
                <button id="print-btn" class="action-button"><i class="fas fa-print"></i> <span>Принтирай / PDF</span></button>
                <a href="index.html" class="action-button"><i class="fas fa-home"></i> <span>Нов Анализ</span></a>
            </div>
        </footer>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
    <script type="module">
        // JavaScript кодът остава същият като в предишния отговор,
        // тъй като той е независим от визуалната подредба.
        // Просто го копирайте тук.
        document.addEventListener('DOMContentLoaded', function () {
            const reportContent = document.getElementById('report-content');
            const messageBox = document.getElementById('message-box');
            const printBtn = document.getElementById('print-btn');
            const actionsFooter = document.querySelector('.report-actions-footer');
            
            // Скриваме основното съдържание докато не сме готови
            reportContent.style.display = 'none';
            actionsFooter.style.display = 'none';
            messageBox.innerHTML = `<div class="loading-box"><i class="fas fa-spinner fa-spin"></i> Генериране на доклада...</div>`;
            messageBox.style.display = 'block';

            document.getElementById('generation-date').textContent = new Date().toLocaleDateString('bg-BG', { day: '2-digit', month: 'long', year: 'numeric' });

            setTimeout(() => {
                try {
                    const rawData = localStorage.getItem('iridologyReport');
                    if (!rawData) {
                        throw new Error('Няма налични данни за анализ. Моля, върнете се на началната страница и попълнете формата.');
                    }
                    const data = JSON.parse(rawData);

                    renderProfileCard(data);
                    renderSummaryCard(data);
                    renderFullReport(data);

                    // Показваме съдържанието и скриваме съобщението
                    reportContent.style.display = 'block';
                    actionsFooter.style.display = 'block';
                    messageBox.style.display = 'none';

                } catch (err) {
                    reportContent.style.display = 'none';
                    actionsFooter.style.display = 'none';
                    messageBox.innerHTML = `<strong>Грешка:</strong> ${err.message}`;
                    messageBox.className = 'error-box card';
                    messageBox.style.display = 'block';
                }
            }, 500);

            if (printBtn) {
                printBtn.addEventListener('click', () => window.print());
            }
        });

        function renderProfileCard(data) {
            const container = document.getElementById('profile-card');
            const rawForm = localStorage.getItem('iridologyFormData');
            if(!rawForm) return;

            const formData = JSON.parse(rawForm);
            
            const list = document.createElement('ul');
            list.innerHTML = `
                <li><strong>Име:</strong> ${DOMPurify.sanitize(data["Име на пациента"] || 'Няма данни')}</li>
                <li><strong>Възраст:</strong> ${DOMPurify.sanitize(formData.age || 'Няма данни')}</li>
                <li><strong>Пол:</strong> ${DOMPurify.sanitize(formData.gender || 'Няма данни')}</li>
            `;
            container.appendChild(list);
        }

        function renderSummaryCard(data){
            const constitutionContainer = document.getElementById('summary-constitution');
            const priorityContainer = document.getElementById('summary-priority');

            if(data["Конституционален анализ"]){
                constitutionContainer.innerHTML = `
                    <h4>Конституционален анализ</h4>
                    <p>${DOMPurify.sanitize(data["Конституционален анализ"])}</p>
                `;
            }
            if(data["Приоритетни системи за подкрепа"]){
                priorityContainer.innerHTML = `
                    <h4>Приоритетни системи</h4>
                    <p>${DOMPurify.sanitize(data["Приоритетни системи за подкрепа"])}</p>
                `;
            }
        }

        function renderFullReport(data) {
            const container = document.getElementById('full-report-container');
            container.innerHTML = ''; // Изчистваме

            const sectionOrder = [
                "Анализ на елиминативните канали",
                "Ключови находки и тяхната връзка",
                "Холистични препоръки",
            ];

            const icons = {
                "Анализ на елиминативните канали": "fa-recycle",
                "Ключови находки и тяхната връзка": "fa-magnifying-glass-chart",
                "Холистични препоръки": "fa-seedling",
            };

            sectionOrder.forEach(key => {
                const value = data[key];
                if (!value) return;

                const details = document.createElement('details');
                details.className = 'card report-section';
                if (key === sectionOrder[0]) {
                    details.open = true;
                }

                const summary = document.createElement('summary');
                summary.innerHTML = `<h3><i class="fas ${icons[key] || 'fa-circle-info'}"></i> ${DOMPurify.sanitize(key)}</h3>`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'section-content';

                if (key === "Анализ на елиминативните канали") {
                    contentDiv.appendChild(createChannelsGraphic(value));
                } else if (key === "Холистични препоръки" && typeof value === 'object') {
                    Object.keys(value).forEach(subKey => {
                        const subValue = value[subKey];
                        if(subValue) {
                            const subWrapper = document.createElement('div');
                            subWrapper.className = 'recommendation-subsection';
                            subWrapper.innerHTML = `
                                <h4>${DOMPurify.sanitize(subKey)}</h4>
                                <p>${DOMPurify.sanitize(subValue)}</p>
                            `;
                            contentDiv.appendChild(subWrapper);
                        }
                    });
                } else {
                    contentDiv.innerHTML = `<p>${DOMPurify.sanitize(value)}</p>`;
                }

                details.appendChild(summary);
                details.appendChild(contentDiv);
                container.appendChild(details);
            });

            const disclaimerContainer = document.getElementById('disclaimer-container');
            if (data["Задължителен отказ от отговорност"]) {
                disclaimerContainer.innerHTML = `<i class="fas fa-info-circle"></i><p>${DOMPurify.sanitize(data["Задължителен отказ от отговорност"])}</p>`;
            }
        }

        function createChannelsGraphic(textValue) {
            const wrapper = document.createElement('div');
            wrapper.className = 'channels-visual-container';
            
            const intro = document.createElement('p');
            intro.textContent = DOMPurify.sanitize(textValue);
            wrapper.appendChild(intro);

            const grid = document.createElement('div');
            grid.className = 'channels-grid';

            const channels = ["Черва", "Бъбреци", "Лимфа", "Кожа", "Бели дробове"];
            const keywords = {
                high: ['най-натоварени', 'силно натоварени', 'сериозно затруднени', 'значително натоварване'],
                medium: ['натоварени', 'затруднени', 'показват натоварване', 'умерено натоварване'],
                low: ['балансирани', 'в добро състояние', 'без особени признаци', 'слабо натоварване']
            };

            channels.forEach(channel => {
                let loadLevel = 'unknown';
                const lowerText = textValue.toLowerCase();
                const lowerChannel = channel.toLowerCase();

                if (keywords.high.some(k => lowerText.includes(k) && lowerText.includes(lowerChannel))) {
                    loadLevel = 'high';
                } else if (keywords.medium.some(k => lowerText.includes(k) && lowerText.includes(lowerChannel))) {
                    loadLevel = 'medium';
                } else if (keywords.low.some(k => lowerText.includes(k) && lowerText.includes(lowerChannel))) {
                    loadLevel = 'low';
                }
                
                const item = document.createElement('div');
                item.className = 'channel-item';
                item.innerHTML = `
                    <span class="channel-name">${channel}</span>
                    <div class="channel-bar-container">
                        <div class="channel-bar load-${loadLevel}"></div>
                    </div>
                `;
                grid.appendChild(item);
            });
            
            wrapper.appendChild(grid);
            return wrapper;
        }
    </script>
</body>
</html>
