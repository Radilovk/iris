<!doctype html>
<html lang="bg">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>–í–∞—à–∏—è—Ç –ò—Ä–∏—Å–æ–ª–æ–≥–∏—á–µ–Ω –î–æ–∫–ª–∞–¥ - Iris-Holistica AI</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        />
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

        <!-- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ —Å—Ç–∏–ª–æ–≤–µ –°–ê–ú–û –∑–∞ —Ç–∞–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <style>
            :root {
                /* –î–µ—Ñ–∏–Ω–∏—Ä–∞–º–µ —Ü–≤–µ—Ç–æ–≤–µ —Ç—É–∫, –∑–∞ –¥–∞ —Å–∞ –¥–æ—Å—Ç—ä–ø–Ω–∏ */
                --white: #ffffff;
                --gradient: linear-gradient(135deg, #437dcb 0%, #2e5a9b 100%);
                
                /* Status colors for mobile metric cards */
                --status-critical-bg: rgba(239, 68, 68, 0.85);
                --status-critical-color: #dc2626;
                --status-high-bg: rgba(251, 191, 36, 0.85);
                --status-high-color: #f59e0b;
                --status-medium-bg: rgba(52, 211, 153, 0.85);
                --status-medium-color: #10b981;
                --status-low-bg: rgba(52, 211, 153, 0.85);
                --status-low-color: #28a745;
            }

            body {
                background: var(--gradient);
            }

            .report-header {
                text-align: center;
                margin-bottom: 2rem;
            }
            .report-header h2 {
                font-size: 2.5rem;
                color: var(--white);
                text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                margin-bottom: 0.5rem;
            }
            .report-header p {
                font-size: 1.1rem;
                color: var(--white);
                opacity: 0.9;
            }

            #report-container {
                background: transparent;
                box-shadow: none;
                padding: 0;
                border: none;
            }

            .report-hero {
                background: linear-gradient(135deg, #f0f6ff 0%, #ffffff 100%);
                border-radius: 12px;
                padding: 2rem 2.5rem;
                text-align: center;
                margin-bottom: 2rem;
                border: 1px solid #e0e7ff;
            }
            .report-hero h3 {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1a253c;
                margin: 0;
            }
            .report-hero p {
                font-size: 1rem;
                color: #5a647e;
                margin: 0.25rem 0 0;
            }

            .report-section {
                background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
                border: 2px solid #e2e8f0;
                border-radius: 16px;
                margin-bottom: 2rem;
                box-shadow: 
                    0 10px 20px rgba(10, 40, 100, 0.08),
                    0 4px 8px rgba(0, 0, 0, 0.04);
                transition: all 0.4s ease;
            }
            details.report-section {
                overflow: hidden;
            }
            details.report-section[open] {
                border-color: #93c5fd;
                box-shadow: 
                    0 14px 28px rgba(59, 130, 246, 0.12),
                    0 6px 12px rgba(0, 0, 0, 0.06);
            }

            .report-section summary {
                padding: 1.5rem 2rem;
                font-weight: 700;
                font-size: 1.3rem;
                color: #1e293b;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                list-style: none;
                transition: background 0.3s ease;
            }
            .report-section summary:hover {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            }
            .report-section summary::-webkit-details-marker {
                display: none;
            }

            .report-section summary .summary-title {
                display: flex;
                align-items: center;
                flex-grow: 1;
                margin-right: 1rem;
            }
            .report-section summary .icon-circle {
                min-width: 46px;
                height: 46px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                margin-right: 1.25rem;
                font-size: 1.1rem;
                color: #fff;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }
            details.report-section summary .arrow {
                transition: transform 0.4s ease;
                flex-shrink: 0;
                font-size: 1.1rem;
                color: #3b82f6;
            }
            details.report-section[open] summary .arrow {
                transform: rotate(180deg);
            }

            /* –ö–õ–Æ–ß–û–í–ê –ü–†–û–ú–Ø–ù–ê: –ü–æ–¥—Ä–∞–≤–Ω—è–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç–∞ –≤–ª—è–≤–æ –∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏ —Å—Ç–∏–ª–æ–≤–µ */
            .report-section .content {
                padding: 0 2rem 2rem 2rem;
                border-top: 2px solid #e8eef7;
                color: #334155;
                line-height: 1.8;
                text-align: left; /* –í–ê–ñ–ù–û: –ü–æ–¥—Ä–∞–≤–Ω—è–≤–∞–Ω–µ –≤–ª—è–≤–æ */
                font-size: 1.02rem;
            }
            .report-section .content ul,
            .report-section .content ol {
                padding-left: 1.5rem;
                margin-top: 0.75rem;
                margin-bottom: 1.25rem;
            }
            .report-section .content li {
                margin-bottom: 0.75rem;
                line-height: 1.75;
                padding-left: 0.25rem;
            }
            .report-section .content li::marker {
                color: #3b82f6;
                font-weight: 700;
            }
            .report-section .content p {
                margin-bottom: 1rem;
                line-height: 1.8;
                text-align: justify;
                hyphens: auto;
            }
            .report-section .content p:last-child {
                margin-bottom: 0;
            }
            .report-section .content h4 {
                margin-top: 2rem;
                margin-bottom: 1rem;
                color: #1e293b;
                font-size: 1.15rem;
                font-weight: 700;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #e2e8f0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .report-section .content h4::before {
                content: '‚ñ∏';
                color: #3b82f6;
                font-size: 1.2rem;
                font-weight: 900;
            }
            .report-section .content strong {
                color: #1e3a8a;
                font-weight: 700;
                background: linear-gradient(
                    135deg,
                    rgba(59, 130, 246, 0.08) 0%,
                    rgba(59, 130, 246, 0.03) 100%
                );
                padding: 0.1rem 0.35rem;
                border-radius: 3px;
            }
            .report-section .content em {
                color: #64748b;
                font-style: italic;
                font-weight: 500;
            }

            .report-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 2rem;
            }
            .info-card {
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
                border-radius: 16px;
                padding: 2rem;
                border: 2px solid #e2e8f0;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 
                    0 4px 12px rgba(0, 0, 0, 0.05),
                    0 2px 6px rgba(0, 0, 0, 0.03);
                position: relative;
                overflow: hidden;
            }
            .info-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 5px;
                height: 0;
                background: linear-gradient(180deg, #3b82f6, #60a5fa, #93c5fd);
                transition: height 0.4s ease;
                box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
            }
            .info-card:hover {
                box-shadow: 
                    0 12px 28px rgba(59, 130, 246, 0.18),
                    0 6px 14px rgba(0, 0, 0, 0.08);
                border-color: #93c5fd;
                transform: translateY(-6px) scale(1.01);
            }
            .info-card:hover::before {
                height: 100%;
            }
            .info-card h4 {
                font-weight: 700;
                margin-bottom: 1.25rem;
                color: #1e293b;
                display: flex;
                align-items: center;
                font-size: 1.2rem;
                gap: 0.75rem;
            }
            .info-card h4 i {
                font-size: 1.4rem;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            }
            .info-card ul,
            .info-card ol {
                margin-top: 0.75rem;
                padding-left: 1.5rem;
            }
            .info-card ul li,
            .info-card ol li {
                margin-bottom: 0.75rem;
                line-height: 1.8;
                color: #334155;
                font-size: 1.02rem;
            }
            .info-card ul li::marker {
                color: #3b82f6;
                font-weight: 700;
            }
            .info-card p {
                color: #334155;
                line-height: 1.8;
                font-size: 1.02rem;
            }

            .channel-analysis-item {
                display: flex;
                align-items: center;
                margin-bottom: 0.75rem;
                padding: 0.5rem 0;
            }
            .channel-analysis-item span {
                width: 110px;
                font-weight: 500;
                flex-shrink: 0;
                color: #333d52;
            }
            .channel-analysis-item .bar {
                flex-grow: 1;
                height: 12px;
                border-radius: 6px;
                overflow: hidden;
                background: #e9ecef;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            .channel-analysis-item .bar-fill {
                border-radius: 6px;
                transition: width 0.8s ease-out;
            }
            .channel-analysis-item .bar-fill.low {
                background: linear-gradient(90deg, #28a745, #34ce57);
            }
            .channel-analysis-item .bar-fill.medium {
                background: linear-gradient(90deg, #ffc107, #ffcd38);
            }
            .channel-analysis-item .bar-fill.high {
                background: linear-gradient(90deg, #dc3545, #e74c5c);
            }

            /* Chart containers */
            .chart-container {
                position: relative;
                margin: 2rem auto;
                padding: 3rem 2.5rem;
                background: linear-gradient(135deg, #fafbff 0%, #f0f4ff 50%, #ffffff 100%);
                border-radius: 24px;
                box-shadow:
                    0 12px 24px -6px rgba(59, 130, 246, 0.15),
                    0 6px 12px -3px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.95);
                border: 2px solid rgba(59, 130, 246, 0.2);
                overflow: visible;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .chart-container:hover {
                box-shadow:
                    0 24px 40px -10px rgba(59, 130, 246, 0.22),
                    0 12px 20px -6px rgba(0, 0, 0, 0.12),
                    inset 0 1px 0 0 rgba(255, 255, 255, 1);
                transform: translateY(-6px) scale(1.02);
                border-color: rgba(59, 130, 246, 0.4);
            }
            .chart-container.small {
                max-width: 650px;
                min-height: 450px;
            }
            .chart-container.medium {
                max-width: 850px;
                min-height: 550px;
            }
            .chart-container.large {
                width: 100%;
                min-height: 600px;
            }
            .chart-container canvas {
                max-width: 100%;
                max-height: 100%;
                filter: drop-shadow(0 8px 16px rgba(59, 130, 246, 0.12));
            }
            .chart-title {
                text-align: center;
                font-weight: 700;
                background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 2.5rem;
                font-size: 1.5rem;
                letter-spacing: -0.03em;
                position: relative;
                padding-bottom: 1rem;
            }
            .chart-title::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 100px;
                height: 5px;
                background: linear-gradient(90deg, transparent, #3b82f6, #60a5fa, transparent);
                border-radius: 3px;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }

            .button-group-report {
                margin-top: 2rem;
                text-align: center;
                display: flex;
                justify-content: center;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .report-disclaimer {
                display: flex;
                align-items: flex-start;
                gap: 1rem;
                background-color: #f8f9fa;
                padding: 1.5rem;
                border-radius: 12px;
                margin-top: 2rem;
                border-left: 4px solid #3b82f6;
                text-align: left;
            }
            .report-disclaimer i {
                color: #3b82f6;
                font-size: 1.5rem;
                margin-top: 3px;
            }
            .report-disclaimer p {
                font-size: 0.9rem;
                margin: 0;
            }

            /* Mobile metric cards - hidden by default, shown on mobile */
            .metrics-list-container {
                display: none;
                margin: 1.5rem 0;
            }

            .metric-card {
                background: white;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                border: 1px solid #e2e8f0;
            }

            .metric-card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            .metric-label {
                font-weight: 600;
                font-size: 0.95rem;
                color: #1e293b;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .metric-value {
                font-weight: 700;
                font-size: 1rem;
                color: #334155;
            }

            .progress-bar {
                width: 100%;
                height: 10px;
                background: #e9ecef;
                border-radius: 6px;
                overflow: hidden;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            .progress-bar-fill {
                height: 100%;
                border-radius: 6px;
                transition: width 0.8s ease-out;
            }

            .progress-bar-fill.high {
                background: linear-gradient(90deg, var(--status-critical-color), #e74c5c);
            }

            .progress-bar-fill.medium {
                background: linear-gradient(90deg, var(--status-high-color), #ffcd38);
            }

            .progress-bar-fill.low {
                background: linear-gradient(90deg, var(--status-low-color), #34ce57);
            }

            .metric-status {
                margin-top: 0.5rem;
                font-size: 0.85rem;
                color: #64748b;
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            /* –ö–õ–Æ–ß–û–í–ê –ü–†–û–ú–Ø–ù–ê: –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∏ –º–µ–¥–∏–π–Ω–∏ –∑–∞—è–≤–∫–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∞ –≤–∏–∑–∏—è */
            @media (max-width: 767px) {
                /* Hide desktop charts, show mobile metric cards */
                .report-section .chart-container,
                .content .chart-container {
                    display: none;
                }
                
                .metrics-list-container {
                    display: block;
                }
                
                .container {
                    padding: 1rem;
                }
                .report-header h2 {
                    font-size: 1.75rem;
                    line-height: 1.3;
                }
                .report-header p {
                    font-size: 1rem;
                }
                .report-hero {
                    padding: 1.75rem;
                    border-radius: 12px;
                }
                .report-hero h3 {
                    font-size: 1.25rem;
                    line-height: 1.4;
                }
                .report-hero p {
                    font-size: 0.95rem;
                }
                
                /* –ü–æ–¥–æ–±—Ä–µ–Ω–∏ —Å–µ–∫—Ü–∏–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
                .report-section {
                    border-radius: 12px;
                    margin-bottom: 1.5rem;
                    border-width: 2px;
                }
                .report-section summary {
                    padding: 1.25rem 1.5rem;
                    font-size: 1.1rem;
                    line-height: 1.4;
                    /* Touch-friendly tap area */
                    min-height: 60px;
                }
                .report-section summary:active {
                    background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
                }
                .report-section summary .icon-circle {
                    min-width: 40px;
                    height: 40px;
                    font-size: 1rem;
                    margin-right: 1rem;
                }
                .report-section summary .arrow {
                    font-size: 1rem;
                }
                .report-section .content {
                    padding: 0 1.5rem 1.5rem 1.5rem;
                    font-size: 0.95rem;
                    line-height: 1.75;
                }
                .report-section .content h4 {
                    font-size: 1.05rem;
                    margin-top: 1.5rem;
                }
                .report-section .content p {
                    font-size: 0.95rem;
                }
                .report-section .content ul li,
                .report-section .content ol li {
                    font-size: 0.95rem;
                    margin-bottom: 0.75rem;
                }
                
                /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∏ */
                .report-grid {
                    grid-template-columns: 1fr;
                    gap: 1.5rem;
                }
                .info-card {
                    padding: 1.5rem;
                    border-radius: 14px;
                    border-width: 2px;
                }
                .info-card::before {
                    width: 4px;
                }
                .info-card h4 {
                    font-size: 1.1rem;
                    margin-bottom: 1rem;
                }
                .info-card h4 i {
                    font-size: 1.25rem;
                }
                .info-card ul,
                .info-card ol {
                    padding-left: 1.25rem;
                }
                .info-card ul li,
                .info-card ol li {
                    font-size: 0.95rem;
                    line-height: 1.75;
                }
                .info-card p {
                    font-size: 0.95rem;
                    line-height: 1.75;
                }
                
                /* –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –∫–∞–Ω–∞–ª–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∏ */
                .channel-analysis-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.5rem;
                }
                .channel-analysis-item span {
                    width: 100%;
                    font-size: 0.95rem;
                    font-weight: 600;
                }
                .channel-analysis-item .bar {
                    width: 100%;
                    height: 12px;
                }
                
                /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∏ –≥—Ä–∞—Ñ–∏–∫–∏ –∑–∞ –º–æ–±–∏–ª–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
                .chart-container {
                    padding: 2rem 1.25rem;
                    border-radius: 20px;
                    margin: 1.5rem 0;
                    min-height: 350px;
                    border-width: 2px;
                }
                .chart-container.small,
                .chart-container.medium,
                .chart-container.large {
                    min-height: 380px;
                    max-width: 100%;
                }
                .chart-title {
                    font-size: 1.2rem;
                    margin-bottom: 1.5rem;
                    line-height: 1.3;
                }
                .chart-title::after {
                    width: 60px;
                    height: 4px;
                }
                
                /* Touch-friendly –±—É—Ç–æ–Ω–∏ */
                .button-group-report {
                    flex-direction: column;
                    gap: 1rem;
                    margin-top: 2rem;
                }
                .button-group-report .btn,
                .button-group-report a {
                    width: 100%;
                    min-height: 48px;
                    font-size: 1rem;
                    border-radius: 12px;
                }
                
                /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω disclaimer –∑–∞ –º–æ–±–∏–ª–Ω–∏ */
                .report-disclaimer {
                    padding: 1.25rem;
                    font-size: 0.9rem;
                    line-height: 1.6;
                    border-radius: 10px;
                }
                .report-disclaimer i {
                    font-size: 1.25rem;
                }
            }
            
            /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞ –º–Ω–æ–≥–æ –º–∞–ª–∫–∏ –µ–∫—Ä–∞–Ω–∏ */
            @media (max-width: 480px) {
                .container {
                    padding: 0.75rem;
                }
                .report-header h2 {
                    font-size: 1.5rem;
                }
                .report-hero {
                    padding: 1.5rem;
                }
                .report-section summary {
                    padding: 1rem 1.25rem;
                    font-size: 1rem;
                }
                .report-section .content {
                    padding: 0 1.25rem 1.25rem 1.25rem;
                }
                .info-card {
                    padding: 1.25rem;
                }
                .chart-container {
                    padding: 1.5rem 1rem;
                    min-height: 320px;
                }
                .chart-title {
                    font-size: 1.1rem;
                }
            }

            /* Desktop view - show charts, hide mobile cards */
            @media (min-width: 768px) {
                .chart-container {
                    display: block;
                }
                
                .report-section .metrics-list-container,
                .content .metrics-list-container {
                    display: none;
                }
            }

            /* Print styles for PDF export */
            @media print {
                body {
                    background: white;
                }
                .container {
                    padding: 0;
                    max-width: 100%;
                }
                .button-group-report {
                    display: none;
                }
                .report-header {
                    color: #1a253c;
                }
                .report-header h2,
                .report-header p {
                    color: #1a253c;
                    text-shadow: none;
                }
                details.report-section {
                    border: 1px solid #ddd;
                }
                details.report-section summary {
                    page-break-inside: avoid;
                }
                details.report-section .content {
                    page-break-inside: avoid;
                }
                .report-section {
                    page-break-inside: avoid;
                    margin-bottom: 1rem;
                }
                .info-card {
                    page-break-inside: avoid;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <section class="analysis-section" style="padding-top: 2rem">
                <header class="report-header">
                    <h2 class="fade-in-up">–ò—Ä–∏–¥–∏–æ–ª–æ–≥–∏—á–µ–Ω –î–æ–∫–ª–∞–¥</h2>
                    <p class="fade-in-up delay-1">–ü—ä—Ç—è—Ç –∫—ä–º –≤–∞—à–µ—Ç–æ –∑–¥—Ä–∞–≤–µ –∑–∞–ø–æ—á–≤–∞ —Ç—É–∫.</p>
                </header>

                <article id="report-container" class="fade-in-up delay-2">
                    <!-- –°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –æ—Ç JavaScript -->
                </article>

                <div id="message-box"></div>

                <div class="button-group-report">
                    <button
                        id="print-btn"
                        class="btn btn-primary fade-in-up delay-3"
                        title="–ü—Ä–∏–Ω—Ç–∏—Ä–∞–π—Ç–µ –∏–ª–∏ –∑–∞–ø–∞–∑–µ—Ç–µ –∫–∞—Ç–æ PDF"
                    >
                        <i class="fas fa-file-pdf"></i> –ó–∞–ø–∞–∑–∏ PDF
                    </button>
                    <button id="re-analyze-btn" class="btn btn-secondary fade-in-up delay-3">
                        –ü–æ–≤—Ç–æ—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞
                    </button>
                    <a href="analysis.html" class="btn btn-secondary fade-in-up delay-3"
                        >–ù–æ–≤ –∞–Ω–∞–ª–∏–∑</a
                    >
                </div>
            </section>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
        <script type="module">
            import { WORKER_URL } from './config.js';

            // *** –ö–õ–Æ–ß–û–í–ê –ü–†–û–ú–Ø–ù–ê: –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ–∫—Ü–∏–∏—Ç–µ ***
            const ICONS_CONFIG = {
                '–†–µ–∑—é–º–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∞': { icon: 'fa-file-medical', color: '#06b6d4' },
                '–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–∞–ª–µ–Ω –∞–Ω–∞–ª–∏–∑': { icon: 'fa-shield-halved', color: '#3b82f6' },
                '–°–∏—Å—Ç–µ–º–∏, –Ω—É–∂–¥–∞–µ—â–∏ —Å–µ –æ—Ç –ø–æ–¥–∫—Ä–µ–ø–∞': { icon: 'fa-heart-pulse', color: '#ef4444' },
                '–ü—ä—Ç–∏—â–∞ –∑–∞ –ø—Ä–µ—á–∏—Å—Ç–≤–∞–Ω–µ': { icon: 'fa-recycle', color: '#10b981' },
                '–ö–ª—é—á–æ–≤–∏ –Ω–∞—Ö–æ–¥–∫–∏ –∏ —Ç—è—Ö–Ω–∞—Ç–∞ –≤—Ä—ä–∑–∫–∞': {
                    icon: 'fa-project-diagram',
                    color: '#8b5cf6'
                },
                '–ü–ª–∞–Ω –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ': { icon: 'fa-list-check', color: '#14b8a6' },
                '–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –Ω–∞—Å–æ–∫–∏': { icon: 'fa-apple-alt', color: '#f97316' },
                '–ü—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –±–∏–ª–∫–∏ –∏ –¥–æ–±–∞–≤–∫–∏': { icon: 'fa-leaf', color: '#059669' },
                '–•–æ–ª–∏—Å—Ç–∏—á–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏': { icon: 'fa-seedling', color: '#f59e0b' },
                '–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª–Ω–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∏': { icon: 'fa-lightbulb', color: '#1d4ed8' },
                '–¶–µ–ª–µ–Ω–∞—Å–æ—á–µ–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏': { icon: 'fa-bullseye', color: '#c2410c' },
                '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ –µ–º–æ—Ü–∏–∏': { icon: 'fa-brain', color: '#be185d' },
                '–ü—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ': { icon: 'fa-calendar-check', color: '#7c3aed' },
                default: { icon: 'fa-circle-info', color: '#6b7280' }
            };

            // –§—É–Ω–∫—Ü–∏—è –∑–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Markdown –∫—ä–º HTML
            function formatTextContent(text) {
                if (text == null) return '';
                if (Array.isArray(text)) {
                    return `<ul>${text.map((item) => `<li>${formatTextContent(item)}</li>`).join('')}</ul>`;
                }
                if (typeof text === 'object') {
                    const main = formatTextContent(text.text || Object.values(text).join(' '));
                    const source = text.source
                        ? `<p><em>–ò–∑—Ç–æ—á–Ω–∏–∫: ${DOMPurify.sanitize(text.source)}</em></p>`
                        : '';
                    return main + source;
                }
                let sanitizedText = DOMPurify.sanitize(String(text), {
                    USE_PROFILES: { html: false }
                });
                // Replace escaped newlines with actual newlines
                sanitizedText = sanitizedText.replace(/\\n/g, '\n');
                // Replace ** with <strong> for bold text
                let html = sanitizedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                const blocks = html.split(/\n\s*\n/);
                const processedBlocks = blocks.map((block) => {
                    block = block.trim();
                    if (!block) return '';
                    const isUnorderedList = /^\*/.test(block);
                    const isOrderedList = /^\d+\./.test(block);
                    if (isUnorderedList) {
                        const items = block
                            .split('\n')
                            .map((line) => `<li>${line.replace(/^\*\s*/, '').trim()}</li>`)
                            .join('');
                        return `<ul>${items}</ul>`;
                    } else if (isOrderedList) {
                        const items = block
                            .split('\n')
                            .map((line) => `<li>${line.replace(/^\d+\.\s*/, '').trim()}</li>`)
                            .join('');
                        return `<ol>${items}</ol>`;
                    } else {
                        return `<p>${block.replace(/\n/g, '<br>')}</p>`;
                    }
                });
                return processedBlocks.join('');
            }

            function renderReport(data) {
                const container = document.getElementById('report-container');
                container.innerHTML = '';

                const hero = document.createElement('div');
                hero.className = 'report-hero';
                hero.innerHTML = `
                <h3>–ü–µ—Ä—Å–æ–Ω–∞–ª–µ–Ω –∞–Ω–∞–ª–∏–∑ –∑–∞ <span style="color: #0056b3;">${DOMPurify.sanitize(data['–ò–º–µ'] || '–ö–ª–∏–µ–Ω—Ç')}</span></h3>
                <p>–î–∞—Ç–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ: ${new Date().toLocaleDateString('bg-BG')}</p>
            `;
                container.appendChild(hero);

                // –î–æ–±–∞–≤—è–º–µ —Ä–µ–∑—é–º–µ –∞–∫–æ –µ –Ω–∞–ª–∏—á–Ω–æ
                if (data['–†–µ–∑—é–º–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∞']) {
                    const summaryBox = document.createElement('div');
                    summaryBox.className = 'report-hero';
                    summaryBox.style.background =
                        'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';
                    summaryBox.style.borderLeft = '4px solid #f59e0b';
                    summaryBox.innerHTML = `
                    <h3 style="color: #92400e; margin-bottom: 0.75rem;"><i class="fas fa-file-medical" style="margin-right: 0.5rem;"></i>–†–µ–∑—é–º–µ</h3>
                    <div style="color: #78350f; font-size: 1.05rem; line-height: 1.7; text-align: left;">${formatTextContent(data['–†–µ–∑—é–º–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∞'])}</div>
                `;
                    container.appendChild(summaryBox);
                }

                const sectionOrder = [
                    '–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–∞–ª–µ–Ω –∞–Ω–∞–ª–∏–∑',
                    '–°–∏—Å—Ç–µ–º–∏, –Ω—É–∂–¥–∞–µ—â–∏ —Å–µ –æ—Ç –ø–æ–¥–∫—Ä–µ–ø–∞',
                    '–ü—ä—Ç–∏—â–∞ –∑–∞ –ø—Ä–µ—á–∏—Å—Ç–≤–∞–Ω–µ',
                    '–ö–ª—é—á–æ–≤–∏ –Ω–∞—Ö–æ–¥–∫–∏ –∏ —Ç—è—Ö–Ω–∞—Ç–∞ –≤—Ä—ä–∑–∫–∞',
                    '–ü–ª–∞–Ω –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ',
                    '–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –Ω–∞—Å–æ–∫–∏',
                    '–ü—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –±–∏–ª–∫–∏ –∏ –¥–æ–±–∞–≤–∫–∏',
                    '–•–æ–ª–∏—Å—Ç–∏—á–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏',
                    '–ü—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ'
                ];

                sectionOrder.forEach((key) => {
                    const content = data[key];
                    if (content) {
                        let section;
                        if (key === '–•–æ–ª–∏—Å—Ç–∏—á–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏') {
                            section = createRecommendationsSection(key, content);
                        } else if (key === '–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –Ω–∞—Å–æ–∫–∏') {
                            section = createNutritionalGuidelinesSection(key, content);
                        } else if (key === '–ü—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –±–∏–ª–∫–∏ –∏ –¥–æ–±–∞–≤–∫–∏') {
                            section = createHerbsSupplementsSection(key, content);
                        } else if (
                            key === '–ü—ä—Ç–∏—â–∞ –∑–∞ –ø—Ä–µ—á–∏—Å—Ç–≤–∞–Ω–µ' &&
                            typeof content === 'string'
                        ) {
                            section = createChannelsSection(key, content);
                        } else if (key === '–°–∏—Å—Ç–µ–º–∏, –Ω—É–∂–¥–∞–µ—â–∏ —Å–µ –æ—Ç –ø–æ–¥–∫—Ä–µ–ø–∞') {
                            section = createPrioritySystemsSection(key, content);
                        } else {
                            section = createCollapsibleSection(
                                key,
                                formatTextContent(content),
                                false
                            );
                        }
                        container.appendChild(section);
                    }
                });

                if (data['–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –æ—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç']) {
                    const disclaimer = document.createElement('footer');
                    disclaimer.className = 'report-disclaimer';
                    disclaimer.innerHTML = `<i class="fas fa-info-circle"></i>${formatTextContent(data['–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –æ—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç'])}`;
                    container.appendChild(disclaimer);
                }
            }

            function createCollapsibleSection(title, contentHTML, defaultOpen = false) {
                const config = ICONS_CONFIG[title] || ICONS_CONFIG['default'];
                const details = document.createElement('details');
                details.className = 'report-section';
                // Only open by default if explicitly requested (not for regular sections)
                if (defaultOpen) {
                    details.setAttribute('open', '');
                }
                details.innerHTML = `
                <summary>
                    <div class="summary-title">
                        <span class="icon-circle" style="background-color: ${config.color};"><i class="fas ${config.icon}"></i></span>
                        <span>${DOMPurify.sanitize(title)}</span>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                </summary>
                <div class="content">${contentHTML}</div>
            `;
                return details;
            }

            function createRecommendationsSection(title, recommendationsData) {
                if (!recommendationsData || typeof recommendationsData !== 'object')
                    return document.createElement('div');
                let subSectionsHTML = '';

                // –ó–∞ –¥–∞ –ø–æ–¥—Ä–µ–¥–∏–º –ø—Ä–µ–ø–æ—Ä—ä–∫–∏—Ç–µ, –¥–µ—Ñ–∏–Ω–∏—Ä–∞–º–µ —Ä–µ–¥
                const recommendationOrder = [
                    '–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª–Ω–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∏',
                    '–¶–µ–ª–µ–Ω–∞—Å–æ—á–µ–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏',
                    '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ –µ–º–æ—Ü–∏–∏'
                ];
                const sortedKeys = Object.keys(recommendationsData).sort((a, b) => {
                    const indexA = recommendationOrder.indexOf(a);
                    const indexB = recommendationOrder.indexOf(b);
                    if (indexA === -1) return 1; // –∞–∫–æ –Ω–µ –µ –≤ —Å–ø–∏—Å—ä–∫–∞, —Å–ª–∞–≥–∞–º–µ –≥–æ –Ω–∞–∫—Ä–∞—è
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                sortedKeys.forEach((key) => {
                    const value = recommendationsData[key];
                    const config = ICONS_CONFIG[key] || ICONS_CONFIG['default'];
                    const formattedValue = formatTextContent(value);
                    subSectionsHTML += `
                    <div class="info-card">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>${DOMPurify.sanitize(key)}</h4>
                        <div class="recommendation-content">${formattedValue}</div>
                    </div>
                `;
                });
                const contentHTML = `<div class="report-grid">${subSectionsHTML}</div>`;
                return createCollapsibleSection(title, contentHTML, false);
            }

            function createNutritionalGuidelinesSection(title, nutritionData) {
                if (!nutritionData || typeof nutritionData !== 'object')
                    return document.createElement('div');
                let contentHTML = '<div class="report-grid">';

                // Foods to limit
                if (nutritionData['–•—Ä–∞–Ω–∏ –∑–∞ –æ–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ']) {
                    const config = { icon: 'fa-ban', color: '#dc2626' };
                    const formattedValue = formatTextContent(
                        nutritionData['–•—Ä–∞–Ω–∏ –∑–∞ –æ–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ']
                    );
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #dc2626;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>–•—Ä–∞–Ω–∏ –∑–∞ –æ–≥—Ä–∞–Ω–∏—á–∞–≤–∞–Ω–µ</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                // Foods to add
                if (nutritionData['–•—Ä–∞–Ω–∏ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ']) {
                    const config = { icon: 'fa-plus-circle', color: '#16a34a' };
                    const formattedValue = formatTextContent(nutritionData['–•—Ä–∞–Ω–∏ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #16a34a;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>–•—Ä–∞–Ω–∏ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                contentHTML += '</div>';
                return createCollapsibleSection(title, contentHTML, false);
            }

            function createHerbsSupplementsSection(title, herbsData) {
                if (!herbsData || typeof herbsData !== 'object')
                    return document.createElement('div');
                let contentHTML = '<div class="report-grid">';

                // Herbal recommendations
                if (herbsData['–ë–∏–ª–∫–æ–≤–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏']) {
                    const config = { icon: 'fa-seedling', color: '#059669' };
                    const formattedValue = formatTextContent(herbsData['–ë–∏–ª–∫–æ–≤–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #059669;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>–ë–∏–ª–∫–æ–≤–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                // Nutritional supplements
                if (herbsData['–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –¥–æ–±–∞–≤–∫–∏']) {
                    const config = { icon: 'fa-capsules', color: '#0891b2' };
                    const formattedValue = formatTextContent(herbsData['–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –¥–æ–±–∞–≤–∫–∏']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #0891b2;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>–•—Ä–∞–Ω–∏—Ç–µ–ª–Ω–∏ –¥–æ–±–∞–≤–∫–∏</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                // Homeopathic remedies
                if (herbsData['–•–æ–º–µ–æ–ø–∞—Ç–∏—á–Ω–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞']) {
                    const config = { icon: 'fa-flask', color: '#7c3aed' };
                    const formattedValue = formatTextContent(herbsData['–•–æ–º–µ–æ–ø–∞—Ç–∏—á–Ω–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #7c3aed;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>–•–æ–º–µ–æ–ø–∞—Ç–∏—á–Ω–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                contentHTML += '</div>';
                return createCollapsibleSection(title, contentHTML, false);
            }

            // --- MOBILE METRIC CARD FUNCTIONS ---

            /**
             * Parse chart data from text content to extract metrics
             * @param {string} content - The text content to parse
             * @param {string} type - Type of chart ('systems' or 'channels')
             * @returns {Array} Array of metric objects with name, value, and status
             */
            function parseChartData(content, type) {
                const text = (content && typeof content === 'string') ? content.toLowerCase() : '';
                
                if (type === 'systems') {
                    // Priority calculation constants
                    const PRIORITY_MULTIPLIER = 25;
                    const PRIORITY_BASE = 35;
                    const PRIORITY_MAX_BASE = 85;
                    const SEVERITY_BONUS_HIGH = 15;
                    const SEVERITY_BONUS_MEDIUM = 8;
                    
                    const systemKeywords = [
                        { name: '–•—Ä–∞–Ω–æ—Å–º–∏–ª–∞—Ç–µ–ª–Ω–∞', keywords: ['—Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞—Ç', '—á–µ—Ä–≤–∞', '—Å—Ç–æ–º–∞—Ö'], icon: 'üü†' },
                        { name: '–ù–µ—Ä–≤–Ω–∞', keywords: ['–Ω–µ—Ä–≤–Ω', '—Å—Ç—Ä–µ—Å', '–º–æ–∑—ä–∫'], icon: 'üü£' },
                        { name: '–õ–∏–º—Ñ–Ω–∞', keywords: ['–ª–∏–º—Ñ–∞', '–∏–º—É–Ω'], icon: 'üü¢' },
                        { name: '–°—ä—Ä–¥–µ—á–Ω–æ-—Å—ä–¥–æ–≤–∞', keywords: ['—Å—ä—Ä–¥–µ—á–Ω', '–∫—Ä—ä–≤', '—Å—ä–¥–æ–≤'], icon: 'üî¥' },
                        { name: '–î–∏—Ö–∞—Ç–µ–ª–Ω–∞', keywords: ['–¥–∏—Ö–∞—Ç', '–±–µ–ª–æ–¥—Ä–æ–±–Ω'], icon: 'üîµ' },
                        { name: '–ï–ª–∏–º–∏–Ω–∞—Ç–∏–≤–Ω–∞', keywords: ['–¥–µ—Ç–æ–∫—Å', '–±—ä–±—Ä–µ–∫', '–µ–ª–∏–º–∏–Ω–∞—Ç'], icon: 'üü°' },
                        { name: '–•–æ—Ä–º–æ–Ω–∞–ª–Ω–∞', keywords: ['—Ö–æ—Ä–º–æ–Ω', '–µ–Ω–¥–æ–∫—Ä–∏–Ω'], icon: 'üü£' },
                        { name: '–ú–µ—Ç–∞–±–æ–ª–∏—á–Ω–∞', keywords: ['–º–µ—Ç–∞–±–æ–ª–∏', '–µ–Ω–µ—Ä–≥–∏'], icon: 'üü†' }
                    ];
                    
                    const metrics = [];
                    systemKeywords.forEach(sys => {
                        const matchCount = sys.keywords.filter(kw => text.includes(kw)).length;
                        if (matchCount > 0) {
                            // Calculate base priority using defined constants
                            let value = Math.min(matchCount * PRIORITY_MULTIPLIER + PRIORITY_BASE, PRIORITY_MAX_BASE);
                            
                            // Check for severity modifiers and apply bonuses
                            if (text.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω') || text.includes('–∫—Ä–∏—Ç–∏—á–Ω') || text.includes('–≤–∞–∂–Ω')) {
                                value = Math.min(value + SEVERITY_BONUS_HIGH, 100);
                            } else if (text.includes('—É–º–µ—Ä–µ–Ω') || text.includes('—Å—Ä–µ–¥–Ω')) {
                                value = Math.min(value + SEVERITY_BONUS_MEDIUM, 100);
                            }
                            
                            let status = value >= 70 ? 'high' : value >= 50 ? 'medium' : 'low';
                            metrics.push({ name: sys.name, value, status, icon: sys.icon });
                        }
                    });
                    
                    return metrics.length > 0 ? metrics : systemKeywords.slice(0, 5).map(sys => ({
                        name: sys.name,
                        value: 50,
                        status: 'medium',
                        icon: sys.icon
                    }));
                } else if (type === 'channels') {
                    const channels = [
                        { name: '–ß–µ—Ä–≤–∞', keyword: '—á–µ—Ä–≤–∞', icon: 'üîÑ' },
                        { name: '–ë—ä–±—Ä–µ—Ü–∏', keyword: '–±—ä–±—Ä–µ–∫', icon: 'üíß' },
                        { name: '–õ–∏–º—Ñ–∞', keyword: '–ª–∏–º—Ñ–∞', icon: 'üåä' },
                        { name: '–ö–æ–∂–∞', keyword: '–∫–æ–∂–∞', icon: '‚ú®' },
                        { name: '–ë–µ–ª–∏ –¥—Ä–æ–±–æ–≤–µ', keyword: '–±–µ–ª–∏ –¥—Ä–æ–±–æ–≤–µ', icon: 'üí®' }
                    ];
                    
                    return channels.map(ch => {
                        const keyword = ch.keyword.toLowerCase();
                        let value = 20;
                        
                        if (text.includes(keyword)) {
                            if (text.includes('–Ω–∞–π-–Ω–∞—Ç–æ–≤–∞—Ä–µ–Ω') || text.includes('—Å–∏–ª–Ω–æ –Ω–∞—Ç–æ–≤–∞—Ä–µ–Ω') || text.includes('–Ω–∞–π-–æ–±—Ä–µ–º–µ–Ω–µ–Ω') || text.includes('—Å–∏–ª–Ω–æ –æ–±—Ä–µ–º–µ–Ω–µ–Ω')) {
                                value = 85;
                            } else if (text.includes('—É–º–µ—Ä–µ–Ω') || text.includes('—Å—Ä–µ–¥–Ω')) {
                                value = 60;
                            } else {
                                value = 40;
                            }
                        }
                        
                        const status = value >= 70 ? 'high' : value >= 50 ? 'medium' : 'low';
                        return { name: ch.name, value, status, icon: ch.icon };
                    });
                }
                
                return [];
            }

            /**
             * Create mobile metric cards from parsed data
             * @param {Array} metrics - Array of metric objects
             * @param {string} containerId - ID of the container to populate
             */
            function createMetricCards(metrics, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = metrics.map(metric => {
                    const statusText = metric.status === 'high' ? '–°–∏–ª–Ω–æ –æ–±—Ä–µ–º–µ–Ω–µ–Ω' :
                                      metric.status === 'medium' ? '–£–º–µ—Ä–µ–Ω–æ –æ–±—Ä–µ–º–µ–Ω–µ–Ω' :
                                      '–ù–æ—Ä–º–∞–ª–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ';
                    const statusIcon = metric.status === 'high' ? 'üî¥' :
                                      metric.status === 'medium' ? 'üü°' : 'üü¢';
                    
                    return `
                        <div class="metric-card">
                            <div class="metric-card-header">
                                <div class="metric-label">
                                    <span>${metric.icon}</span>
                                    <span>${metric.name}</span>
                                </div>
                                <div class="metric-value">${metric.value}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${metric.status}" style="width: ${metric.value}%"></div>
                            </div>
                            <div class="metric-status">
                                <span>${statusIcon}</span>
                                <span>${statusText}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function createPrioritySystemsSection(title, content) {
                const chartId = 'systemsChart_' + Date.now();
                const mobileContainerId = 'mobileSystems_' + Date.now();
                const textContentHTML = formatTextContent(content);

                const contentWithChart = `
                <div class="chart-container medium">
                    <div class="chart-title">–û—Ü–µ–Ω–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∏—Ç–µ, –Ω—É–∂–¥–∞–µ—â–∏ —Å–µ –æ—Ç –ø–æ–¥–∫—Ä–µ–ø–∞</div>
                    <canvas id="${chartId}"></canvas>
                </div>
                <div class="metrics-list-container" id="${mobileContainerId}">
                    <!-- Mobile metric cards will be inserted here -->
                </div>
                ${textContentHTML}
            `;

                const section = createCollapsibleSection(title, contentWithChart, false);

                // Create chart and mobile cards after section is added to DOM
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const canvas = document.getElementById(chartId);
                        if (canvas) createSystemBalanceChart(content, chartId);
                        
                        // Create mobile metric cards
                        const metrics = parseChartData(content, 'systems');
                        createMetricCards(metrics, mobileContainerId);
                    });
                });

                return section;
            }

            function createChannelsSection(title, content) {
                const textContentHTML = formatTextContent(content);
                const channels = ['—á–µ—Ä–≤–∞', '–±—ä–±—Ä–µ—Ü–∏', '–ª–∏–º—Ñ–∞', '–∫–æ–∂–∞', '–±–µ–ª–∏ –¥—Ä–æ–±–æ–≤–µ'];
                const chartId = 'channelsChart_' + Date.now();
                const mobileContainerId = 'mobileChannels_' + Date.now();

                let barsHTML = `
                <h4 style="margin-top: 1.5rem;">–û—Ü–µ–Ω–∫–∞ –Ω–∞ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ –∫–∞–Ω–∞–ª–∏—Ç–µ:</h4>
                <div class="chart-container medium">
                    <canvas id="${chartId}"></canvas>
                </div>
                <div class="metrics-list-container" id="${mobileContainerId}">
                    <!-- Mobile metric cards will be inserted here -->
                </div>
            `;

                const finalContentHTML = textContentHTML + barsHTML;
                const section = createCollapsibleSection(title, finalContentHTML, false);

                // Create chart and mobile cards after section is added to DOM
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const canvas = document.getElementById(chartId);
                        if (canvas) createChannelComparisonChart(content, chartId);
                        
                        // Create mobile metric cards
                        const metrics = parseChartData(content, 'channels');
                        createMetricCards(metrics, mobileContainerId);
                    });
                });

                return section;
            }

            // --- CHART CREATION FUNCTIONS ---

            function createSystemBalanceChart(systemsData, containerId) {
                const ctx = document.getElementById(containerId);
                if (!ctx) {
                    console.error('Canvas element not found:', containerId);
                    return;
                }

                // Priority calculation constants
                const PRIORITY_MULTIPLIER = 25;
                const PRIORITY_BASE = 35;
                const PRIORITY_MAX_BASE = 85;
                const PRIORITY_MIN = 20;
                const PRIORITY_MAX = 100;
                const CONTEXT_WINDOW_SIZE = 50;
                const SEVERITY_BONUS_HIGH = 15;
                const SEVERITY_BONUS_MEDIUM = 8;
                const SEVERITY_PENALTY_MILD = -10;
                const FALLBACK_PRIORITY = 50;

                const systems = [];
                const values = [];
                const colors = [];
                const backgroundColors = [];

                // Parse systems and their priorities with improved detection
                const text =
                    typeof systemsData === 'string' ? systemsData : JSON.stringify(systemsData);
                const lowerText = text.toLowerCase();

                // Enhanced system definitions with better colors and more keywords
                const systemKeywords = [
                    {
                        name: '–•—Ä–∞–Ω–æ—Å–º–∏–ª–∞—Ç–µ–ª–Ω–∞',
                        color: '#f59e0b',
                        gradient: 'rgba(245, 158, 11, 0.75)',
                        keywords: [
                            '—Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞—Ç',
                            '—á–µ—Ä–≤–∞',
                            '—Å—Ç–æ–º–∞—Ö',
                            '—Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞–Ω–µ',
                            '—Ö—Ä–∞–Ω–æ—Å–º–∏–ª–∞—Ç–µ–ª–Ω',
                            '–≥–∞—Å—Ç—Ä–æ',
                            '—á—Ä–µ–≤–Ω'
                        ]
                    },
                    {
                        name: '–ù–µ—Ä–≤–Ω–∞',
                        color: '#8b5cf6',
                        gradient: 'rgba(139, 92, 246, 0.75)',
                        keywords: [
                            '–Ω–µ—Ä–≤–Ω',
                            '—Å—Ç—Ä–µ—Å',
                            '–º–æ–∑—ä–∫',
                            '–Ω–µ–≤—Ä–æ',
                            '–ø—Å–∏—Ö–∏–∫',
                            '–µ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω',
                            '—Ç—Ä–µ–≤–æ–∂'
                        ]
                    },
                    {
                        name: '–õ–∏–º—Ñ–Ω–∞',
                        color: '#10b981',
                        gradient: 'rgba(16, 185, 129, 0.75)',
                        keywords: ['–ª–∏–º—Ñ–∞', '–ª–∏–º—Ñ–∞—Ç–∏—á–Ω', '–∏–º—É–Ω', '–∏–º—É–Ω–Ω', '–æ—Ç–±—Ä–∞–Ω–∏—Ç–µ–ª–Ω']
                    },
                    {
                        name: '–°—ä—Ä–¥–µ—á–Ω–æ-—Å—ä–¥–æ–≤–∞',
                        color: '#ef4444',
                        gradient: 'rgba(239, 68, 68, 0.75)',
                        keywords: [
                            '—Å—ä—Ä–¥–µ—á–Ω',
                            '–∫—Ä—ä–≤',
                            '—Å—ä–¥–æ–≤',
                            '–∫—Ä—ä–≤–æ–Ω–æ—Å–Ω',
                            '—Å—ä—Ä—Ü–µ',
                            '–∞—Ä—Ç–µ—Ä–∏',
                            '–∫–∞—Ä–¥–∏–æ'
                        ]
                    },
                    {
                        name: '–î–∏—Ö–∞—Ç–µ–ª–Ω–∞',
                        color: '#06b6d4',
                        gradient: 'rgba(6, 182, 212, 0.75)',
                        keywords: ['–¥–∏—Ö–∞—Ç', '–±–µ–ª–æ–¥—Ä–æ–±–Ω', '–±–µ–ª–∏ –¥—Ä–æ–±–æ–≤–µ', '—Ä–µ—Å–ø–∏—Ä–∞—Ç–æ—Ä', '–¥–∏—à–∞–Ω']
                    },
                    {
                        name: '–ï–ª–∏–º–∏–Ω–∞—Ç–∏–≤–Ω–∞',
                        color: '#84cc16',
                        gradient: 'rgba(132, 204, 22, 0.75)',
                        keywords: [
                            '–¥–µ—Ç–æ–∫—Å',
                            '–±—ä–±—Ä–µ–∫',
                            '–µ–ª–∏–º–∏–Ω–∞—Ç',
                            '–∏–∑—Ö–≤—ä—Ä–ª—è–Ω',
                            '–ø—Ä–µ—á–∏—Å—Ç–≤–∞–Ω',
                            '—É—Ä–∏–Ω',
                            '–æ—Ç–ø–∞–¥–Ω'
                        ]
                    },
                    {
                        name: '–•–æ—Ä–º–æ–Ω–∞–ª–Ω–∞',
                        color: '#ec4899',
                        gradient: 'rgba(236, 72, 153, 0.75)',
                        keywords: ['—Ö–æ—Ä–º–æ–Ω', '–µ–Ω–¥–æ–∫—Ä–∏–Ω', '—â–∏—Ç–æ–≤–∏–¥–Ω', '–Ω–∞–¥–±—ä–±—Ä–µ—á–Ω', '—Ö–∏–ø–æ—Ñ–∏–∑']
                    },
                    {
                        name: '–ú–µ—Ç–∞–±–æ–ª–∏—á–Ω–∞',
                        color: '#f97316',
                        gradient: 'rgba(249, 115, 22, 0.75)',
                        keywords: ['–º–µ—Ç–∞–±–æ–ª–∏', '–µ–Ω–µ—Ä–≥–∏', '–æ–±–º–µ–Ω', '–º–∏—Ç–æ—Ö–æ–Ω–¥—Ä–∏']
                    }
                ];

                // Severity indicators for better priority calculation
                const severityIndicators = {
                    high: [
                        '–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω',
                        '–∫—Ä–∏—Ç–∏—á–Ω',
                        '–≤–∞–∂–Ω',
                        '—Å–µ—Ä–∏–æ–∑–Ω',
                        '—Å–∏–ª–Ω–æ',
                        '–∑–Ω–∞—á–∏—Ç–µ–ª–Ω',
                        '–∏–∑—Ä–∞–∑–µ–Ω',
                        '—Å–ø–µ—à–Ω'
                    ],
                    medium: ['—É–º–µ—Ä–µ–Ω', '—Å—Ä–µ–¥–Ω', '–∑–∞–±–µ–ª–µ–∂–∏–º', '–≤–∏–¥–∏–º', '–ª–µ–∫–æ'],
                    mild: ['–º–∏–Ω–∏–º–∞–ª–µ–Ω', '—Å–ª–∞–±', '–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª–Ω']
                };

                // Detect systems and calculate priorities
                systemKeywords.forEach((sys) => {
                    const matchCount = sys.keywords.filter((kw) => lowerText.includes(kw)).length;

                    if (matchCount > 0) {
                        systems.push(sys.name);
                        colors.push(sys.color);
                        backgroundColors.push(sys.gradient);

                        // Calculate priority based on keyword frequency and severity indicators
                        let basePriority = Math.min(
                            matchCount * PRIORITY_MULTIPLIER + PRIORITY_BASE,
                            PRIORITY_MAX_BASE
                        );

                        // Check for severity modifiers in proximity to system keywords
                        let severityBonus = 0;
                        sys.keywords.forEach((kw) => {
                            if (lowerText.includes(kw)) {
                                // Check text around the keyword for severity indicators
                                const keywordIndex = lowerText.indexOf(kw);
                                const contextStart = Math.max(
                                    0,
                                    keywordIndex - CONTEXT_WINDOW_SIZE
                                );
                                const contextEnd = Math.min(
                                    lowerText.length,
                                    keywordIndex + CONTEXT_WINDOW_SIZE
                                );
                                const context = lowerText.substring(contextStart, contextEnd);

                                if (severityIndicators.high.some((ind) => context.includes(ind))) {
                                    severityBonus = Math.max(severityBonus, SEVERITY_BONUS_HIGH);
                                } else if (
                                    severityIndicators.medium.some((ind) => context.includes(ind))
                                ) {
                                    severityBonus = Math.max(severityBonus, SEVERITY_BONUS_MEDIUM);
                                } else if (
                                    severityIndicators.mild.some((ind) => context.includes(ind))
                                ) {
                                    severityBonus = Math.max(severityBonus, SEVERITY_PENALTY_MILD);
                                }
                            }
                        });

                        values.push(
                            Math.min(
                                Math.max(basePriority + severityBonus, PRIORITY_MIN),
                                PRIORITY_MAX
                            )
                        );
                    }
                });

                // Fallback: if no systems detected, show all with moderate values
                if (systems.length === 0) {
                    console.warn('No systems detected for chart, using fallback visualization');
                    systemKeywords.slice(0, 6).forEach((sys) => {
                        systems.push(sys.name);
                        values.push(FALLBACK_PRIORITY);
                        colors.push(sys.color);
                        backgroundColors.push(sys.gradient);
                    });
                }

                try {
                    // Ensure canvas has proper dimensions
                    const container = ctx.parentElement;
                    if (container) {
                        ctx.style.maxWidth = '100%';
                        ctx.style.maxHeight = '100%';
                    }

                    new Chart(ctx, {
                        type: 'polarArea',
                        data: {
                            labels: systems,
                            datasets: [
                                {
                                    label: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞ –ø–æ–¥–∫—Ä–µ–ø–∞',
                                    data: values,
                                    backgroundColor: backgroundColors,
                                    borderColor: colors,
                                    borderWidth: 3,
                                    hoverBorderWidth: 5,
                                    hoverBorderColor: '#ffffff',
                                    hoverBackgroundColor: backgroundColors.map((color) =>
                                        color.replace('0.75', '0.9')
                                    )
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 1.4,
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 2500,
                                easing: 'easeInOutCubic',
                                delay: (context) => {
                                    return context.dataIndex * 180;
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                intersect: true
                            },
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 20,
                                        font: {
                                            size: 14,
                                            family: "'Poppins', sans-serif",
                                            weight: '600'
                                        },
                                        backdropColor: 'rgba(255, 255, 255, 0.98)',
                                        backdropPadding: 8,
                                        color: '#334155',
                                        showLabelBackdrop: true,
                                        callback: function (value) {
                                            return value + '%';
                                        }
                                    },
                                    pointLabels: {
                                        font: {
                                            size: 15,
                                            weight: '700',
                                            family: "'Poppins', sans-serif"
                                        },
                                        color: '#1e293b',
                                        padding: 16,
                                        callback: function (label) {
                                            // Wrap long labels for better display
                                            const words = label.split(' ');
                                            if (words.length > 1) {
                                                return words;
                                            }
                                            return label;
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.25)',
                                        lineWidth: 2,
                                        circular: true
                                    },
                                    angleLines: {
                                        color: 'rgba(100, 116, 139, 0.25)',
                                        lineWidth: 2
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: 'rgba(15, 23, 42, 0.96)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#e2e8f0',
                                    titleFont: {
                                        size: 15,
                                        weight: '700',
                                        family: "'Poppins', sans-serif"
                                    },
                                    bodyFont: {
                                        size: 14,
                                        family: "'Poppins', sans-serif",
                                        weight: '500'
                                    },
                                    padding: 16,
                                    borderColor: 'rgba(255, 255, 255, 0.3)',
                                    borderWidth: 2,
                                    displayColors: true,
                                    boxPadding: 6,
                                    callbacks: {
                                        title: function (context) {
                                            return context[0].label;
                                        },
                                        label: function (context) {
                                            const value = context.parsed.r;
                                            let level = '–ù–æ—Ä–º–∞–ª–µ–Ω';
                                            let icon = '‚óè';
                                            if (value >= 75) {
                                                level = '–í–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç';
                                                icon = 'üî¥';
                                            } else if (value >= 50) {
                                                level = '–°—Ä–µ–¥–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç';
                                                icon = 'üü°';
                                            } else if (value >= 30) {
                                                level = '–ù–∏—Å—ä–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç';
                                                icon = 'üü¢';
                                            }
                                            return [`${icon} –û—Ü–µ–Ω–∫–∞: ${value}%`, `–ù–∏–≤–æ: ${level}`];
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creating polar area chart:', error);
                    // Try fallback to simple display
                    const errorMsg = document.createElement('p');
                    errorMsg.style.cssText = 'text-align: center; color: #64748b; padding: 2rem;';
                    errorMsg.textContent = '–î–∏–∞–≥—Ä–∞–º–∞—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–∞–Ω–∞ –≤ –º–æ–º–µ–Ω—Ç–∞.';
                    ctx.parentElement.appendChild(errorMsg);
                    ctx.style.display = 'none';
                }
            }

            function createChannelComparisonChart(channelsData, containerId) {
                const ctx = document.getElementById(containerId);
                if (!ctx) return;

                const text = typeof channelsData === 'string' ? channelsData.toLowerCase() : '';
                const channels = [
                    { name: '–ß–µ—Ä–≤–∞', keyword: '—á–µ—Ä–≤–∞', icon: 'üîÑ' },
                    { name: '–ë—ä–±—Ä–µ—Ü–∏', keyword: '–±—ä–±—Ä–µ–∫', icon: 'üíß' },
                    { name: '–õ–∏–º—Ñ–∞', keyword: '–ª–∏–º—Ñ–∞', icon: 'üåä' },
                    { name: '–ö–æ–∂–∞', keyword: '–∫–æ–∂–∞', icon: '‚ú®' },
                    { name: '–ë–µ–ª–∏ –¥—Ä–æ–±–æ–≤–µ', keyword: '–±–µ–ª–∏ –¥—Ä–æ–±–æ–≤–µ', icon: 'üí®' }
                ];

                const data = channels.map((ch) => {
                    const keyword = ch.keyword.toLowerCase();
                    if (text.includes(keyword)) {
                        if (text.includes('–Ω–∞–π-–Ω–∞—Ç–æ–≤–∞—Ä–µ–Ω') || text.includes('—Å–∏–ª–Ω–æ –Ω–∞—Ç–æ–≤–∞—Ä–µ–Ω')) {
                            return 85;
                        } else if (text.includes('—É–º–µ—Ä–µ–Ω') || text.includes('—Å—Ä–µ–¥–Ω')) {
                            return 60;
                        } else {
                            return 40;
                        }
                    }
                    return 20;
                });

                // Create gradient backgrounds for bars
                const gradients = data.map((val, idx) => {
                    const canvas = ctx;
                    const gradient = canvas
                        .getContext('2d')
                        .createLinearGradient(0, 0, canvas.width, 0);
                    if (val >= 70) {
                        gradient.addColorStop(0, 'rgba(239, 68, 68, 0.9)');
                        gradient.addColorStop(1, 'rgba(220, 38, 38, 0.75)');
                    } else if (val >= 50) {
                        gradient.addColorStop(0, 'rgba(251, 191, 36, 0.9)');
                        gradient.addColorStop(1, 'rgba(245, 158, 11, 0.75)');
                    } else {
                        gradient.addColorStop(0, 'rgba(52, 211, 153, 0.9)');
                        gradient.addColorStop(1, 'rgba(16, 185, 129, 0.75)');
                    }
                    return gradient;
                });

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: channels.map((ch) => ch.icon + ' ' + ch.name),
                        datasets: [
                            {
                                label: '–ù–∞—Ç–æ–≤–∞—Ä–µ–Ω–æ—Å—Ç',
                                data: data,
                                backgroundColor: data.map((val) =>
                                    val >= 70
                                        ? 'rgba(239, 68, 68, 0.85)'
                                        : val >= 50
                                          ? 'rgba(251, 191, 36, 0.85)'
                                          : 'rgba(52, 211, 153, 0.85)'
                                ),
                                borderColor: data.map((val) =>
                                    val >= 70 ? '#dc2626' : val >= 50 ? '#f59e0b' : '#10b981'
                                ),
                                borderWidth: 3,
                                borderRadius: 10,
                                borderSkipped: false,
                                barThickness: 'flex',
                                maxBarThickness: 50,
                                hoverBackgroundColor: data.map((val) =>
                                    val >= 70
                                        ? 'rgba(239, 68, 68, 0.95)'
                                        : val >= 50
                                          ? 'rgba(251, 191, 36, 0.95)'
                                          : 'rgba(52, 211, 153, 0.95)'
                                ),
                                hoverBorderWidth: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'y',
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutQuart',
                            delay: (context) => {
                                return context.dataIndex * 200;
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.15)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 14,
                                        family: "'Poppins', sans-serif",
                                        weight: '600'
                                    },
                                    color: '#334155',
                                    padding: 10,
                                    callback: function (value) {
                                        return value + '%';
                                    }
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 14,
                                        weight: '700',
                                        family: "'Poppins', sans-serif"
                                    },
                                    color: '#1e293b',
                                    padding: 16,
                                    crossAlign: 'far'
                                },
                                border: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(15, 23, 42, 0.96)',
                                titleColor: '#ffffff',
                                bodyColor: '#e2e8f0',
                                titleFont: {
                                    size: 15,
                                    weight: '700',
                                    family: "'Poppins', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Poppins', sans-serif",
                                    weight: '500'
                                },
                                padding: 16,
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 2,
                                displayColors: false,
                                callbacks: {
                                    title: function (context) {
                                        return context[0].label;
                                    },
                                    label: function (context) {
                                        const value = context.parsed.x;
                                        let status = '';
                                        let icon = '';
                                        if (value >= 70) {
                                            status = '–°–∏–ª–Ω–æ –æ–±—Ä–µ–º–µ–Ω–µ–Ω';
                                            icon = 'üî¥';
                                        } else if (value >= 50) {
                                            status = '–£–º–µ—Ä–µ–Ω–æ –æ–±—Ä–µ–º–µ–Ω–µ–Ω';
                                            icon = 'üü°';
                                        } else {
                                            status = '–ù–æ—Ä–º–∞–ª–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ';
                                            icon = 'üü¢';
                                        }
                                        return [
                                            `${icon} –û–±—Ä–µ–º–µ–Ω–µ–Ω–æ—Å—Ç: ${value}%`,
                                            `–°—Ç–∞—Ç—É—Å: ${status}`
                                        ];
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 20,
                                top: 10,
                                bottom: 10
                            }
                        }
                    }
                });
            }

            function createHealthMetricsChart(userData, containerId) {
                const ctx = document.getElementById(containerId);
                if (!ctx || !userData) return;

                // Calculate health metrics based on available data
                const metrics = [];
                const values = [];
                const colors = [];

                // Stress level
                if (userData.stress) {
                    metrics.push('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–µ—Å–∞');
                    values.push(Math.max(0, 100 - userData.stress * 10));
                    colors.push('#8b5cf6');
                }

                // Sleep quality (if available)
                if (userData['sleep-hours']) {
                    const sleepScore = Math.min(100, (userData['sleep-hours'] / 8) * 100);
                    metrics.push('–ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —Å—ä–Ω—è');
                    values.push(sleepScore);
                    colors.push('#06b6d4');
                }

                // BMI status (if available)
                if (userData.bmi) {
                    const bmi = parseFloat(userData.bmi);
                    let bmiScore = 100;
                    if (bmi < 18.5 || bmi > 30) bmiScore = 50;
                    else if (bmi < 20 || bmi > 27) bmiScore = 75;
                    metrics.push('BMI —Å—Ç–∞—Ç—É—Å');
                    values.push(bmiScore);
                    colors.push('#10b981');
                }

                if (metrics.length === 0) return;

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: metrics,
                        datasets: [
                            {
                                data: values,
                                backgroundColor: colors.map((c) => c + 'CC'),
                                borderColor: colors,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return (
                                            context.label + ': ' + Math.round(context.parsed) + '%'
                                        );
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- –õ–û–ì–ò–ö–ê –ó–ê –ó–ê–†–ï–ñ–î–ê–ù–ï –ò –ü–û–í–¢–û–†–ï–ù –ê–ù–ê–õ–ò–ó ---
            document.addEventListener('DOMContentLoaded', function () {
                const reportContainer = document.getElementById('report-container');
                const messageBox = document.getElementById('message-box');
                const reAnalyzeBtn = document.getElementById('re-analyze-btn');

                reportContainer.innerHTML = `<div class="loading-box" style="text-align:center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top:1rem;">–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –í–∞—à–∏—è –¥–æ–∫–ª–∞–¥...</p></div>`;

                setTimeout(() => {
                    try {
                        const rawData = localStorage.getItem('iridologyReport');
                        if (!rawData)
                            throw new Error(
                                '–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –∞–Ω–∞–ª–∏–∑. –ú–æ–ª—è, –≤—ä—Ä–Ω–µ—Ç–µ —Å–µ –Ω–∞ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞.'
                            );

                        const data = JSON.parse(rawData);
                        renderReport(data);
                    } catch (err) {
                        reportContainer.style.display = 'none';
                        if (!messageBox.hasChildNodes()) {
                            // –ü–æ–∫–∞–∑–≤–∞–º–µ –≥—Ä–µ—à–∫–∞ —Å–∞–º–æ –∞–∫–æ –≤–µ—á–µ –Ω—è–º–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ
                            messageBox.textContent = err.message;
                            messageBox.className = 'error-box';
                        }
                    }
                }, 500);

                if (reAnalyzeBtn) {
                    reAnalyzeBtn.addEventListener('click', async () => {
                        reAnalyzeBtn.disabled = true;
                        reAnalyzeBtn.innerHTML =
                            '<i class="fas fa-spinner fa-spin"></i> –ü–æ–≤—Ç–∞—Ä—è–Ω–µ...';

                        const messageContainer = document.querySelector('.button-group-report'); // –ü–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –Ω–∞–¥ –±—É—Ç–æ–Ω–∏—Ç–µ
                        messageBox.textContent = '–ü–æ–¥–≥–æ—Ç–≤—è–º–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω –∞–Ω–∞–ª–∏–∑...';
                        messageBox.className = 'info-box';
                        messageContainer.insertAdjacentElement('beforebegin', messageBox);

                        const stored = localStorage.getItem('iridologyFormData');
                        if (!stored) {
                            messageBox.textContent =
                                '–õ–∏–ø—Å–≤–∞—Ç –¥–∞–Ω–Ω–∏ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω –∞–Ω–∞–ª–∏–∑. –ú–æ–ª—è, –∑–∞–ø–æ—á–Ω–µ—Ç–µ –æ—Ç–Ω–∞—á–∞–ª–æ.';
                            messageBox.className = 'error-box';
                            reAnalyzeBtn.disabled = false;
                            reAnalyzeBtn.innerHTML = '–ü–æ–≤—Ç–æ—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞';
                            return;
                        }

                        const formData = new FormData();
                        const obj = JSON.parse(stored);
                        for (const [key, value] of Object.entries(obj)) {
                            if (typeof value === 'string' && value.startsWith('data:')) {
                                const res = await fetch(value);
                                const blob = await res.blob();
                                formData.append(key, blob, `${key}.png`);
                            } else {
                                formData.append(key, value);
                            }
                        }

                        try {
                            messageBox.textContent = '–ò–∑–ø—Ä–∞—â–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ –∫—ä–º AI...';
                            const response = await fetch(WORKER_URL, {
                                method: 'POST',
                                body: formData
                            });
                            if (!response.ok) {
                                const errData = await response.json().catch(() => ({
                                    error: `–ì—Ä–µ—à–∫–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞: ${response.status}`
                                }));
                                throw new Error(errData.error);
                            }
                            const data = await response.json();
                            localStorage.setItem('iridologyReport', JSON.stringify(data));
                            messageBox.textContent = '–£—Å–ø–µ—Ö! –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ –¥–æ–∫–ª–∞–¥–∞...';
                            messageBox.className = 'success-box';
                            setTimeout(() => location.reload(), 1000);
                        } catch (err) {
                            messageBox.textContent = '–ì—Ä–µ—à–∫–∞: ' + err.message;
                            messageBox.className = 'error-box';
                            reAnalyzeBtn.disabled = false;
                            reAnalyzeBtn.innerHTML = '–ü–æ–≤—Ç–æ—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞';
                        }
                    });
                }

                // PDF Print functionality
                const printBtn = document.getElementById('print-btn');
                if (printBtn) {
                    printBtn.addEventListener('click', () => {
                        // –û—Ç–≤–∞—Ä—è–º–µ –≤—Å–∏—á–∫–∏ —Å–µ–∫—Ü–∏–∏ –ø—Ä–µ–¥–∏ –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ –∑–∞ –ø—ä–ª–µ–Ω –¥–æ–∫–ª–∞–¥
                        const allDetails = document.querySelectorAll('details.report-section');
                        allDetails.forEach((detail) => detail.setAttribute('open', ''));

                        // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ requestAnimationFrame –∑–∞ –¥–∞ —Å–º–µ —Å–∏–≥—É—Ä–Ω–∏ —á–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –µ —Ä–µ–Ω–¥–µ—Ä–∏—Ä–∞–Ω–æ
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                window.print();
                            });
                        });
                    });
                }
            });
        </script>
    </body>
</html>
