<!doctype html>
<html lang="bg">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Вашият Ирисологичен Доклад - Iris-Holistica AI</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        />
        <link rel="stylesheet" href="style.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

        <!-- Персонализирани стилове САМО за тази страница -->
        <style>
            :root {
                /* Дефинираме цветове тук, за да са достъпни */
                --white: #ffffff;
                --gradient: linear-gradient(135deg, #437dcb 0%, #2e5a9b 100%);

                /* Status colors for mobile metric cards */
                --status-critical-bg: rgba(239, 68, 68, 0.85);
                --status-critical-color: #dc2626;
                --status-high-bg: rgba(251, 191, 36, 0.85);
                --status-high-color: #f59e0b;
                --status-medium-bg: rgba(52, 211, 153, 0.85);
                --status-medium-color: #10b981;
                --status-low-bg: rgba(52, 211, 153, 0.85);
                --status-low-color: #28a745;
            }

            body {
                background: var(--gradient);
            }

            .report-header {
                text-align: center;
                margin-bottom: 2rem;
            }
            .report-header h2 {
                font-size: 2.5rem;
                color: var(--white);
                text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                margin-bottom: 0.5rem;
            }
            .report-header p {
                font-size: 1.1rem;
                color: var(--white);
                opacity: 0.9;
            }

            #report-container {
                background: transparent;
                box-shadow: none;
                padding: 0;
                border: none;
            }

            .report-hero {
                background: linear-gradient(135deg, #f0f6ff 0%, #ffffff 100%);
                border-radius: 12px;
                padding: 2rem 2.5rem;
                text-align: center;
                margin-bottom: 2rem;
                border: 1px solid #e0e7ff;
            }
            .report-hero h3 {
                font-size: 1.5rem;
                font-weight: 600;
                color: #1a253c;
                margin: 0;
            }
            .report-hero p {
                font-size: 1rem;
                color: #5a647e;
                margin: 0.25rem 0 0;
            }

            .report-section {
                background: linear-gradient(135deg, #ffffff 0%, #fafbff 100%);
                border: 2px solid #e2e8f0;
                border-radius: 16px;
                margin-bottom: 2rem;
                box-shadow:
                    0 10px 20px rgba(10, 40, 100, 0.08),
                    0 4px 8px rgba(0, 0, 0, 0.04);
                transition: all 0.4s ease;
            }
            details.report-section {
                overflow: hidden;
            }
            details.report-section[open] {
                border-color: #93c5fd;
                box-shadow:
                    0 14px 28px rgba(59, 130, 246, 0.12),
                    0 6px 12px rgba(0, 0, 0, 0.06);
            }

            .report-section summary {
                padding: 1.5rem 2rem;
                font-weight: 700;
                font-size: 1.3rem;
                color: #1e293b;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                list-style: none;
                transition: background 0.3s ease;
            }
            .report-section summary:hover {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            }
            .report-section summary::-webkit-details-marker {
                display: none;
            }

            .report-section summary .summary-title {
                display: flex;
                align-items: center;
                flex-grow: 1;
                margin-right: 1rem;
            }
            .report-section summary .icon-circle {
                min-width: 46px;
                height: 46px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                margin-right: 1.25rem;
                font-size: 1.1rem;
                color: #fff;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }
            details.report-section summary .arrow {
                transition: transform 0.4s ease;
                flex-shrink: 0;
                font-size: 1.1rem;
                color: #3b82f6;
            }
            details.report-section[open] summary .arrow {
                transform: rotate(180deg);
            }

            /* КЛЮЧОВА ПРОМЯНА: Подравняване на текста вляво и подобрени стилове */
            .report-section .content {
                padding: 0 2rem 2rem 2rem;
                border-top: 2px solid #e8eef7;
                color: #334155;
                line-height: 1.8;
                text-align: left; /* ВАЖНО: Подравняване вляво */
                font-size: 1.02rem;
            }
            .report-section .content ul,
            .report-section .content ol {
                padding-left: 1.5rem;
                margin-top: 0.75rem;
                margin-bottom: 1.25rem;
            }
            .report-section .content li {
                margin-bottom: 0.75rem;
                line-height: 1.75;
                padding-left: 0.25rem;
            }
            .report-section .content li::marker {
                color: #3b82f6;
                font-weight: 700;
            }
            .report-section .content p {
                margin-bottom: 1rem;
                line-height: 1.8;
                text-align: justify;
                hyphens: auto;
            }
            .report-section .content p:last-child {
                margin-bottom: 0;
            }
            .report-section .content h4 {
                margin-top: 2rem;
                margin-bottom: 1rem;
                color: #1e293b;
                font-size: 1.15rem;
                font-weight: 700;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #e2e8f0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .report-section .content h4::before {
                content: '▸';
                color: #3b82f6;
                font-size: 1.2rem;
                font-weight: 900;
            }
            .report-section .content strong {
                color: #1e3a8a;
                font-weight: 700;
                background: linear-gradient(
                    135deg,
                    rgba(59, 130, 246, 0.08) 0%,
                    rgba(59, 130, 246, 0.03) 100%
                );
                padding: 0.1rem 0.35rem;
                border-radius: 3px;
            }
            .report-section .content em {
                color: #64748b;
                font-style: italic;
                font-weight: 500;
            }

            .report-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 2rem;
            }
            .info-card {
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
                border-radius: 16px;
                padding: 2rem;
                border: 2px solid #e2e8f0;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow:
                    0 4px 12px rgba(0, 0, 0, 0.05),
                    0 2px 6px rgba(0, 0, 0, 0.03);
                position: relative;
                overflow: hidden;
            }
            .info-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 5px;
                height: 0;
                background: linear-gradient(180deg, #3b82f6, #60a5fa, #93c5fd);
                transition: height 0.4s ease;
                box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
            }
            .info-card:hover {
                box-shadow:
                    0 12px 28px rgba(59, 130, 246, 0.18),
                    0 6px 14px rgba(0, 0, 0, 0.08);
                border-color: #93c5fd;
                transform: translateY(-6px) scale(1.01);
            }
            .info-card:hover::before {
                height: 100%;
            }
            .info-card h4 {
                font-weight: 700;
                margin-bottom: 1.25rem;
                color: #1e293b;
                display: flex;
                align-items: center;
                font-size: 1.2rem;
                gap: 0.75rem;
            }
            .info-card h4 i {
                font-size: 1.4rem;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            }
            .info-card ul,
            .info-card ol {
                margin-top: 0.75rem;
                padding-left: 1.5rem;
            }
            .info-card ul li,
            .info-card ol li {
                margin-bottom: 0.75rem;
                line-height: 1.8;
                color: #334155;
                font-size: 1.02rem;
            }
            .info-card ul li::marker {
                color: #3b82f6;
                font-weight: 700;
            }
            .info-card p {
                color: #334155;
                line-height: 1.8;
                font-size: 1.02rem;
            }

            .channel-analysis-item {
                display: flex;
                align-items: center;
                margin-bottom: 0.75rem;
                padding: 0.5rem 0;
            }
            .channel-analysis-item span {
                width: 110px;
                font-weight: 500;
                flex-shrink: 0;
                color: #333d52;
            }
            .channel-analysis-item .bar {
                flex-grow: 1;
                height: 12px;
                border-radius: 6px;
                overflow: hidden;
                background: #e9ecef;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            .channel-analysis-item .bar-fill {
                border-radius: 6px;
                transition: width 0.8s ease-out;
            }
            .channel-analysis-item .bar-fill.low {
                background: linear-gradient(90deg, #28a745, #34ce57);
            }
            .channel-analysis-item .bar-fill.medium {
                background: linear-gradient(90deg, #ffc107, #ffcd38);
            }
            .channel-analysis-item .bar-fill.high {
                background: linear-gradient(90deg, #dc3545, #e74c5c);
            }

            /* Chart containers */
            .chart-container {
                position: relative;
                margin: 2rem auto;
                padding: 3rem 2.5rem;
                background: linear-gradient(135deg, #fafbff 0%, #f0f4ff 50%, #ffffff 100%);
                border-radius: 24px;
                box-shadow:
                    0 12px 24px -6px rgba(59, 130, 246, 0.15),
                    0 6px 12px -3px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 0 rgba(255, 255, 255, 0.95);
                border: 2px solid rgba(59, 130, 246, 0.2);
                overflow: visible;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .chart-container:hover {
                box-shadow:
                    0 24px 40px -10px rgba(59, 130, 246, 0.22),
                    0 12px 20px -6px rgba(0, 0, 0, 0.12),
                    inset 0 1px 0 0 rgba(255, 255, 255, 1);
                transform: translateY(-6px) scale(1.02);
                border-color: rgba(59, 130, 246, 0.4);
            }
            .chart-container.small {
                max-width: 650px;
                min-height: 450px;
            }
            .chart-container.medium {
                max-width: 850px;
                min-height: 550px;
            }
            .chart-container.large {
                width: 100%;
                min-height: 600px;
            }
            .chart-container canvas {
                max-width: 100%;
                max-height: 100%;
                filter: drop-shadow(0 8px 16px rgba(59, 130, 246, 0.12));
            }
            .chart-title {
                text-align: center;
                font-weight: 700;
                background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 2.5rem;
                font-size: 1.5rem;
                letter-spacing: -0.03em;
                position: relative;
                padding-bottom: 1rem;
            }
            .chart-title::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 100px;
                height: 5px;
                background: linear-gradient(90deg, transparent, #3b82f6, #60a5fa, transparent);
                border-radius: 3px;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }

            .button-group-report {
                margin-top: 2rem;
                text-align: center;
                display: flex;
                justify-content: center;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .report-disclaimer {
                display: flex;
                align-items: flex-start;
                gap: 1rem;
                background-color: #f8f9fa;
                padding: 1.5rem;
                border-radius: 12px;
                margin-top: 2rem;
                border-left: 4px solid #3b82f6;
                text-align: left;
            }
            .report-disclaimer i {
                color: #3b82f6;
                font-size: 1.5rem;
                margin-top: 3px;
            }
            .report-disclaimer p {
                font-size: 0.9rem;
                margin: 0;
            }

            /* Mobile metric cards - hidden by default, shown on mobile */
            .metrics-list-container {
                display: none;
                margin: 1.5rem 0;
            }

            .metric-card {
                background: white;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                border: 1px solid #e2e8f0;
            }

            .metric-card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            .metric-label {
                font-weight: 600;
                font-size: 0.95rem;
                color: #1e293b;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .metric-value {
                font-weight: 700;
                font-size: 1rem;
                color: #334155;
            }

            .progress-bar {
                width: 100%;
                height: 10px;
                background: #e9ecef;
                border-radius: 6px;
                overflow: hidden;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            .progress-bar-fill {
                height: 100%;
                border-radius: 6px;
                transition: width 0.8s ease-out;
            }

            .progress-bar-fill.high {
                background: linear-gradient(90deg, var(--status-critical-color), #e74c5c);
            }

            .progress-bar-fill.medium {
                background: linear-gradient(90deg, var(--status-high-color), #ffcd38);
            }

            .progress-bar-fill.low {
                background: linear-gradient(90deg, var(--status-low-color), #34ce57);
            }

            .metric-status {
                margin-top: 0.5rem;
                font-size: 0.85rem;
                color: #64748b;
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            /* КЛЮЧОВА ПРОМЯНА: Оптимизирани медийни заявки за мобилна визия */
            @media (max-width: 767px) {
                /* Hide desktop charts, show mobile metric cards */
                .report-section .chart-container,
                .content .chart-container {
                    display: none;
                }

                .metrics-list-container {
                    display: block;
                }

                /* Show visual composite on mobile only */
                .visual-composite-container {
                    display: block;
                    padding: 1.5rem;
                    margin: 1.5rem auto;
                    max-width: 100%;
                }

                .container {
                    padding: 1rem;
                }
                .report-header h2 {
                    font-size: 1.75rem;
                    line-height: 1.3;
                }
                .report-header p {
                    font-size: 1rem;
                }
                .report-hero {
                    padding: 1.75rem;
                    border-radius: 12px;
                }
                .report-hero h3 {
                    font-size: 1.25rem;
                    line-height: 1.4;
                }
                .report-hero p {
                    font-size: 0.95rem;
                }

                /* Подобрени секции за мобилни устройства */
                .report-section {
                    border-radius: 12px;
                    margin-bottom: 1.5rem;
                    border-width: 2px;
                }
                .report-section summary {
                    padding: 1.25rem 1.5rem;
                    font-size: 1.1rem;
                    line-height: 1.4;
                    /* Touch-friendly tap area */
                    min-height: 60px;
                }
                .report-section summary:active {
                    background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
                }
                .report-section summary .icon-circle {
                    min-width: 40px;
                    height: 40px;
                    font-size: 1rem;
                    margin-right: 1rem;
                }
                .report-section summary .arrow {
                    font-size: 1rem;
                }
                .report-section .content {
                    padding: 0 1.5rem 1.5rem 1.5rem;
                    font-size: 0.95rem;
                    line-height: 1.75;
                }
                .report-section .content h4 {
                    font-size: 1.05rem;
                    margin-top: 1.5rem;
                }
                .report-section .content p {
                    font-size: 0.95rem;
                }
                .report-section .content ul li,
                .report-section .content ol li {
                    font-size: 0.95rem;
                    margin-bottom: 0.75rem;
                }

                /* Оптимизирани карти за мобилни */
                .report-grid {
                    grid-template-columns: 1fr;
                    gap: 1.5rem;
                }
                .info-card {
                    padding: 1.5rem;
                    border-radius: 14px;
                    border-width: 2px;
                }
                .info-card::before {
                    width: 4px;
                }
                .info-card h4 {
                    font-size: 1.1rem;
                    margin-bottom: 1rem;
                }
                .info-card h4 i {
                    font-size: 1.25rem;
                }
                .info-card ul,
                .info-card ol {
                    padding-left: 1.25rem;
                }
                .info-card ul li,
                .info-card ol li {
                    font-size: 0.95rem;
                    line-height: 1.75;
                }
                .info-card p {
                    font-size: 0.95rem;
                    line-height: 1.75;
                }

                /* Подобрени канални анализи за мобилни */
                .channel-analysis-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.5rem;
                }
                .channel-analysis-item span {
                    width: 100%;
                    font-size: 0.95rem;
                    font-weight: 600;
                }
                .channel-analysis-item .bar {
                    width: 100%;
                    height: 12px;
                }

                /* Оптимизирани графики за мобилни устройства */
                .chart-container {
                    padding: 2rem 1.25rem;
                    border-radius: 20px;
                    margin: 1.5rem 0;
                    min-height: 350px;
                    border-width: 2px;
                }
                .chart-container.small,
                .chart-container.medium,
                .chart-container.large {
                    min-height: 380px;
                    max-width: 100%;
                }
                .chart-title {
                    font-size: 1.2rem;
                    margin-bottom: 1.5rem;
                    line-height: 1.3;
                }
                .chart-title::after {
                    width: 60px;
                    height: 4px;
                }

                /* Touch-friendly бутони */
                .button-group-report {
                    flex-direction: column;
                    gap: 1rem;
                    margin-top: 2rem;
                }
                .button-group-report .btn,
                .button-group-report a {
                    width: 100%;
                    min-height: 48px;
                    font-size: 1rem;
                    border-radius: 12px;
                }

                /* Оптимизиран disclaimer за мобилни */
                .report-disclaimer {
                    padding: 1.25rem;
                    font-size: 0.9rem;
                    line-height: 1.6;
                    border-radius: 10px;
                }
                .report-disclaimer i {
                    font-size: 1.25rem;
                }
            }

            /* Оптимизации за много малки екрани */
            @media (max-width: 480px) {
                .container {
                    padding: 0.75rem;
                }
                .report-header h2 {
                    font-size: 1.5rem;
                }
                .report-hero {
                    padding: 1.5rem;
                }
                .report-section summary {
                    padding: 1rem 1.25rem;
                    font-size: 1rem;
                }
                .report-section .content {
                    padding: 0 1.25rem 1.25rem 1.25rem;
                }
                .info-card {
                    padding: 1.25rem;
                }
                .chart-container {
                    padding: 1.5rem 1rem;
                    min-height: 320px;
                }
                .chart-title {
                    font-size: 1.1rem;
                }

                /* Visual composite optimizations for very small screens */
                .visual-composite-container {
                    padding: 1rem;
                    margin: 1rem auto;
                }

                .visual-composite-container h3 {
                    font-size: 1.1rem !important;
                    margin-bottom: 1rem !important;
                }

                .alignment-info {
                    font-size: 0.8rem;
                    padding: 0.75rem;
                }

                /* Enhance SVG visibility on small screens */
                .iris-overlay-svg .overlay-ring {
                    stroke-width: 2.5;
                    stroke-opacity: 0.5;
                }

                .iris-overlay-svg .overlay-outer {
                    stroke-width: 5;
                }

                .iris-overlay-svg .overlay-sector-line {
                    stroke-width: 1.5;
                    stroke-opacity: 0.35;
                }

                .iris-overlay-svg .overlay-number {
                    font-size: 28px;
                }

                .sign-marker {
                    width: 14px;
                    height: 14px;
                    border-width: 2.5px;
                }
            }

            /* Visual Composite Styles - Shown on mobile, hidden on desktop */
            .visual-composite-container {
                position: relative;
                width: 100%;
                max-width: 700px;
                margin: 2rem auto;
                padding: 2rem;
                background: linear-gradient(135deg, #0f1820 0%, #1a2332 100%);
                border-radius: 20px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                overflow: hidden;
            }

            /* Desktop view - show charts, hide mobile cards and visual composite */
            @media (min-width: 768px) {
                .chart-container {
                    display: block;
                }

                .report-section .metrics-list-container,
                .content .metrics-list-container {
                    display: none;
                }

                /* Hide visual composite on desktop */
                .visual-composite-container {
                    display: none;
                }
            }

            .visual-composite {
                position: relative;
                width: 100%;
                padding-top: 100%; /* 1:1 aspect ratio */
                background: #000;
                border-radius: 12px;
                overflow: hidden;
            }

            .visual-composite-inner {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #iris-image {
                position: absolute;
                max-width: none;
                transform-origin: center center;
                will-change: transform;
                pointer-events: none;
            }

            .iris-overlay-svg {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: min(92%, 640px);
                height: min(92%, 640px);
                pointer-events: none;
                z-index: 10;
            }

            .iris-overlay-svg .overlay-ring {
                stroke: #ff00cc;
                stroke-width: 2;
                stroke-opacity: 0.4;
                fill: none;
            }

            .iris-overlay-svg .overlay-outer {
                stroke: #ff00cc;
                stroke-width: 4;
                fill: none;
            }

            .iris-overlay-svg .overlay-sector-line {
                stroke: #ff00cc;
                stroke-width: 1.2;
                stroke-opacity: 0.28;
            }

            .iris-overlay-svg .overlay-number {
                font:
                    700 32px/1 Arial,
                    Helvetica,
                    sans-serif;
                fill: #ff00cc;
                text-anchor: middle;
                dominant-baseline: middle;
            }

            .iris-overlay-svg .overlay-center {
                fill: #ff00cc;
            }

            .sign-marker {
                position: absolute;
                width: 12px;
                height: 12px;
                background: #ffd700;
                border: 2px solid #fff;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
                z-index: 20;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            #sign-markers-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none; /* Позволява кликове да преминават към изображението */
            }

            #sign-markers-container .sign-marker {
                pointer-events: auto; /* Маркерите са кликваеми */
            }

            .sign-marker:hover {
                transform: translate(-50%, -50%) scale(1.5);
                box-shadow: 0 0 20px rgba(255, 215, 0, 1);
            }

            .sign-marker-tooltip {
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                margin-bottom: 8px;
                padding: 8px 12px;
                background: rgba(0, 0, 0, 0.9);
                color: #fff;
                font-size: 12px;
                border-radius: 6px;
                white-space: nowrap;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: 30;
            }

            .sign-marker:hover .sign-marker-tooltip {
                opacity: 1;
            }

            .alignment-info {
                margin-top: 1rem;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                font-size: 0.9rem;
                color: rgba(255, 255, 255, 0.7);
            }

            .alignment-info .confidence-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-weight: 600;
                font-size: 0.85rem;
                margin-left: 8px;
            }

            .alignment-info .confidence-high {
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
                border: 1px solid #10b981;
            }

            .alignment-info .confidence-medium {
                background: rgba(251, 191, 36, 0.2);
                color: #fbbf24;
                border: 1px solid #fbbf24;
            }

            .alignment-info .confidence-low {
                background: rgba(239, 68, 68, 0.2);
                color: #ef4444;
                border: 1px solid #ef4444;
            }

            /* Print styles for PDF export */
            @media print {
                body {
                    background: white;
                }
                .container {
                    padding: 0;
                    max-width: 100%;
                }
                .button-group-report {
                    display: none;
                }
                .report-header {
                    color: #1a253c;
                }
                .report-header h2,
                .report-header p {
                    color: #1a253c;
                    text-shadow: none;
                }
                details.report-section {
                    border: 1px solid #ddd;
                }
                details.report-section summary {
                    page-break-inside: avoid;
                }
                details.report-section .content {
                    page-break-inside: avoid;
                }
                .report-section {
                    page-break-inside: avoid;
                    margin-bottom: 1rem;
                }
                .info-card {
                    page-break-inside: avoid;
                }
                .visual-composite-container {
                    display: block !important; /* Show on print/PDF */
                    page-break-inside: avoid;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <section class="analysis-section" style="padding-top: 2rem">
                <header class="report-header">
                    <h2 class="fade-in-up">Иридиологичен Доклад</h2>
                    <p class="fade-in-up delay-1">Пътят към вашето здраве започва тук.</p>
                </header>

                <article id="report-container" class="fade-in-up delay-2">
                    <!-- Съдържанието се генерира от JavaScript -->
                </article>

                <div id="message-box"></div>

                <div class="button-group-report">
                    <button
                        id="print-btn"
                        class="btn btn-primary fade-in-up delay-3"
                        title="Принтирайте или запазете като PDF"
                    >
                        <i class="fas fa-file-pdf"></i> Запази PDF
                    </button>
                    <button id="re-analyze-btn" class="btn btn-secondary fade-in-up delay-3">
                        Повтори анализа
                    </button>
                    <a href="analysis.html" class="btn btn-secondary fade-in-up delay-3"
                        >Нов анализ</a
                    >
                </div>
            </section>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
        <script type="module">
            import { WORKER_URL } from './config.js';

            // *** КЛЮЧОВА ПРОМЯНА: Актуализирана конфигурация на секциите ***
            const ICONS_CONFIG = {
                'Резюме на анализа': { icon: 'fa-file-medical', color: '#06b6d4' },
                'Конституционален анализ': { icon: 'fa-shield-halved', color: '#3b82f6' },
                'Приоритетни системи за подкрепа': { icon: 'fa-heart-pulse', color: '#ef4444' },
                'Анализ на елиминативните канали': { icon: 'fa-recycle', color: '#10b981' },
                'Ключови находки и тяхната връзка': {
                    icon: 'fa-project-diagram',
                    color: '#8b5cf6'
                },
                'План за действие': { icon: 'fa-list-check', color: '#14b8a6' },
                'Специални хранителни насоки': { icon: 'fa-apple-alt', color: '#f97316' },
                'Препоръки за билки и добавки': { icon: 'fa-leaf', color: '#059669' },
                'Холистични препоръки': { icon: 'fa-seedling', color: '#f59e0b' },
                'Фундаментални принципи': { icon: 'fa-lightbulb', color: '#1d4ed8' },
                'Целенасочени препоръки': { icon: 'fa-bullseye', color: '#c2410c' },
                'Психология и емоции': { icon: 'fa-brain', color: '#be185d' },
                'Препоръки за проследяване': { icon: 'fa-calendar-check', color: '#7c3aed' },
                default: { icon: 'fa-circle-info', color: '#6b7280' }
            };

            // Функция за форматиране на Markdown към HTML
            function formatTextContent(text) {
                if (text == null) return '';
                if (Array.isArray(text)) {
                    return `<ul>${text.map((item) => `<li>${formatTextContent(item)}</li>`).join('')}</ul>`;
                }
                if (typeof text === 'object') {
                    const main = formatTextContent(text.text || Object.values(text).join(' '));
                    const source = text.source
                        ? `<p><em>Източник: ${DOMPurify.sanitize(text.source)}</em></p>`
                        : '';
                    return main + source;
                }
                let sanitizedText = DOMPurify.sanitize(String(text), {
                    USE_PROFILES: { html: false }
                });
                // Replace escaped newlines with actual newlines
                sanitizedText = sanitizedText.replace(/\\n/g, '\n');
                // Replace ** with <strong> for bold text
                let html = sanitizedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                const blocks = html.split(/\n\s*\n/);
                const processedBlocks = blocks.map((block) => {
                    block = block.trim();
                    if (!block) return '';
                    const isUnorderedList = /^\*/.test(block);
                    const isOrderedList = /^\d+\./.test(block);
                    if (isUnorderedList) {
                        const items = block
                            .split('\n')
                            .map((line) => `<li>${line.replace(/^\*\s*/, '').trim()}</li>`)
                            .join('');
                        return `<ul>${items}</ul>`;
                    } else if (isOrderedList) {
                        const items = block
                            .split('\n')
                            .map((line) => `<li>${line.replace(/^\d+\.\s*/, '').trim()}</li>`)
                            .join('');
                        return `<ol>${items}</ol>`;
                    } else {
                        return `<p>${block.replace(/\n/g, '<br>')}</p>`;
                    }
                });
                return processedBlocks.join('');
            }

            /**
             * Осигурява че стойността е валидно число
             * @param {any} value - Стойността за конвертиране
             * @param {number} defaultValue - Стойност по подразбиране, ако конвертирането не е успешно
             * @returns {number} - Валидно число
             */
            function ensureNumber(value, defaultValue = 0) {
                const num = Number(value);
                return isFinite(num) ? num : defaultValue;
            }

            /**
             * Създава визуален композит с изображение на ириса и SVG overlay
             * @param {Object} leftEyeData - Данни за лявото око (alignment + identified_signs)
             * @param {Object} rightEyeData - Данни за дясното око
             * @returns {HTMLElement|null} - Контейнер с визуалния композит или null ако няма данни
             */
            function createVisualComposite(leftEyeData, rightEyeData) {
                // Проверка дали има alignment данни
                if (!leftEyeData?.alignment && !rightEyeData?.alignment) {
                    console.log('Няма alignment данни за визуален композит');
                    return null;
                }

                const container = document.createElement('div');
                container.className = 'visual-composite-container';

                // Избираме данните с по-висока confidence
                const eyeData =
                    (leftEyeData?.alignment?.confidence || 0) >=
                    (rightEyeData?.alignment?.confidence || 0)
                        ? leftEyeData
                        : rightEyeData;

                const alignment = eyeData.alignment;
                const signs = eyeData.identified_signs || [];
                const eyeLabel = eyeData.eye || 'око';

                // Sanitize user inputs to prevent XSS
                const safeEyeLabel = DOMPurify.sanitize(eyeLabel);

                container.innerHTML = `
                    <h3 style="text-align: center; color: #fff; margin-bottom: 1.5rem; font-size: 1.3rem;">
                        <i class="fas fa-eye" style="margin-right: 0.5rem;"></i>
                        Визуализация на ириса с топографски шаблон (${safeEyeLabel})
                    </h3>
                    <div class="visual-composite">
                        <div class="visual-composite-inner">
                            <img id="iris-image" alt="Iris">
                            <svg class="iris-overlay-svg" viewBox="-380 -380 760 760" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feGaussianBlur stdDeviation="3.2" result="blur"/>
                                        <feMerge>
                                            <feMergeNode in="blur"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>
                                </defs>
                                
                                <!-- Inner and middle zone rings -->
                                <circle r="112" class="overlay-ring"/>
                                <circle r="256" class="overlay-ring"/>
                                
                                <!-- Sector lines (12 sectors) -->
                                <g class="overlay-sector-lines">
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(0)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(30)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(60)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(90)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(120)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(150)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(180)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(210)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(240)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(270)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(300)"/>
                                    <line x1="0" y1="0" x2="0" y2="-348" class="overlay-sector-line" transform="rotate(330)"/>
                                </g>
                                
                                <!-- Numbers (12 hour positions) -->
                                <g class="overlay-numbers">
                                    <text x="0" y="-372" class="overlay-number">12</text>
                                    <text x="186" y="-322" class="overlay-number">1</text>
                                    <text x="322" y="-186" class="overlay-number">2</text>
                                    <text x="372" y="0" class="overlay-number">3</text>
                                    <text x="322" y="186" class="overlay-number">4</text>
                                    <text x="186" y="322" class="overlay-number">5</text>
                                    <text x="0" y="372" class="overlay-number">6</text>
                                    <text x="-186" y="322" class="overlay-number">7</text>
                                    <text x="-322" y="186" class="overlay-number">8</text>
                                    <text x="-372" y="0" class="overlay-number">9</text>
                                    <text x="-322" y="-186" class="overlay-number">10</text>
                                    <text x="-186" y="-322" class="overlay-number">11</text>
                                </g>
                                
                                <!-- Outer ring and center -->
                                <circle r="320" class="overlay-outer" filter="url(#glow)"/>
                                <circle r="8" class="overlay-center" filter="url(#glow)"/>
                                <g stroke-opacity="0.22">
                                    <line x1="-16" y1="0" x2="16" y2="0" class="overlay-sector-line"/>
                                    <line x1="0" y1="-16" x2="0" y2="16" class="overlay-sector-line"/>
                                </g>
                            </svg>
                            <div id="sign-markers-container"></div>
                        </div>
                    </div>
                    <div class="alignment-info">
                        <strong><i class="fas fa-user-check"></i> Информация за центрирането:</strong> 
                        Изображението е центрирано и оразмерено <strong>ръчно от потребителя</strong> при качването.
                        <br>
                        <span class="confidence-badge confidence-high">
                            <i class="fas fa-check-circle"></i> Потребителско центриране
                        </span>
                        <br>
                        <em style="font-size: 0.85rem;">Изображението се показва директно без автоматични корекции, за да запази точността на ръчното позициониране.</em>
                    </div>
                `;

                // Apply image transformation after insertion into DOM
                requestAnimationFrame(() => {
                    applyIrisTransformation(alignment, signs);
                });

                return container;
            }

            /**
             * Зарежда центрираното от потребителя изображение на ириса
             * Използва директно изображението без допълнителни трансформации,
             * тъй като потребителят вече е центрирал и оразмерил снимката
             * @param {Object} alignment - Обект с center_x, center_y, radius_px (използва се за информация)
             * @param {Array} signs - Масив с идентифицирани знаци
             */
            function applyIrisTransformation(alignment, signs) {
                const img = document.getElementById('iris-image');
                if (!img) return;

                // Опит да заредим центрираното от потребителя изображение от localStorage
                try {
                    const formData = localStorage.getItem('iridologyFormData');
                    if (formData) {
                        const data = JSON.parse(formData);
                        // Търсим изображение (left или right eye)
                        const imageData = data['left-eye-upload'] || data['right-eye-upload'];
                        if (
                            imageData &&
                            typeof imageData === 'string' &&
                            imageData.startsWith('data:')
                        ) {
                            img.src = imageData;
                            img.onload = () => {
                                // Получаване на размерите на контейнера
                                const container = img.parentElement;
                                const containerWidth = container.clientWidth;
                                const containerHeight = container.clientHeight;

                                // Използваме изображението директно без трансформация,
                                // тъй като потребителят вече го е центрирал и оразмерил правилно
                                // Само го центрираме в контейнера
                                const imgAspect = img.naturalWidth / img.naturalHeight;
                                let displayWidth, displayHeight;
                                
                                if (imgAspect > 1) {
                                    displayWidth = containerWidth;
                                    displayHeight = containerWidth / imgAspect;
                                } else {
                                    displayHeight = containerHeight;
                                    displayWidth = containerHeight * imgAspect;
                                }

                                img.style.width = displayWidth + 'px';
                                img.style.height = displayHeight + 'px';
                                img.style.transform = 'none';
                                img.style.left = (containerWidth - displayWidth) / 2 + 'px';
                                img.style.top = (containerHeight - displayHeight) / 2 + 'px';

                                // Рендиране на маркери за знаците
                                if (signs && signs.length > 0) {
                                    renderSignMarkers(
                                        signs,
                                        containerWidth / 2,
                                        containerHeight / 2,
                                        Math.min(displayWidth, displayHeight) * 0.4 // Приблизителен радиус за маркерите
                                    );
                                }
                            };
                        }
                    }
                } catch (e) {
                    console.error('Грешка при зареждане на изображение:', e);
                }
            }

            /**
             * Рендира маркери за идентифицираните знаци
             * @param {Array} signs - Масив с идентифицирани знаци
             * @param {number} centerX - X координата на центъра в контейнера
             * @param {number} centerY - Y координата на центъра в контейнера
             * @param {number} radius - Радиусът на външния пръстен (320px)
             */
            function renderSignMarkers(signs, centerX, centerY, radius) {
                const container = document.getElementById('sign-markers-container');
                if (!container) return;

                container.innerHTML = ''; // Изчистваме предишни маркери

                signs.forEach((sign, index) => {
                    if (!sign.sector || !sign.zone) return;

                    // Изчисляване на позиция базирана на sector и zone
                    const sector = parseInt(sign.sector);
                    if (isNaN(sector) || sector < 1 || sector > 12) return;

                    // Преобразуване на sector в ъгъл за часовникова стрелка (12 = 0°, 3 = 90°, 6 = 180°, 9 = 270°)
                    const angle = (sector - 12) * 30 * (Math.PI / 180);

                    // Определяне на радиалната дистанция базирана на zone
                    let zoneRadius;
                    const zone = sign.zone.toLowerCase();
                    if (zone === 'inner') {
                        zoneRadius = radius * 0.25; // Зона 1-2 (25% от радиуса)
                    } else if (zone === 'ciliary') {
                        zoneRadius = radius * 0.6; // Зона 3-5 (60% от радиуса)
                    } else if (zone === 'outer') {
                        zoneRadius = radius * 0.9; // Зона 6-7 (90% от радиуса)
                    } else {
                        zoneRadius = radius * 0.5; // Default
                    }

                    // Изчисляване на позиция
                    const x = centerX + Math.cos(angle) * zoneRadius;
                    const y = centerY - Math.sin(angle) * zoneRadius; // Минус защото Y расте надолу

                    // Създаване на маркер
                    const marker = document.createElement('div');
                    marker.className = 'sign-marker';
                    marker.style.left = `${x}px`;
                    marker.style.top = `${y}px`;

                    // Добавяне на tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'sign-marker-tooltip';
                    tooltip.textContent = sign.sign_name || `Знак ${index + 1}`;
                    marker.appendChild(tooltip);

                    container.appendChild(marker);
                });
            }

            function renderReport(data) {
                const container = document.getElementById('report-container');
                container.innerHTML = '';

                const hero = document.createElement('div');
                hero.className = 'report-hero';
                hero.innerHTML = `
                <h3>Персонален анализ за <span style="color: #0056b3;">${DOMPurify.sanitize(data['Име'] || 'Клиент')}</span></h3>
                <p>Дата на генериране: ${new Date().toLocaleDateString('bg-BG')}</p>
            `;
                container.appendChild(hero);

                // Добавяме резюме ако е налично
                if (data['Резюме на анализа']) {
                    const summaryBox = document.createElement('div');
                    summaryBox.className = 'report-hero';
                    summaryBox.style.background =
                        'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';
                    summaryBox.style.borderLeft = '4px solid #f59e0b';
                    summaryBox.innerHTML = `
                    <h3 style="color: #92400e; margin-bottom: 0.75rem;"><i class="fas fa-file-medical" style="margin-right: 0.5rem;"></i>Резюме</h3>
                    <div style="color: #78350f; font-size: 1.05rem; line-height: 1.7; text-align: left;">${formatTextContent(data['Резюме на анализа'])}</div>
                `;
                    container.appendChild(summaryBox);
                }

                // Добавяме визуален композит ако има alignment данни
                // Проверяваме дали има _analytics данни с информация за очите
                if (data._analytics || data.left_eye_analysis || data.right_eye_analysis) {
                    const leftEyeData = data.left_eye_analysis || {};
                    const rightEyeData = data.right_eye_analysis || {};

                    const visualComposite = createVisualComposite(leftEyeData, rightEyeData);
                    if (visualComposite) {
                        container.appendChild(visualComposite);
                    }
                }

                const sectionOrder = [
                    'Конституционален анализ',
                    'Приоритетни системи за подкрепа',
                    'Анализ на елиминативните канали',
                    'Ключови находки и тяхната връзка',
                    'План за действие',
                    'Специални хранителни насоки',
                    'Препоръки за билки и добавки',
                    'Холистични препоръки',
                    'Препоръки за проследяване'
                ];

                sectionOrder.forEach((key) => {
                    const content = data[key];
                    if (content) {
                        let section;
                        if (key === 'Холистични препоръки') {
                            section = createRecommendationsSection(key, content);
                        } else if (key === 'Специални хранителни насоки') {
                            section = createNutritionalGuidelinesSection(key, content);
                        } else if (key === 'Препоръки за билки и добавки') {
                            section = createHerbsSupplementsSection(key, content);
                        } else if (
                            key === 'Анализ на елиминативните канали' &&
                            typeof content === 'string'
                        ) {
                            section = createChannelsSection(key, content);
                        } else if (key === 'Приоритетни системи за подкрепа') {
                            section = createPrioritySystemsSection(key, content);
                        } else {
                            section = createCollapsibleSection(
                                key,
                                formatTextContent(content),
                                false
                            );
                        }
                        container.appendChild(section);
                    }
                });

                if (data['Задължителен отказ от отговорност']) {
                    const disclaimer = document.createElement('footer');
                    disclaimer.className = 'report-disclaimer';
                    disclaimer.innerHTML = `<i class="fas fa-info-circle"></i>${formatTextContent(data['Задължителен отказ от отговорност'])}`;
                    container.appendChild(disclaimer);
                }
            }

            function createCollapsibleSection(title, contentHTML, defaultOpen = false) {
                const config = ICONS_CONFIG[title] || ICONS_CONFIG['default'];
                const details = document.createElement('details');
                details.className = 'report-section';
                // Only open by default if explicitly requested (not for regular sections)
                if (defaultOpen) {
                    details.setAttribute('open', '');
                }
                details.innerHTML = `
                <summary>
                    <div class="summary-title">
                        <span class="icon-circle" style="background-color: ${config.color};"><i class="fas ${config.icon}"></i></span>
                        <span>${DOMPurify.sanitize(title)}</span>
                    </div>
                    <i class="fas fa-chevron-down arrow"></i>
                </summary>
                <div class="content">${contentHTML}</div>
            `;
                return details;
            }

            function createRecommendationsSection(title, recommendationsData) {
                if (!recommendationsData || typeof recommendationsData !== 'object')
                    return document.createElement('div');
                let subSectionsHTML = '';

                // За да подредим препоръките, дефинираме ред
                const recommendationOrder = [
                    'Фундаментални принципи',
                    'Целенасочени препоръки',
                    'Психология и емоции'
                ];
                const sortedKeys = Object.keys(recommendationsData).sort((a, b) => {
                    const indexA = recommendationOrder.indexOf(a);
                    const indexB = recommendationOrder.indexOf(b);
                    if (indexA === -1) return 1; // ако не е в списъка, слагаме го накрая
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                sortedKeys.forEach((key) => {
                    const value = recommendationsData[key];
                    const config = ICONS_CONFIG[key] || ICONS_CONFIG['default'];
                    const formattedValue = formatTextContent(value);
                    subSectionsHTML += `
                    <div class="info-card">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>${DOMPurify.sanitize(key)}</h4>
                        <div class="recommendation-content">${formattedValue}</div>
                    </div>
                `;
                });
                const contentHTML = `<div class="report-grid">${subSectionsHTML}</div>`;
                return createCollapsibleSection(title, contentHTML, false);
            }

            function createNutritionalGuidelinesSection(title, nutritionData) {
                if (!nutritionData || typeof nutritionData !== 'object')
                    return document.createElement('div');
                let contentHTML = '<div class="report-grid">';

                // Foods to limit
                if (nutritionData['Храни за ограничаване']) {
                    const config = { icon: 'fa-ban', color: '#dc2626' };
                    const formattedValue = formatTextContent(
                        nutritionData['Храни за ограничаване']
                    );
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #dc2626;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>Храни за ограничаване</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                // Foods to add
                if (nutritionData['Храни за добавяне']) {
                    const config = { icon: 'fa-plus-circle', color: '#16a34a' };
                    const formattedValue = formatTextContent(nutritionData['Храни за добавяне']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #16a34a;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>Храни за добавяне</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                contentHTML += '</div>';
                return createCollapsibleSection(title, contentHTML, false);
            }

            function createHerbsSupplementsSection(title, herbsData) {
                if (!herbsData || typeof herbsData !== 'object')
                    return document.createElement('div');
                let contentHTML = '<div class="report-grid">';

                // Herbal recommendations
                if (herbsData['Билкови препоръки']) {
                    const config = { icon: 'fa-seedling', color: '#059669' };
                    const formattedValue = formatTextContent(herbsData['Билкови препоръки']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #059669;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>Билкови препоръки</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                // Nutritional supplements
                if (herbsData['Хранителни добавки']) {
                    const config = { icon: 'fa-capsules', color: '#0891b2' };
                    const formattedValue = formatTextContent(herbsData['Хранителни добавки']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #0891b2;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>Хранителни добавки</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                // Homeopathic remedies
                if (herbsData['Хомеопатични средства']) {
                    const config = { icon: 'fa-flask', color: '#7c3aed' };
                    const formattedValue = formatTextContent(herbsData['Хомеопатични средства']);
                    contentHTML += `
                    <div class="info-card" style="border-left: 3px solid #7c3aed;">
                        <h4><i class="fas ${config.icon}" style="color: ${config.color}; margin-right: 0.75rem;"></i>Хомеопатични средства</h4>
                        <div>${formattedValue}</div>
                    </div>
                `;
                }

                contentHTML += '</div>';
                return createCollapsibleSection(title, contentHTML, false);
            }

            // --- MOBILE METRIC CARD FUNCTIONS ---

            /**
             * Parse chart data from text content to extract metrics
             * @param {string} content - The text content to parse
             * @param {string} type - Type of chart ('systems' or 'channels')
             * @returns {Array} Array of metric objects with name, value, and status
             */
            function parseChartData(content, type) {
                const text = content && typeof content === 'string' ? content.toLowerCase() : '';

                if (type === 'systems') {
                    // Priority calculation constants
                    const PRIORITY_MULTIPLIER = 25;
                    const PRIORITY_BASE = 35;
                    const PRIORITY_MAX_BASE = 85;
                    const SEVERITY_BONUS_HIGH = 15;
                    const SEVERITY_BONUS_MEDIUM = 8;

                    const systemKeywords = [
                        {
                            name: 'Храносмилателна',
                            keywords: ['храносмилат', 'черва', 'стомах'],
                            icon: '🟠'
                        },
                        { name: 'Нервна', keywords: ['нервн', 'стрес', 'мозък'], icon: '🟣' },
                        { name: 'Лимфна', keywords: ['лимфа', 'имун'], icon: '🟢' },
                        {
                            name: 'Сърдечно-съдова',
                            keywords: ['сърдечн', 'кръв', 'съдов'],
                            icon: '🔴'
                        },
                        { name: 'Дихателна', keywords: ['дихат', 'белодробн'], icon: '🔵' },
                        {
                            name: 'Елиминативна',
                            keywords: ['детокс', 'бъбрек', 'елиминат'],
                            icon: '🟡'
                        },
                        { name: 'Хормонална', keywords: ['хормон', 'ендокрин'], icon: '🟣' },
                        { name: 'Метаболична', keywords: ['метаболи', 'енерги'], icon: '🟠' }
                    ];

                    const metrics = [];
                    systemKeywords.forEach((sys) => {
                        const matchCount = sys.keywords.filter((kw) => text.includes(kw)).length;
                        if (matchCount > 0) {
                            // Calculate base priority using defined constants
                            let value = Math.min(
                                matchCount * PRIORITY_MULTIPLIER + PRIORITY_BASE,
                                PRIORITY_MAX_BASE
                            );

                            // Check for severity modifiers and apply bonuses
                            if (
                                text.includes('приоритетн') ||
                                text.includes('критичн') ||
                                text.includes('важн')
                            ) {
                                value = Math.min(value + SEVERITY_BONUS_HIGH, 100);
                            } else if (text.includes('умерен') || text.includes('средн')) {
                                value = Math.min(value + SEVERITY_BONUS_MEDIUM, 100);
                            }

                            let status = value >= 70 ? 'high' : value >= 50 ? 'medium' : 'low';
                            metrics.push({ name: sys.name, value, status, icon: sys.icon });
                        }
                    });

                    return metrics.length > 0
                        ? metrics
                        : systemKeywords.slice(0, 5).map((sys) => ({
                              name: sys.name,
                              value: 50,
                              status: 'medium',
                              icon: sys.icon
                          }));
                } else if (type === 'channels') {
                    const channels = [
                        { name: 'Черва', keyword: 'черва', icon: '🔄' },
                        { name: 'Бъбреци', keyword: 'бъбрек', icon: '💧' },
                        { name: 'Лимфа', keyword: 'лимфа', icon: '🌊' },
                        { name: 'Кожа', keyword: 'кожа', icon: '✨' },
                        { name: 'Бели дробове', keyword: 'бели дробове', icon: '💨' }
                    ];

                    return channels.map((ch) => {
                        const keyword = ch.keyword.toLowerCase();
                        let value = 20;

                        if (text.includes(keyword)) {
                            if (
                                text.includes('най-натоварен') ||
                                text.includes('силно натоварен')
                            ) {
                                value = 85;
                            } else if (text.includes('умерен') || text.includes('средн')) {
                                value = 60;
                            } else {
                                value = 40;
                            }
                        }

                        const status = value >= 70 ? 'high' : value >= 50 ? 'medium' : 'low';
                        return { name: ch.name, value, status, icon: ch.icon };
                    });
                }

                return [];
            }

            /**
             * Create mobile metric cards from parsed data
             * @param {Array} metrics - Array of metric objects
             * @param {string} containerId - ID of the container to populate
             */
            function createMetricCards(metrics, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = metrics
                    .map((metric) => {
                        const statusText =
                            metric.status === 'high'
                                ? 'Високо натоварен'
                                : metric.status === 'medium'
                                  ? 'Умерено натоварен'
                                  : 'Нормално състояние';
                        const statusIcon =
                            metric.status === 'high'
                                ? '🔴'
                                : metric.status === 'medium'
                                  ? '🟡'
                                  : '🟢';

                        return `
                        <div class="metric-card">
                            <div class="metric-card-header">
                                <div class="metric-label">
                                    <span>${metric.icon}</span>
                                    <span>${metric.name}</span>
                                </div>
                                <div class="metric-value">${metric.value}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${metric.status}" style="width: ${metric.value}%"></div>
                            </div>
                            <div class="metric-status">
                                <span>${statusIcon}</span>
                                <span>${statusText}</span>
                            </div>
                        </div>
                    `;
                    })
                    .join('');
            }

            function createPrioritySystemsSection(title, content) {
                const chartId = 'systemsChart_' + Date.now();
                const mobileContainerId = 'mobileSystems_' + Date.now();
                const textContentHTML = formatTextContent(content);

                const contentWithChart = `
                <div class="chart-container medium">
                    <div class="chart-title">Баланс на системите за подкрепа</div>
                    <canvas id="${chartId}"></canvas>
                </div>
                <div class="metrics-list-container" id="${mobileContainerId}">
                    <!-- Mobile metric cards will be inserted here -->
                </div>
                ${textContentHTML}
            `;

                const section = createCollapsibleSection(title, contentWithChart, false);

                // Create chart and mobile cards after section is added to DOM
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const canvas = document.getElementById(chartId);
                        if (canvas) createSystemBalanceChart(content, chartId);

                        // Create mobile metric cards
                        const metrics = parseChartData(content, 'systems');
                        createMetricCards(metrics, mobileContainerId);
                    });
                });

                return section;
            }

            function createChannelsSection(title, content) {
                const textContentHTML = formatTextContent(content);
                const channels = ['черва', 'бъбреци', 'лимфа', 'кожа', 'бели дробове'];
                const chartId = 'channelsChart_' + Date.now();
                const mobileContainerId = 'mobileChannels_' + Date.now();

                let barsHTML = `
                <h4 style="margin-top: 1.5rem;">Визуална оценка на натовареността:</h4>
                <div class="chart-container medium">
                    <canvas id="${chartId}"></canvas>
                </div>
                <div class="metrics-list-container" id="${mobileContainerId}">
                    <!-- Mobile metric cards will be inserted here -->
                </div>
            `;

                const finalContentHTML = textContentHTML + barsHTML;
                const section = createCollapsibleSection(title, finalContentHTML, false);

                // Create chart and mobile cards after section is added to DOM
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const canvas = document.getElementById(chartId);
                        if (canvas) createChannelComparisonChart(content, chartId);

                        // Create mobile metric cards
                        const metrics = parseChartData(content, 'channels');
                        createMetricCards(metrics, mobileContainerId);
                    });
                });

                return section;
            }

            // --- CHART CREATION FUNCTIONS ---

            function createSystemBalanceChart(systemsData, containerId) {
                const ctx = document.getElementById(containerId);
                if (!ctx) {
                    console.error('Canvas element not found:', containerId);
                    return;
                }

                // Priority calculation constants
                const PRIORITY_MULTIPLIER = 25;
                const PRIORITY_BASE = 35;
                const PRIORITY_MAX_BASE = 85;
                const PRIORITY_MIN = 20;
                const PRIORITY_MAX = 100;
                const CONTEXT_WINDOW_SIZE = 50;
                const SEVERITY_BONUS_HIGH = 15;
                const SEVERITY_BONUS_MEDIUM = 8;
                const SEVERITY_PENALTY_MILD = -10;
                const FALLBACK_PRIORITY = 50;

                const systems = [];
                const values = [];
                const colors = [];
                const backgroundColors = [];

                // Parse systems and their priorities with improved detection
                const text =
                    typeof systemsData === 'string' ? systemsData : JSON.stringify(systemsData);
                const lowerText = text.toLowerCase();

                // Enhanced system definitions with better colors and more keywords
                const systemKeywords = [
                    {
                        name: 'Храносмилателна',
                        color: '#f59e0b',
                        gradient: 'rgba(245, 158, 11, 0.75)',
                        keywords: [
                            'храносмилат',
                            'черва',
                            'стомах',
                            'храносмилане',
                            'храносмилателн',
                            'гастро',
                            'чревн'
                        ]
                    },
                    {
                        name: 'Нервна',
                        color: '#8b5cf6',
                        gradient: 'rgba(139, 92, 246, 0.75)',
                        keywords: [
                            'нервн',
                            'стрес',
                            'мозък',
                            'невро',
                            'психик',
                            'емоционалн',
                            'тревож'
                        ]
                    },
                    {
                        name: 'Лимфна',
                        color: '#10b981',
                        gradient: 'rgba(16, 185, 129, 0.75)',
                        keywords: ['лимфа', 'лимфатичн', 'имун', 'имунн', 'отбранителн']
                    },
                    {
                        name: 'Сърдечно-съдова',
                        color: '#ef4444',
                        gradient: 'rgba(239, 68, 68, 0.75)',
                        keywords: [
                            'сърдечн',
                            'кръв',
                            'съдов',
                            'кръвоносн',
                            'сърце',
                            'артери',
                            'кардио'
                        ]
                    },
                    {
                        name: 'Дихателна',
                        color: '#06b6d4',
                        gradient: 'rgba(6, 182, 212, 0.75)',
                        keywords: ['дихат', 'белодробн', 'бели дробове', 'респиратор', 'дишан']
                    },
                    {
                        name: 'Елиминативна',
                        color: '#84cc16',
                        gradient: 'rgba(132, 204, 22, 0.75)',
                        keywords: [
                            'детокс',
                            'бъбрек',
                            'елиминат',
                            'изхвърлян',
                            'пречистван',
                            'урин',
                            'отпадн'
                        ]
                    },
                    {
                        name: 'Хормонална',
                        color: '#ec4899',
                        gradient: 'rgba(236, 72, 153, 0.75)',
                        keywords: ['хормон', 'ендокрин', 'щитовидн', 'надбъбречн', 'хипофиз']
                    },
                    {
                        name: 'Метаболична',
                        color: '#f97316',
                        gradient: 'rgba(249, 115, 22, 0.75)',
                        keywords: ['метаболи', 'енерги', 'обмен', 'митохондри']
                    }
                ];

                // Severity indicators for better priority calculation
                const severityIndicators = {
                    high: [
                        'приоритетн',
                        'критичн',
                        'важн',
                        'сериозн',
                        'силно',
                        'значителн',
                        'изразен',
                        'спешн'
                    ],
                    medium: ['умерен', 'средн', 'забележим', 'видим', 'леко'],
                    mild: ['минимален', 'слаб', 'незначителн']
                };

                // Detect systems and calculate priorities
                systemKeywords.forEach((sys) => {
                    const matchCount = sys.keywords.filter((kw) => lowerText.includes(kw)).length;

                    if (matchCount > 0) {
                        systems.push(sys.name);
                        colors.push(sys.color);
                        backgroundColors.push(sys.gradient);

                        // Calculate priority based on keyword frequency and severity indicators
                        let basePriority = Math.min(
                            matchCount * PRIORITY_MULTIPLIER + PRIORITY_BASE,
                            PRIORITY_MAX_BASE
                        );

                        // Check for severity modifiers in proximity to system keywords
                        let severityBonus = 0;
                        sys.keywords.forEach((kw) => {
                            if (lowerText.includes(kw)) {
                                // Check text around the keyword for severity indicators
                                const keywordIndex = lowerText.indexOf(kw);
                                const contextStart = Math.max(
                                    0,
                                    keywordIndex - CONTEXT_WINDOW_SIZE
                                );
                                const contextEnd = Math.min(
                                    lowerText.length,
                                    keywordIndex + CONTEXT_WINDOW_SIZE
                                );
                                const context = lowerText.substring(contextStart, contextEnd);

                                if (severityIndicators.high.some((ind) => context.includes(ind))) {
                                    severityBonus = Math.max(severityBonus, SEVERITY_BONUS_HIGH);
                                } else if (
                                    severityIndicators.medium.some((ind) => context.includes(ind))
                                ) {
                                    severityBonus = Math.max(severityBonus, SEVERITY_BONUS_MEDIUM);
                                } else if (
                                    severityIndicators.mild.some((ind) => context.includes(ind))
                                ) {
                                    severityBonus = Math.max(severityBonus, SEVERITY_PENALTY_MILD);
                                }
                            }
                        });

                        values.push(
                            Math.min(
                                Math.max(basePriority + severityBonus, PRIORITY_MIN),
                                PRIORITY_MAX
                            )
                        );
                    }
                });

                // Fallback: if no systems detected, show all with moderate values
                if (systems.length === 0) {
                    console.warn('No systems detected for chart, using fallback visualization');
                    systemKeywords.slice(0, 6).forEach((sys) => {
                        systems.push(sys.name);
                        values.push(FALLBACK_PRIORITY);
                        colors.push(sys.color);
                        backgroundColors.push(sys.gradient);
                    });
                }

                try {
                    // Ensure canvas has proper dimensions
                    const container = ctx.parentElement;
                    if (container) {
                        ctx.style.maxWidth = '100%';
                        ctx.style.maxHeight = '100%';
                    }

                    new Chart(ctx, {
                        type: 'polarArea',
                        data: {
                            labels: systems,
                            datasets: [
                                {
                                    label: 'Приоритет за подкрепа',
                                    data: values,
                                    backgroundColor: backgroundColors,
                                    borderColor: colors,
                                    borderWidth: 3,
                                    hoverBorderWidth: 5,
                                    hoverBorderColor: '#ffffff',
                                    hoverBackgroundColor: backgroundColors.map((color) =>
                                        color.replace('0.75', '0.9')
                                    )
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 1.4,
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 2500,
                                easing: 'easeInOutCubic',
                                delay: (context) => {
                                    return context.dataIndex * 180;
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                intersect: true
                            },
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 20,
                                        font: {
                                            size: 14,
                                            family: "'Poppins', sans-serif",
                                            weight: '600'
                                        },
                                        backdropColor: 'rgba(255, 255, 255, 0.98)',
                                        backdropPadding: 8,
                                        color: '#334155',
                                        showLabelBackdrop: true,
                                        callback: function (value) {
                                            return value + '%';
                                        }
                                    },
                                    pointLabels: {
                                        font: {
                                            size: 15,
                                            weight: '700',
                                            family: "'Poppins', sans-serif"
                                        },
                                        color: '#1e293b',
                                        padding: 16,
                                        callback: function (label) {
                                            // Wrap long labels for better display
                                            const words = label.split(' ');
                                            if (words.length > 1) {
                                                return words;
                                            }
                                            return label;
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(148, 163, 184, 0.25)',
                                        lineWidth: 2,
                                        circular: true
                                    },
                                    angleLines: {
                                        color: 'rgba(100, 116, 139, 0.25)',
                                        lineWidth: 2
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        font: {
                                            size: 13,
                                            family: "'Poppins', sans-serif",
                                            weight: '600'
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        pointStyleWidth: 16,
                                        color: '#334155',
                                        boxWidth: 12,
                                        boxHeight: 12
                                    }
                                },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: 'rgba(15, 23, 42, 0.96)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#e2e8f0',
                                    titleFont: {
                                        size: 15,
                                        weight: '700',
                                        family: "'Poppins', sans-serif"
                                    },
                                    bodyFont: {
                                        size: 14,
                                        family: "'Poppins', sans-serif",
                                        weight: '500'
                                    },
                                    padding: 16,
                                    borderColor: 'rgba(255, 255, 255, 0.3)',
                                    borderWidth: 2,
                                    displayColors: true,
                                    boxPadding: 6,
                                    callbacks: {
                                        title: function (context) {
                                            return context[0].label;
                                        },
                                        label: function (context) {
                                            const value = context.parsed.r;
                                            let level = 'Нормален';
                                            let icon = '●';
                                            if (value >= 75) {
                                                level = 'Висок приоритет';
                                                icon = '🔴';
                                            } else if (value >= 50) {
                                                level = 'Среден приоритет';
                                                icon = '🟡';
                                            } else if (value >= 30) {
                                                level = 'Нисък приоритет';
                                                icon = '🟢';
                                            }
                                            return [`${icon} Оценка: ${value}%`, `Ниво: ${level}`];
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creating polar area chart:', error);
                    // Try fallback to simple display
                    const errorMsg = document.createElement('p');
                    errorMsg.style.cssText = 'text-align: center; color: #64748b; padding: 2rem;';
                    errorMsg.textContent = 'Диаграмата не може да бъде визуализирана в момента.';
                    ctx.parentElement.appendChild(errorMsg);
                    ctx.style.display = 'none';
                }
            }

            function createChannelComparisonChart(channelsData, containerId) {
                const ctx = document.getElementById(containerId);
                if (!ctx) return;

                const text = typeof channelsData === 'string' ? channelsData.toLowerCase() : '';
                const channels = [
                    { name: 'Черва', keyword: 'черва', icon: '🔄' },
                    { name: 'Бъбреци', keyword: 'бъбрек', icon: '💧' },
                    { name: 'Лимфа', keyword: 'лимфа', icon: '🌊' },
                    { name: 'Кожа', keyword: 'кожа', icon: '✨' },
                    { name: 'Бели дробове', keyword: 'бели дробове', icon: '💨' }
                ];

                const data = channels.map((ch) => {
                    const keyword = ch.keyword.toLowerCase();
                    if (text.includes(keyword)) {
                        if (text.includes('най-натоварен') || text.includes('силно натоварен')) {
                            return 85;
                        } else if (text.includes('умерен') || text.includes('средн')) {
                            return 60;
                        } else {
                            return 40;
                        }
                    }
                    return 20;
                });

                // Create gradient backgrounds for bars
                const gradients = data.map((val, idx) => {
                    const canvas = ctx;
                    const gradient = canvas
                        .getContext('2d')
                        .createLinearGradient(0, 0, canvas.width, 0);
                    if (val >= 70) {
                        gradient.addColorStop(0, 'rgba(239, 68, 68, 0.9)');
                        gradient.addColorStop(1, 'rgba(220, 38, 38, 0.75)');
                    } else if (val >= 50) {
                        gradient.addColorStop(0, 'rgba(251, 191, 36, 0.9)');
                        gradient.addColorStop(1, 'rgba(245, 158, 11, 0.75)');
                    } else {
                        gradient.addColorStop(0, 'rgba(52, 211, 153, 0.9)');
                        gradient.addColorStop(1, 'rgba(16, 185, 129, 0.75)');
                    }
                    return gradient;
                });

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: channels.map((ch) => ch.icon + ' ' + ch.name),
                        datasets: [
                            {
                                label: 'Натовареност',
                                data: data,
                                backgroundColor: data.map((val) =>
                                    val >= 70
                                        ? 'rgba(239, 68, 68, 0.85)'
                                        : val >= 50
                                          ? 'rgba(251, 191, 36, 0.85)'
                                          : 'rgba(52, 211, 153, 0.85)'
                                ),
                                borderColor: data.map((val) =>
                                    val >= 70 ? '#dc2626' : val >= 50 ? '#f59e0b' : '#10b981'
                                ),
                                borderWidth: 3,
                                borderRadius: 10,
                                borderSkipped: false,
                                barThickness: 'flex',
                                maxBarThickness: 50,
                                hoverBackgroundColor: data.map((val) =>
                                    val >= 70
                                        ? 'rgba(239, 68, 68, 0.95)'
                                        : val >= 50
                                          ? 'rgba(251, 191, 36, 0.95)'
                                          : 'rgba(52, 211, 153, 0.95)'
                                ),
                                hoverBorderWidth: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'y',
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutQuart',
                            delay: (context) => {
                                return context.dataIndex * 200;
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.15)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 14,
                                        family: "'Poppins', sans-serif",
                                        weight: '600'
                                    },
                                    color: '#334155',
                                    padding: 10,
                                    callback: function (value) {
                                        return value + '%';
                                    }
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 14,
                                        weight: '700',
                                        family: "'Poppins', sans-serif"
                                    },
                                    color: '#1e293b',
                                    padding: 16,
                                    crossAlign: 'far'
                                },
                                border: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(15, 23, 42, 0.96)',
                                titleColor: '#ffffff',
                                bodyColor: '#e2e8f0',
                                titleFont: {
                                    size: 15,
                                    weight: '700',
                                    family: "'Poppins', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Poppins', sans-serif",
                                    weight: '500'
                                },
                                padding: 16,
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 2,
                                displayColors: false,
                                callbacks: {
                                    title: function (context) {
                                        return context[0].label;
                                    },
                                    label: function (context) {
                                        const value = context.parsed.x;
                                        let status = '';
                                        let icon = '';
                                        if (value >= 70) {
                                            status = 'Високо натоварен';
                                            icon = '🔴';
                                        } else if (value >= 50) {
                                            status = 'Умерено натоварен';
                                            icon = '🟡';
                                        } else {
                                            status = 'Нормално състояние';
                                            icon = '🟢';
                                        }
                                        return [
                                            `${icon} Натовареност: ${value}%`,
                                            `Статус: ${status}`
                                        ];
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 20,
                                top: 10,
                                bottom: 10
                            }
                        }
                    }
                });
            }

            function createHealthMetricsChart(userData, containerId) {
                const ctx = document.getElementById(containerId);
                if (!ctx || !userData) return;

                // Calculate health metrics based on available data
                const metrics = [];
                const values = [];
                const colors = [];

                // Stress level
                if (userData.stress) {
                    metrics.push('Управление на стреса');
                    values.push(Math.max(0, 100 - userData.stress * 10));
                    colors.push('#8b5cf6');
                }

                // Sleep quality (if available)
                if (userData['sleep-hours']) {
                    const sleepScore = Math.min(100, (userData['sleep-hours'] / 8) * 100);
                    metrics.push('Качество на съня');
                    values.push(sleepScore);
                    colors.push('#06b6d4');
                }

                // BMI status (if available)
                if (userData.bmi) {
                    const bmi = parseFloat(userData.bmi);
                    let bmiScore = 100;
                    if (bmi < 18.5 || bmi > 30) bmiScore = 50;
                    else if (bmi < 20 || bmi > 27) bmiScore = 75;
                    metrics.push('BMI статус');
                    values.push(bmiScore);
                    colors.push('#10b981');
                }

                if (metrics.length === 0) return;

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: metrics,
                        datasets: [
                            {
                                data: values,
                                backgroundColor: colors.map((c) => c + 'CC'),
                                borderColor: colors,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return (
                                            context.label + ': ' + Math.round(context.parsed) + '%'
                                        );
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- ЛОГИКА ЗА ЗАРЕЖДАНЕ И ПОВТОРЕН АНАЛИЗ ---
            document.addEventListener('DOMContentLoaded', function () {
                const reportContainer = document.getElementById('report-container');
                const messageBox = document.getElementById('message-box');
                const reAnalyzeBtn = document.getElementById('re-analyze-btn');

                reportContainer.innerHTML = `<div class="loading-box" style="text-align:center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top:1rem;">Генериране на Вашия доклад...</p></div>`;

                setTimeout(() => {
                    try {
                        const rawData = localStorage.getItem('iridologyReport');
                        if (!rawData)
                            throw new Error(
                                'Няма налични данни за анализ. Моля, върнете се на началната страница.'
                            );

                        const data = JSON.parse(rawData);
                        renderReport(data);
                    } catch (err) {
                        reportContainer.style.display = 'none';
                        if (!messageBox.hasChildNodes()) {
                            // Показваме грешка само ако вече няма съобщение
                            messageBox.textContent = err.message;
                            messageBox.className = 'error-box';
                        }
                    }
                }, 500);

                if (reAnalyzeBtn) {
                    reAnalyzeBtn.addEventListener('click', async () => {
                        reAnalyzeBtn.disabled = true;
                        reAnalyzeBtn.innerHTML =
                            '<i class="fas fa-spinner fa-spin"></i> Повтаряне...';

                        const messageContainer = document.querySelector('.button-group-report'); // Показваме съобщението над бутоните
                        messageBox.textContent = 'Подготвяме повторен анализ...';
                        messageBox.className = 'info-box';
                        messageContainer.insertAdjacentElement('beforebegin', messageBox);

                        const stored = localStorage.getItem('iridologyFormData');
                        if (!stored) {
                            messageBox.textContent =
                                'Липсват данни за повторен анализ. Моля, започнете отначало.';
                            messageBox.className = 'error-box';
                            reAnalyzeBtn.disabled = false;
                            reAnalyzeBtn.innerHTML = 'Повтори анализа';
                            return;
                        }

                        const formData = new FormData();
                        const obj = JSON.parse(stored);
                        for (const [key, value] of Object.entries(obj)) {
                            if (typeof value === 'string' && value.startsWith('data:')) {
                                const res = await fetch(value);
                                const blob = await res.blob();
                                formData.append(key, blob, `${key}.png`);
                            } else {
                                formData.append(key, value);
                            }
                        }

                        try {
                            messageBox.textContent = 'Изпращаме данните към AI...';
                            const response = await fetch(WORKER_URL, {
                                method: 'POST',
                                body: formData
                            });
                            if (!response.ok) {
                                const errData = await response.json().catch(() => ({
                                    error: `Грешка от сървъра: ${response.status}`
                                }));
                                throw new Error(errData.error);
                            }
                            const data = await response.json();
                            localStorage.setItem('iridologyReport', JSON.stringify(data));
                            messageBox.textContent = 'Успех! Презареждаме доклада...';
                            messageBox.className = 'success-box';
                            setTimeout(() => location.reload(), 1000);
                        } catch (err) {
                            messageBox.textContent = 'Грешка: ' + err.message;
                            messageBox.className = 'error-box';
                            reAnalyzeBtn.disabled = false;
                            reAnalyzeBtn.innerHTML = 'Повтори анализа';
                        }
                    });
                }

                // PDF Print functionality
                const printBtn = document.getElementById('print-btn');
                if (printBtn) {
                    printBtn.addEventListener('click', () => {
                        // Отваряме всички секции преди принтиране за пълен доклад
                        const allDetails = document.querySelectorAll('details.report-section');
                        allDetails.forEach((detail) => detail.setAttribute('open', ''));

                        // Използваме requestAnimationFrame за да сме сигурни че съдържанието е рендерирано
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                window.print();
                            });
                        });
                    });
                }
            });
        </script>
    </body>
</html>
